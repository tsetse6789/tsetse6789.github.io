<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Playlist Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .playlist-item {
            transition: all 0.2s ease;
        }

        .playlist-item:hover {
            transform: translateX(4px);
        }

        .playlist-item.active {
            background: rgba(93, 92, 222, 0.1);
            border-left: 3px solid #5D5CDE;
        }

        .ad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            border-radius: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .ad-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #5D5CDE;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">YouTube Player</h1>
            <p class="text-gray-600 dark:text-gray-400">Search, Play, Reduced Ads</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Content Area -->
            <div class="flex-1">
                <!-- Video Player Section -->
                <div id="videoContainer" class="hidden fade-in mb-6">
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold mb-1" id="videoTitle">Now Playing:</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400" id="videoChannel"></p>
                            </div>
                            <button 
                                onclick="clearVideo()" 
                                class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm"
                            >
                                ‚úï
                            </button>
                        </div>
                        
                        <!-- Playback Controls -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button 
                                onclick="toggleShuffle()" 
                                id="shuffleBtn"
                                class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm flex items-center gap-2"
                            >
                                üîÄ Shuffle: <span id="shuffleStatus">Off</span>
                            </button>
                            <button 
                                onclick="toggleRepeat()" 
                                id="repeatBtn"
                                class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm flex items-center gap-2"
                            >
                                üîÅ Repeat: <span id="repeatStatus">Off</span>
                            </button>
                            <button 
                                onclick="playPrevious()" 
                                class="px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                            >
                                ‚èÆÔ∏è Previous
                            </button>
                            <button 
                                onclick="playNext()" 
                                class="px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                            >
                                Next ‚è≠Ô∏è
                            </button>
                        </div>

                        <div class="relative w-full" style="padding-bottom: 56.25%; /* 16:9 aspect ratio */">
                            <div id="videoPlayer" class="absolute top-0 left-0 w-full h-full rounded-lg"></div>
                            <!-- Ad Overlay -->
                            <div id="adOverlay" class="ad-overlay hidden">
                                <div class="spinner"></div>
                                <div class="text-white text-lg font-medium mt-4">Please Wait...</div>
                                <div class="text-white text-sm opacity-75 mt-2">Loading video content</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- YouTube Search Section -->
                <div id="searchSection" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-4">Search Videos on YouTube:</h3>
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search for videos..."
                            class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        >
                        <button 
                            onclick="searchVideos()" 
                            id="searchButton"
                            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                        >
                            üîç Search
                        </button>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-8 hidden">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-primary rounded-full" role="status"></div>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">Searching videos...</p>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    
                    <!-- No Results -->
                    <div id="noResults" class="text-center py-8 hidden">
                        <p class="text-gray-600 dark:text-gray-400">No videos found. Try a different search term.</p>
                    </div>
                </div>
            </div>

            <!-- Playlist Sidebar -->
            <div class="lg:w-80">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Playlists</h3>
                        <button 
                            onclick="showCreatePlaylistForm()" 
                            class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                        >
                            ‚ûï New
                        </button>
                    </div>

                    <!-- Create Playlist Form -->
                    <div id="createPlaylistForm" class="hidden mb-4 p-4 bg-white dark:bg-gray-700 rounded-lg border">
                        <input 
                            type="text" 
                            id="playlistNameInput" 
                            placeholder="Playlist name..."
                            class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded mb-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                        >
                        <div class="flex gap-2">
                            <button 
                                onclick="createPlaylist()" 
                                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
                            >
                                Create
                            </button>
                            <button 
                                onclick="hideCreatePlaylistForm()" 
                                class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Playlists List -->
                    <div id="playlistsList" class="space-y-2">
                        <p class="text-gray-600 dark:text-gray-400 text-sm">No playlists yet. Create one to get started!</p>
                    </div>

                    <!-- Current Playlist -->
                    <div id="currentPlaylistSection" class="hidden mt-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold" id="currentPlaylistTitle">Current Playlist</h4>
                            <button 
                                onclick="clearCurrentPlaylist()" 
                                class="text-gray-500 hover:text-red-500 transition-colors"
                            >
                                ‚úï
                            </button>
                        </div>
                        <div id="currentPlaylistVideos" class="space-y-2 max-h-96 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // YouTube Player API variables
        let player;
        let playerReady = false;
        let isAdPlaying = false;
        let playerMutedForAd = false;

        // YouTube Player API callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API ready');
            playerReady = true;
        }

        // Player state change event handler
        function onPlayerStateChange(event) {
            // YT.PlayerState.ENDED = 0
            if (event.data === YT.PlayerState.ENDED) {
                handleVideoEnd();
            }
            
            // Check for ads using getCurrentTime method
            // If getCurrentTime returns -1, it usually means an ad is playing
            checkForAds();
        }

        // Ad state change event handler
        function onAdStateChange(event) {
            // event.data: 1 = Ad Started, 2 = Ad Ended, others = other ad states
            if (event.data === 1) {
                // Ad started
                showAdOverlay();
            } else if (event.data === 2) {
                // Ad ended
                hideAdOverlay();
            }
        }

        // Enhanced ad detection and blocking
        function checkForAds() {
            if (!player) return;
            
            try {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                const state = player.getPlayerState();
                
                let adDetected = false;
                
                // Method 1: Check for invalid/missing time data (common during ads)
                if (currentTime === -1 || currentTime === 0 && state === YT.PlayerState.PLAYING) {
                    adDetected = true;
                }
                
                // Method 2: Check for missing duration (ads often don't have proper duration)
                if (!duration || duration === 0) {
                    adDetected = true;
                }
                
                // Method 3: Check video URL for ad indicators
                try {
                    const videoUrl = player.getVideoUrl && player.getVideoUrl();
                    if (videoUrl && (videoUrl.includes('googleads') || videoUrl.includes('doubleclick') || videoUrl.includes('/ads/'))) {
                        adDetected = true;
                    }
                } catch (e) {
                    // URL check failed, might be an ad
                }
                
                // Method 4: Check for limited quality options (ads typically have fewer)
                try {
                    const qualities = player.getAvailableQualityLevels && player.getAvailableQualityLevels();
                    if (qualities && qualities.length <= 2 && currentTime <= 5) {
                        adDetected = true;
                    }
                } catch (e) {
                    // Quality check failed
                }
                
                // Method 5: Check player state inconsistencies
                if (state === YT.PlayerState.BUFFERING && currentTime <= 0) {
                    adDetected = true;
                }
                
                // Video is properly playing
                const videoIsPlaying = currentTime > 0 && duration > 0 && currentTime <= duration && 
                                     !adDetected && (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED);
                
                if (adDetected && !isAdPlaying) {
                    console.log('Ad detected - hiding ads');
                    showAdOverlay();
                    // Try to skip ad automatically
                    trySkipAd();
                } else if (videoIsPlaying && isAdPlaying) {
                    console.log('Video content detected - showing video');
                    hideAdOverlay();
                }
                
            } catch (error) {
                console.log('Error in ad detection:', error);
                // On error, assume there might be an ad to be safe
                if (!isAdPlaying && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.UNSTARTED) {
                    showAdOverlay();
                }
            }
        }
        
        // Attempt to skip ads automatically
        function trySkipAd() {
            if (!player) return;
            
            try {
                // Try to find and click skip button
                setTimeout(() => {
                    const skipButton = document.querySelector('.ytp-ad-skip-button, .ytp-skip-ad-button');
                    if (skipButton && skipButton.offsetParent !== null) {
                        console.log('Clicking skip button');
                        skipButton.click();
                    }
                }, 1000);
                
                // Try seeking to end of video if it's a short ad
                setTimeout(() => {
                    if (player.getDuration && player.seekTo) {
                        const duration = player.getDuration();
                        if (duration > 0 && duration < 30) { // Short ad
                            console.log('Seeking to end of short ad');
                            player.seekTo(duration - 1);
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.log('Error trying to skip ad:', error);
            }
        }

        // Show ad overlay and mute player
        function showAdOverlay() {
            isAdPlaying = true;
            const overlay = document.getElementById('adOverlay');
            overlay.classList.remove('hidden');
            
            // Mute the player during ads
            if (player && player.isMuted && player.mute) {
                if (!player.isMuted()) {
                    player.mute();
                    playerMutedForAd = true;
                }
            }
        }

        // Hide ad overlay and restore sound
        function hideAdOverlay() {
            isAdPlaying = false;
            const overlay = document.getElementById('adOverlay');
            overlay.classList.add('hidden');
            
            // Restore sound if we muted it for ads
            if (player && player.unMute && playerMutedForAd) {
                player.unMute();
                playerMutedForAd = false;
            }
        }

        // Handle video end - auto advance to next video
        function handleVideoEnd() {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (videos.length === 0) return;
            
            // Handle repeat one mode
            if (playbackSettings.repeat === 'one') {
                // Replay the same video
                if (player && player.playVideo) {
                    player.playVideo();
                }
                return;
            }
            
            // Handle repeat all mode or normal playback
            let nextIndex;
            
            if (playbackSettings.shuffle) {
                // Shuffle mode: pick random video
                nextIndex = Math.floor(Math.random() * videos.length);
            } else {
                // Normal mode: next video in sequence
                nextIndex = currentVideoIndex + 1;
                
                // If at end of playlist
                if (nextIndex >= videos.length) {
                    if (playbackSettings.repeat === 'all') {
                        nextIndex = 0; // Loop back to start
                    } else {
                        return; // Stop playing
                    }
                }
            }
            
            // Auto-play next video
            playVideoFromPlaylist(nextIndex);
        }

        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let apiKey = 'AIzaSyCQExuj8PVT14tgxr9jUB7qGsG364P_u48';
        let playlists = {};
        let currentPlaylist = null;
        let currentVideoIndex = 0;
        let playbackSettings = {
            shuffle: false,
            repeat: 'off' // 'off', 'all', 'one'
        };

        // Cookie utilities
        function setCookie(name, value, days = 30) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) {
                    try {
                        return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)));
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updatePlaybackUI();
        });

        // Load settings from cookies
        function loadSettings() {
            const savedPlaylists = getCookie('ytplayer_playlists');
            const savedPlaybackSettings = getCookie('ytplayer_playback');
            const savedApiKey = getCookie('ytplayer_apikey');

            if (savedPlaylists) {
                playlists = savedPlaylists;
                renderPlaylists();
            }

            if (savedPlaybackSettings) {
                playbackSettings = savedPlaybackSettings;
            }

            if (savedApiKey) {
                apiKey = savedApiKey;
            }
        }

        // Save settings to cookies
        function saveSettings() {
            setCookie('ytplayer_playlists', playlists);
            setCookie('ytplayer_playback', playbackSettings);
            setCookie('ytplayer_apikey', apiKey);
        }



        // Video search functionality
        async function searchVideos() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a search term');
                return;
            }
            
            if (!apiKey) {
                alert('Please set up your API key first');
                return;
            }
            
            showLoading();
            
            try {
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&q=${encodeURIComponent(query)}&type=video&key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error (${response.status})`);
                }
                
                const data = await response.json();
                displaySearchResults(data.items);
                
            } catch (error) {
                console.error('Search error:', error);
                hideLoading();
                alert(`Search failed: ${error.message}`);
            }
        }

        function displaySearchResults(videos) {
            hideLoading();
            const resultsContainer = document.getElementById('searchResults');
            const noResultsDiv = document.getElementById('noResults');
            
            if (!videos || videos.length === 0) {
                resultsContainer.innerHTML = '';
                noResultsDiv.classList.remove('hidden');
                return;
            }
            
            noResultsDiv.classList.add('hidden');
            
            resultsContainer.innerHTML = videos.map(video => `
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md overflow-hidden">
                    <div class="relative">
                        <img src="${video.snippet.thumbnails.medium.url}" alt="${video.snippet.title}" class="w-full h-32 object-cover">
                    </div>
                    <div class="p-3">
                        <h4 class="font-semibold text-sm line-clamp-2 mb-2" title="${video.snippet.title}">
                            ${video.snippet.title}
                        </h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                            ${video.snippet.channelTitle}
                        </p>
                        <div class="flex gap-2">
                            <button 
                                onclick="playVideo('${video.id.videoId}', '${escapeHtml(video.snippet.title)}', '${escapeHtml(video.snippet.channelTitle)}')" 
                                class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-xs"
                            >
                                ‚ñ∂Ô∏è Play
                            </button>
                            <button 
                                onclick="showAddToPlaylistMenu('${video.id.videoId}', '${escapeHtml(video.snippet.title)}', '${escapeHtml(video.snippet.channelTitle)}', '${video.snippet.thumbnails.default.url}', this)" 
                                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                            >
                                ‚ûï Add
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            return text.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('noResults').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Playlist management
        function showCreatePlaylistForm() {
            document.getElementById('createPlaylistForm').classList.remove('hidden');
            document.getElementById('playlistNameInput').focus();
        }

        function hideCreatePlaylistForm() {
            document.getElementById('createPlaylistForm').classList.add('hidden');
            document.getElementById('playlistNameInput').value = '';
        }

        function createPlaylist() {
            const nameInput = document.getElementById('playlistNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a playlist name');
                return;
            }
            
            if (playlists[name]) {
                alert('Playlist already exists');
                return;
            }
            
            playlists[name] = {
                name: name,
                videos: [],
                created: new Date().toISOString()
            };
            
            saveSettings();
            renderPlaylists();
            hideCreatePlaylistForm();
        }

        function deletePlaylist(name) {
            if (confirm(`Delete playlist "${name}"?`)) {
                delete playlists[name];
                if (currentPlaylist === name) {
                    clearCurrentPlaylist();
                }
                saveSettings();
                renderPlaylists();
            }
        }

        function renderPlaylists() {
            const container = document.getElementById('playlistsList');
            const playlistNames = Object.keys(playlists);
            
            if (playlistNames.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400 text-sm">No playlists yet. Create one to get started!</p>';
                return;
            }
            
            container.innerHTML = playlistNames.map(name => `
                <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                    <div class="flex-1 cursor-pointer" onclick="loadPlaylist('${name}')">
                        <div class="font-medium">${name}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${playlists[name].videos.length} videos</div>
                    </div>
                    <button 
                        onclick="deletePlaylist('${name}')" 
                        class="text-red-500 hover:text-red-700 transition-colors ml-2"
                    >
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function loadPlaylist(name) {
            currentPlaylist = name;
            currentVideoIndex = 0;
            renderCurrentPlaylist();
        }

        function clearCurrentPlaylist() {
            currentPlaylist = null;
            currentVideoIndex = 0;
            document.getElementById('currentPlaylistSection').classList.add('hidden');
            clearVideo();
        }

        function renderCurrentPlaylist() {
            if (!currentPlaylist) return;
            
            const section = document.getElementById('currentPlaylistSection');
            const title = document.getElementById('currentPlaylistTitle');
            const container = document.getElementById('currentPlaylistVideos');
            
            title.textContent = currentPlaylist;
            section.classList.remove('hidden');
            
            const videos = playlists[currentPlaylist].videos;
            
            if (videos.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400 text-sm">No videos in this playlist yet.</p>';
                return;
            }
            
            container.innerHTML = videos.map((video, index) => `
                <div class="playlist-item flex items-center gap-3 p-2 rounded cursor-pointer ${index === currentVideoIndex ? 'active' : ''}" 
                     onclick="playVideoFromPlaylist(${index})">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-16 h-12 object-cover rounded">
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm line-clamp-2">${video.title}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${video.channel}</div>
                    </div>
                    <button 
                        onclick="removeFromPlaylist(${index}); event.stopPropagation();" 
                        class="text-red-500 hover:text-red-700 transition-colors"
                    >
                        ‚úï
                    </button>
                </div>
            `).join('');
        }

        function showAddToPlaylistMenu(videoId, title, channel, thumbnail, buttonElement) {
            const playlistNames = Object.keys(playlists);
            
            if (playlistNames.length === 0) {
                alert('Create a playlist first!');
                return;
            }
            
            // Remove any existing dropdown
            const existingDropdown = document.querySelector('.playlist-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Create dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'playlist-dropdown fixed bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-xl py-2 min-w-48 max-h-64 overflow-y-auto';
            dropdown.style.zIndex = '9999';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-600';
            header.textContent = 'Add to playlist:';
            dropdown.appendChild(header);
            
            // Add playlist options
            playlistNames.forEach(playlistName => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors';
                option.textContent = `${playlistName} (${playlists[playlistName].videos.length} videos)`;
                option.onclick = () => {
                    addToPlaylist(playlistName, { id: videoId, title, channel, thumbnail });
                    dropdown.remove();
                };
                dropdown.appendChild(option);
            });
            
            // Position dropdown using fixed positioning
            const buttonRect = buttonElement.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // Calculate position
            let top = buttonRect.bottom + 4;
            let left = buttonRect.left;
            
            // Adjust if dropdown would go off-screen
            const dropdownHeight = Math.min(playlistNames.length * 40 + 60, 256); // Estimate height
            const dropdownWidth = 192; // min-w-48 = 192px
            
            // Adjust vertical position if it goes below viewport
            if (top + dropdownHeight > viewportHeight) {
                top = buttonRect.top - dropdownHeight - 4;
            }
            
            // Adjust horizontal position if it goes off right edge
            if (left + dropdownWidth > viewportWidth) {
                left = viewportWidth - dropdownWidth - 10;
            }
            
            // Ensure it doesn't go off left edge
            if (left < 10) {
                left = 10;
            }
            
            dropdown.style.top = top + 'px';
            dropdown.style.left = left + 'px';
            
            // Append to body for better positioning
            document.body.appendChild(dropdown);
            
            // Close dropdown when clicking outside
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target) && e.target !== buttonElement) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            };
            
            // Add event listener after a small delay to prevent immediate closure
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 100);
        }

        function addToPlaylist(playlistName, video) {
            if (!playlists[playlistName]) return;
            
            // Check if video already exists in playlist
            const exists = playlists[playlistName].videos.some(v => v.id === video.id);
            if (exists) {
                alert('Video already in playlist!');
                return;
            }
            
            playlists[playlistName].videos.push(video);
            saveSettings();
            
            if (currentPlaylist === playlistName) {
                renderCurrentPlaylist();
            }
            
            renderPlaylists();
        }

        function removeFromPlaylist(index) {
            if (!currentPlaylist) return;
            
            playlists[currentPlaylist].videos.splice(index, 1);
            
            // Adjust current video index if needed
            if (currentVideoIndex >= index && currentVideoIndex > 0) {
                currentVideoIndex--;
            }
            
            saveSettings();
            renderCurrentPlaylist();
            renderPlaylists();
        }

        // Video playback
        function playVideo(videoId, title, channel) {
            const videoContainer = document.getElementById('videoContainer');
            const videoTitle = document.getElementById('videoTitle');
            const videoChannel = document.getElementById('videoChannel');
            
            videoTitle.textContent = title;
            videoChannel.textContent = channel;
            videoContainer.classList.remove('hidden');
            
            // Initialize or update YouTube player
            if (!player) {
                // Wait for API to be ready
                if (!playerReady || !window.YT) {
                    setTimeout(() => playVideo(videoId, title, channel), 100);
                    return;
                }
                
                // Create new player
                player = new YT.Player('videoPlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        autoplay: 1,
                        rel: 0,          // Reduce related videos
                        showinfo: 0,     // Hide video info
                        modestbranding: 1, // Reduce YouTube branding
                        iv_load_policy: 3, // Hide video annotations
                        cc_load_policy: 0, // Hide closed captions by default
                        fs: 1,           // Allow fullscreen
                        disablekb: 0     // Enable keyboard controls
                    },
                    events: {
                        onStateChange: onPlayerStateChange,
                        onAdStateChange: onAdStateChange
                    }
                });
                
                // Start periodic ad checking
                setInterval(checkForAds, 1000); // Check every second
            } else {
                // Update existing player
                player.loadVideoById(videoId);
            }
            
            videoContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function playVideoFromPlaylist(index) {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (index < 0 || index >= videos.length) return;
            
            currentVideoIndex = index;
            const video = videos[index];
            
            playVideo(video.id, video.title, video.channel);
            renderCurrentPlaylist(); // Update active indicator
        }

        function clearVideo() {
            const videoContainer = document.getElementById('videoContainer');
            
            // Destroy YouTube player if it exists
            if (player && player.destroy) {
                player.destroy();
                player = null;
            }
            
            videoContainer.classList.add('hidden');
        }

        // Playback controls
        function toggleShuffle() {
            playbackSettings.shuffle = !playbackSettings.shuffle;
            saveSettings();
            updatePlaybackUI();
        }

        function toggleRepeat() {
            const modes = ['off', 'all', 'one'];
            const currentIndex = modes.indexOf(playbackSettings.repeat);
            playbackSettings.repeat = modes[(currentIndex + 1) % modes.length];
            saveSettings();
            updatePlaybackUI();
        }

        function updatePlaybackUI() {
            document.getElementById('shuffleStatus').textContent = playbackSettings.shuffle ? 'On' : 'Off';
            document.getElementById('shuffleBtn').classList.toggle('bg-primary', playbackSettings.shuffle);
            document.getElementById('shuffleBtn').classList.toggle('bg-gray-600', !playbackSettings.shuffle);
            
            const repeatText = playbackSettings.repeat === 'off' ? 'Off' : 
                              playbackSettings.repeat === 'all' ? 'All' : 'One';
            document.getElementById('repeatStatus').textContent = repeatText;
            document.getElementById('repeatBtn').classList.toggle('bg-primary', playbackSettings.repeat !== 'off');
            document.getElementById('repeatBtn').classList.toggle('bg-gray-600', playbackSettings.repeat === 'off');
        }

        function playNext() {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (videos.length === 0) return;
            
            let nextIndex;
            
            if (playbackSettings.shuffle) {
                nextIndex = Math.floor(Math.random() * videos.length);
            } else {
                nextIndex = (currentVideoIndex + 1) % videos.length;
            }
            
            playVideoFromPlaylist(nextIndex);
        }

        function playPrevious() {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (videos.length === 0) return;
            
            let prevIndex;
            
            if (playbackSettings.shuffle) {
                prevIndex = Math.floor(Math.random() * videos.length);
            } else {
                prevIndex = currentVideoIndex === 0 ? videos.length - 1 : currentVideoIndex - 1;
            }
            
            playVideoFromPlaylist(prevIndex);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                searchVideos();
            }
        });

        document.getElementById('playlistNameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                createPlaylist();
            }
        });

        // Format date helper
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 30) return `${diffDays} days ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return `${Math.floor(diffDays / 365)} years ago`;
        }
    </script>
</body>
</html>
