<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .playlist-item {
            transition: all 0.2s ease;
        }

        .playlist-item:hover {
            transform: translateX(4px);
        }

        .playlist-item.active {
            background: rgba(93, 92, 222, 0.1);
            border-left: 3px solid #5D5CDE;
        }

        .ad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            border-radius: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .ad-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #5D5CDE;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Video Details Drawer Styles */
        .video-details-drawer {
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .dark .video-details-drawer {
            background: rgba(55, 65, 81, 0.95);
        }

        .drawer-header {
            padding: 1rem;
            background: rgba(249, 250, 251, 0.8);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
            backdrop-filter: blur(10px);
        }

        .dark .drawer-header {
            background: rgba(31, 41, 55, 0.8);
            border-bottom: 1px solid rgba(75, 85, 99, 0.5);
        }

        .drawer-handle {
            width: 2rem;
            height: 0.25rem;
            background: rgba(156, 163, 175, 0.6);
            border-radius: 9999px;
            transition: background-color 0.2s;
        }

        .drawer-header:hover .drawer-handle {
            background: rgba(107, 114, 128, 0.8);
        }

        .drawer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .video-details-drawer.open .drawer-content {
            max-height: 600px;
            overflow-y: auto;
        }

        .video-details-drawer.open .drawer-toggle-icon svg {
            transform: rotate(180deg);
        }

        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .stat-item {
            transition: transform 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
        }

        .description-content.expanded .line-clamp-4 {
            -webkit-line-clamp: unset;
            display: block;
        }

        /* Playlist Action Buttons */
        .playlist-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .playlist-action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .playlist-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-rename {
            background: #3b82f6;
        }

        .btn-rename:hover {
            background: #2563eb;
        }

        .btn-duplicate {
            background: #10b981;
        }

        .btn-duplicate:hover {
            background: #059669;
        }

        .btn-merge {
            background: #f59e0b;
        }

        .btn-merge:hover {
            background: #d97706;
        }

        .btn-info {
            background: #6b7280;
        }

        .btn-info:hover {
            background: #4b5563;
        }

        /* Drag and Drop Styles */
        .playlist-video-item {
            transition: all 0.2s ease;
            cursor: grab;
            /* Disable text selection for touch devices */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Disable touch callouts on iOS */
            -webkit-touch-callout: none;
            /* Disable text selection highlighting */
            -webkit-tap-highlight-color: transparent;
        }

        .playlist-video-item:active {
            cursor: grabbing;
        }

        .playlist-video-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .playlist-video-item.drag-over {
            border-top: 3px solid #5D5CDE;
            margin-top: 6px;
        }

        /* Touch feedback for mobile */
        .playlist-video-item.touch-active {
            background-color: rgba(93, 92, 222, 0.2);
            transform: scale(0.98);
        }

        /* Prevent text selection on playlist items */
        .playlist-item * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Selection Mode Styles */
        .selection-mode .playlist-video-item {
            cursor: default;
        }

        .video-checkbox {
            margin-right: 0.75rem;
        }

        .selection-controls {
            padding: 1rem;
            background: #f3f4f6;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 2px dashed #9ca3af;
        }

        .dark .selection-controls {
            background: #4b5563;
            border-color: #6b7280;
        }

        /* Rename Form Styles */
        .rename-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            min-width: 300px;
        }

        .dark .rename-form {
            background: #374151;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-primary mb-2">YouTube Player</h1>
            <p class="text-gray-600 dark:text-gray-400">Powered by Nut</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Content Area -->
            <div class="flex-1">
                <!-- Video Player Section -->
                <div id="videoContainer" class="hidden fade-in mb-6">
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold mb-1" id="videoTitle">Now Playing:</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400" id="videoChannel"></p>
                            </div>
                            <button 
                                onclick="clearVideo()" 
                                class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm"
                            >
                                ‚úï
                            </button>
                        </div>
                        
                        <!-- Playback Controls -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button 
                                onclick="toggleShuffle()" 
                                id="shuffleBtn"
                                class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm flex items-center gap-2"
                            >
                                üîÄ Shuffle: <span id="shuffleStatus">Off</span>
                            </button>
                            <button 
                                onclick="toggleRepeat()" 
                                id="repeatBtn"
                                class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm flex items-center gap-2"
                            >
                                üîÅ Repeat: <span id="repeatStatus">Off</span>
                            </button>
                            <button 
                                onclick="playPrevious()" 
                                class="px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                            >
                                ‚èÆÔ∏è Previous
                            </button>
                            <button 
                                onclick="playNext()" 
                                class="px-3 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                            >
                                Next ‚è≠Ô∏è
                            </button>
                        </div>

                        <div class="relative w-full" style="padding-bottom: 56.25%; /* 16:9 aspect ratio */">
                            <div id="videoPlayer" class="absolute top-0 left-0 w-full h-full rounded-lg"></div>
                            <!-- Ad Overlay -->
                            <div id="adOverlay" class="ad-overlay hidden">
                                <div class="spinner"></div>
                                <div class="text-white text-lg font-medium mt-4">Please Wait...</div>
                                <div class="text-white text-sm opacity-75 mt-2">Loading video content</div>
                            </div>
                        </div>

                        <!-- Video Details Drawer -->
                        <div id="videoDetailsDrawer" class="video-details-drawer">
                            <!-- Drawer Header -->
                            <div class="drawer-header" onclick="toggleVideoDetails()">
                                <div class="flex items-center justify-between w-full cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="drawer-handle"></div>
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Video Details</span>
                                    </div>
                                    <div class="drawer-toggle-icon">
                                        <svg class="w-5 h-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Drawer Content -->
                            <div class="drawer-content">
                                <!-- Loading State -->
                                <div id="videoDetailsLoading" class="hidden p-4 text-center">
                                    <div class="animate-spin inline-block w-6 h-6 border-2 border-current border-t-transparent text-primary rounded-full"></div>
                                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Loading video details...</p>
                                </div>

                                <!-- Video Statistics -->
                                <div id="videoStats" class="hidden p-4 border-b border-gray-200 dark:border-gray-600">
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                        <div class="stat-item">
                                            <div class="text-lg font-semibold text-primary" id="viewCount">-</div>
                                            <div class="text-xs text-gray-600 dark:text-gray-400">Views</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="text-lg font-semibold text-green-600" id="likeCount">-</div>
                                            <div class="text-xs text-gray-600 dark:text-gray-400">Likes</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="text-lg font-semibold text-blue-600" id="commentCount">-</div>
                                            <div class="text-xs text-gray-600 dark:text-gray-400">Comments</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="text-lg font-semibold text-gray-600 dark:text-gray-400" id="publishedDate">-</div>
                                            <div class="text-xs text-gray-600 dark:text-gray-400">Published</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Video Description -->
                                <div id="videoDescription" class="hidden p-4">
                                    <h4 class="font-semibold mb-3 text-gray-900 dark:text-white">Description</h4>
                                    <div class="description-content">
                                        <div id="descriptionText" class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap line-clamp-4 mb-3"></div>
                                        <button id="expandDescription" class="text-primary hover:text-opacity-80 text-sm font-medium hidden">
                                            Show more
                                        </button>
                                    </div>
                                </div>

                                <!-- Channel Info -->
                                <div id="channelInfo" class="hidden p-4 border-t border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center gap-3">
                                        <img id="channelThumbnail" src="" alt="Channel" class="w-12 h-12 rounded-full object-cover">
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-900 dark:text-white" id="channelTitle"></div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400" id="subscriberCount"></div>
                                        </div>
                                        <button 
                                            onclick="viewChannelFromDetails()" 
                                            class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                                        >
                                            View Channel
                                        </button>
                                    </div>
                                </div>

                                <!-- Error State -->
                                <div id="videoDetailsError" class="hidden p-4 text-center">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Unable to load video details</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- YouTube Search Section -->
                <div id="searchSection" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <h3 class="text-lg font-semibold mb-4">Search on YouTube:</h3>
                    
                    <!-- Search Type Selector -->
                    <div class="flex gap-2 mb-4">
                        <button 
                            onclick="setSearchType('video')" 
                            id="videoSearchBtn"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                        >
                            üì∫ Videos
                        </button>
                        <button 
                            onclick="setSearchType('channel')" 
                            id="channelSearchBtn"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium"
                        >
                            üë§ Channels
                        </button>
                    </div>
                    
                    <!-- Navigation Breadcrumb -->
                    <div id="navigationBar" class="hidden mb-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <div class="flex items-center gap-2 text-sm">
                            <button 
                                onclick="navigateUp()" 
                                id="upButton"
                                class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                                ‚¨ÜÔ∏è Back
                            </button>
                            <span class="text-gray-600 dark:text-gray-300" id="navigationPath">Search Results</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search for videos..."
                            class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        >
                        <button 
                            onclick="performSearch()" 
                            id="searchButton"
                            class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                        >
                            üîç Search
                        </button>
                        <button 
                            onclick="clearSearchResults()" 
                            id="clearButton"
                            class="px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium"
                        >
                            ‚úï Clear
                        </button>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-8 hidden">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-primary rounded-full" role="status"></div>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">Searching videos...</p>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    
                    <!-- No Results -->
                    <div id="noResults" class="text-center py-8 hidden">
                        <p class="text-gray-600 dark:text-gray-400">No videos found. Try a different search term.</p>
                    </div>
                </div>
            </div>

            <!-- Playlist Sidebar -->
            <div class="lg:w-80">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Playlists</h3>
                        <button 
                            onclick="showCreatePlaylistForm()" 
                            class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-sm"
                        >
                            ‚ûï New
                        </button>
                    </div>

                    <!-- Create Playlist Form -->
                    <div id="createPlaylistForm" class="hidden mb-4 p-4 bg-white dark:bg-gray-700 rounded-lg border">
                        <input 
                            type="text" 
                            id="playlistNameInput" 
                            placeholder="Playlist name..."
                            class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded mb-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                        >
                        <div class="flex gap-2">
                            <button 
                                onclick="createPlaylist()" 
                                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
                            >
                                Create
                            </button>
                            <button 
                                onclick="hideCreatePlaylistForm()" 
                                class="px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Playlists List -->
                    <div id="playlistsList" class="space-y-2">
                        <p class="text-gray-600 dark:text-gray-400 text-sm">No playlists yet. Create one to get started!</p>
                    </div>

                    <!-- Current Playlist -->
                    <div id="currentPlaylistSection" class="hidden mt-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold" id="currentPlaylistTitle">Current Playlist</h4>
                            <div class="flex gap-2">
                                <button 
                                    id="playlistSelectButton"
                                    onclick="toggleSelectionMode()" 
                                    class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                >
                                    Select
                                </button>
                                <button 
                                    onclick="clearCurrentPlaylist()" 
                                    class="text-gray-500 hover:text-red-500 transition-colors"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selection Controls -->
                        <div id="selectionControls" class="selection-controls hidden">
                            <div class="flex flex-wrap gap-2 text-sm">
                                <span class="font-medium text-gray-700 dark:text-gray-300">
                                    Selected: <span id="selectedCount">0</span>
                                </span>
                                <button onclick="selectAllVideos()" class="text-blue-600 hover:text-blue-800">Select All</button>
                                <button onclick="deselectAllVideos()" class="text-blue-600 hover:text-blue-800">Deselect All</button>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <button 
                                    onclick="moveSelectedVideos()" 
                                    class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                >
                                    üìÅ Move to Playlist
                                </button>
                                <button 
                                    onclick="copySelectedVideos()" 
                                    class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                >
                                    üìã Copy to Playlist
                                </button>
                                <button 
                                    onclick="deleteSelectedVideos()" 
                                    class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-xs"
                                >
                                    üóëÔ∏è Delete Selected
                                </button>
                            </div>
                        </div>
                        
                        <div id="currentPlaylistVideos" class="space-y-2 max-h-96 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // YouTube Player API variables
        let player;
        let playerReady = false;
        let isAdPlaying = false;
        let playerMutedForAd = false;
        
        // Background playback variables
        let audioContext;
        let isPageVisible = true;
        let backgroundPlaybackEnabled = true;
        let wakeLock = null;
        let userPausedManually = false;
        let lastKnownPlaybackState = null;

        // YouTube Player API callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API ready');
            playerReady = true;
        }

        // Player state change event handler
        function onPlayerStateChange(event) {
            console.log('Player state changed:', event.data);
            
            // Track manual pause/play actions
            if (event.data === YT.PlayerState.PAUSED) {
                // If user manually paused (not due to browser behavior)
                if (isPageVisible) {
                    userPausedManually = true;
                    console.log('User manually paused');
                } else {
                    console.log('Browser auto-paused (background)');
                }
            } else if (event.data === YT.PlayerState.PLAYING) {
                // Reset manual pause flag when playing
                userPausedManually = false;
                console.log('Video playing');
            }
            
            // Store the current playback state
            lastKnownPlaybackState = event.data;
            
            // Update media session playback state
            updateMediaSessionPlaybackState(event.data);
            
            // YT.PlayerState.ENDED = 0
            if (event.data === YT.PlayerState.ENDED) {
                handleVideoEnd();
            }
            
            // Check for ads using getCurrentTime method
            // If getCurrentTime returns -1, it usually means an ad is playing
            checkForAds();
        }

        // Ad state change event handler
        function onAdStateChange(event) {
            // event.data: 1 = Ad Started, 2 = Ad Ended, others = other ad states
            if (event.data === 1) {
                // Ad started
                showAdOverlay();
            } else if (event.data === 2) {
                // Ad ended
                hideAdOverlay();
            }
        }

        // Enhanced ad detection and blocking
        function checkForAds() {
            if (!player) return;
            
            try {
                const currentTime = player.getCurrentTime();
                const duration = player.getDuration();
                const state = player.getPlayerState();
                
                let adDetected = false;
                
                // Method 1: Check for invalid/missing time data (common during ads)
                if (currentTime === -1 || currentTime === 0 && state === YT.PlayerState.PLAYING) {
                    adDetected = true;
                }
                
                // Method 2: Check for missing duration (ads often don't have proper duration)
                if (!duration || duration === 0) {
                    adDetected = true;
                }
                
                // Method 3: Check video URL for ad indicators
                try {
                    const videoUrl = player.getVideoUrl && player.getVideoUrl();
                    if (videoUrl && (videoUrl.includes('googleads') || videoUrl.includes('doubleclick') || videoUrl.includes('/ads/'))) {
                        adDetected = true;
                    }
                } catch (e) {
                    // URL check failed, might be an ad
                }
                
                // Method 4: Check for limited quality options (ads typically have fewer)
                try {
                    const qualities = player.getAvailableQualityLevels && player.getAvailableQualityLevels();
                    if (qualities && qualities.length <= 2 && currentTime <= 5) {
                        adDetected = true;
                    }
                } catch (e) {
                    // Quality check failed
                }
                
                // Method 5: Check player state inconsistencies
                if (state === YT.PlayerState.BUFFERING && currentTime <= 0) {
                    adDetected = true;
                }
                
                // Video is properly playing
                const videoIsPlaying = currentTime > 0 && duration > 0 && currentTime <= duration && 
                                     !adDetected && (state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED);
                
                if (adDetected && !isAdPlaying) {
                    console.log('Ad detected - hiding ads');
                    showAdOverlay();
                    // Try to skip ad automatically
                    trySkipAd();
                } else if (videoIsPlaying && isAdPlaying) {
                    console.log('Video content detected - showing video');
                    hideAdOverlay();
                }
                
            } catch (error) {
                console.log('Error in ad detection:', error);
                // On error, assume there might be an ad to be safe
                if (!isAdPlaying && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.UNSTARTED) {
                    showAdOverlay();
                }
            }
        }
        
        // Attempt to skip ads automatically
        function trySkipAd() {
            if (!player) return;
            
            try {
                // Try to find and click skip button
                setTimeout(() => {
                    const skipButton = document.querySelector('.ytp-ad-skip-button, .ytp-skip-ad-button');
                    if (skipButton && skipButton.offsetParent !== null) {
                        console.log('Clicking skip button');
                        skipButton.click();
                    }
                }, 1000);
                
                // Try seeking to end of video if it's a short ad
                setTimeout(() => {
                    if (player.getDuration && player.seekTo) {
                        const duration = player.getDuration();
                        if (duration > 0 && duration < 30) { // Short ad
                            console.log('Seeking to end of short ad');
                            player.seekTo(duration - 1);
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.log('Error trying to skip ad:', error);
            }
        }

        // Show ad overlay and mute player
        function showAdOverlay() {
            isAdPlaying = true;
            const overlay = document.getElementById('adOverlay');
            overlay.classList.remove('hidden');
            
            // Mute the player during ads
            if (player && player.isMuted && player.mute) {
                if (!player.isMuted()) {
                    player.mute();
                    playerMutedForAd = true;
                }
            }
        }

        // Hide ad overlay and restore sound
        function hideAdOverlay() {
            isAdPlaying = false;
            const overlay = document.getElementById('adOverlay');
            overlay.classList.add('hidden');
            
            // Restore sound if we muted it for ads
            if (player && player.unMute && playerMutedForAd) {
                player.unMute();
                playerMutedForAd = false;
            }
        }

        // Handle video end - auto advance to next video
        function handleVideoEnd() {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (videos.length === 0) return;
            
            // Handle repeat one mode
            if (playbackSettings.repeat === 'one') {
                // Replay the same video
                if (player && player.playVideo) {
                    player.playVideo();
                }
                return;
            }
            
            // Handle repeat all mode or normal playback
            let nextIndex;
            
            if (playbackSettings.shuffle) {
                // Shuffle mode: pick random video
                nextIndex = Math.floor(Math.random() * videos.length);
            } else {
                // Normal mode: next video in sequence
                nextIndex = currentVideoIndex + 1;
                
                // If at end of playlist
                if (nextIndex >= videos.length) {
                    if (playbackSettings.repeat === 'all') {
                        nextIndex = 0; // Loop back to start
                    } else {
                        return; // Stop playing
                    }
                }
            }
            
            // Auto-play next video
            playVideoFromPlaylist(nextIndex);
        }

        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let apiKey = 'AIzaSyCQExuj8PVT14tgxr9jUB7qGsG364P_u48';
        let playlists = {};
        let currentPlaylist = null;
        let currentVideoIndex = 0;
        let playbackSettings = {
            shuffle: false,
            repeat: 'off' // 'off', 'all', 'one'
        };
        let searchType = 'video'; // 'video' or 'channel'
        let currentChannelId = null;
        let navigationStack = [];
        
        // Media Session variables
        let currentVideoInfo = {
            title: '',
            artist: '',
            artwork: ''
        };

        // LocalStorage utilities (much more reliable than cookies)
        function setLocalStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function getLocalStorage(key) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            } catch (error) {
                console.error('Error reading from localStorage:', error);
                return null;
            }
        }

        function removeLocalStorage(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.error('Error removing from localStorage:', error);
                return false;
            }
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updatePlaybackUI();
            initializeBackgroundPlayback();
        });

        // Load settings from localStorage
        function loadSettings() {
            const savedPlaylists = getLocalStorage('ytplayer_playlists');
            const savedPlaybackSettings = getLocalStorage('ytplayer_playback');
            const savedApiKey = getLocalStorage('ytplayer_apikey');

            if (savedPlaylists) {
                playlists = savedPlaylists;
                renderPlaylists();
                console.log(`Loaded ${Object.keys(playlists).length} playlists from storage`);
            }

            if (savedPlaybackSettings) {
                playbackSettings = savedPlaybackSettings;
            }

            if (savedApiKey) {
                apiKey = savedApiKey;
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            const success = setLocalStorage('ytplayer_playlists', playlists);
            setLocalStorage('ytplayer_playback', playbackSettings);
            setLocalStorage('ytplayer_apikey', apiKey);
            
            if (success) {
                console.log(`Saved ${Object.keys(playlists).length} playlists to storage`);
            } else {
                console.error('Failed to save playlists to storage');
            }
        }



        // Search functionality
        function setSearchType(type) {
            searchType = type;
            currentChannelId = null;
            setSearchTypeUI(type);
            clearSearchResults();
        }

        function performSearch() {
            if (searchType === 'video') {
                searchVideos();
            } else {
                searchChannels();
            }
        }

        async function searchVideos(channelId = null) {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query && !channelId) {
                alert('Please enter a search term');
                return;
            }
            
            if (!apiKey) {
                alert('Please set up your API key first');
                return;
            }
            
            showLoading();
            
            try {
                let url;
                if (channelId) {
                    url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=50&channelId=${channelId}&type=video&order=relevance&key=${apiKey}`;
                } else {
                    url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=50&q=${encodeURIComponent(query)}&type=video&key=${apiKey}`;
                }
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error (${response.status})`);
                }
                
                const data = await response.json();
                displayVideoResults(data.items);
                
            } catch (error) {
                console.error('Search error:', error);
                hideLoading();
                alert(`Search failed: ${error.message}`);
            }
        }

        async function searchChannels() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a search term');
                return;
            }
            
            if (!apiKey) {
                alert('Please set up your API key first');
                return;
            }
            
            showLoading();
            
            try {
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=50&q=${encodeURIComponent(query)}&type=channel&key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error (${response.status})`);
                }
                
                const data = await response.json();
                displayChannelResults(data.items);
                
            } catch (error) {
                console.error('Search error:', error);
                hideLoading();
                alert(`Search failed: ${error.message}`);
            }
        }

        function displayVideoResults(videos) {
            hideLoading();
            const resultsContainer = document.getElementById('searchResults');
            const noResultsDiv = document.getElementById('noResults');
            
            if (!videos || videos.length === 0) {
                resultsContainer.innerHTML = '';
                noResultsDiv.classList.remove('hidden');
                currentSearchData = null;
                return;
            }
            
            noResultsDiv.classList.add('hidden');
            
            // Store the current search data
            currentSearchData = {
                type: 'videos',
                data: videos,
                channelTitle: ''
            };
            
            resultsContainer.innerHTML = `
                <div class="col-span-full mb-4 text-center text-sm text-gray-600 dark:text-gray-400">
                    Found ${videos.length} videos
                </div>
            ` + videos.map(video => `
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md overflow-hidden">
                    <div class="relative">
                        <img src="${video.snippet.thumbnails.medium.url}" alt="${video.snippet.title}" class="w-full h-32 object-cover">
                    </div>
                    <div class="p-3">
                        <h4 class="font-semibold text-sm line-clamp-2 mb-2" title="${video.snippet.title}">
                            ${video.snippet.title}
                        </h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                            ${video.snippet.channelTitle}
                        </p>
                        <div class="flex gap-2">
                            <button 
                                onclick="playVideo('${video.id.videoId}', '${escapeHtml(video.snippet.title)}', '${escapeHtml(video.snippet.channelTitle)}')" 
                                class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-xs"
                            >
                                ‚ñ∂Ô∏è Play
                            </button>
                            <button 
                                onclick="showAddToPlaylistMenu('${video.id.videoId}', '${escapeHtml(video.snippet.title)}', '${escapeHtml(video.snippet.channelTitle)}', '${video.snippet.thumbnails.default.url}', this)" 
                                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                            >
                                ‚ûï Add
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayChannelResults(channels) {
            hideLoading();
            const resultsContainer = document.getElementById('searchResults');
            const noResultsDiv = document.getElementById('noResults');
            
            if (!channels || channels.length === 0) {
                resultsContainer.innerHTML = '';
                noResultsDiv.classList.remove('hidden');
                currentSearchData = null;
                return;
            }
            
            noResultsDiv.classList.add('hidden');
            
            // Store the current search data
            currentSearchData = {
                type: 'channels',
                data: channels,
                channelTitle: ''
            };
            
            resultsContainer.innerHTML = `
                <div class="col-span-full mb-4 text-center text-sm text-gray-600 dark:text-gray-400">
                    Found ${channels.length} channels
                </div>
            ` + channels.map(channel => `
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md overflow-hidden">
                    <div class="relative">
                        <img src="${channel.snippet.thumbnails.medium?.url || channel.snippet.thumbnails.default?.url || ''}" alt="${channel.snippet.title}" class="w-full h-32 object-cover">
                    </div>
                    <div class="p-3">
                        <h4 class="font-semibold text-sm line-clamp-2 mb-2" title="${channel.snippet.title}">
                            ${channel.snippet.title}
                        </h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2 line-clamp-2">
                            ${channel.snippet.description || 'No description available'}
                        </p>
                        <div class="flex gap-2">
                            <button 
                                onclick="viewChannelVideos('${channel.id.channelId}', '${escapeHtml(channel.snippet.title)}')" 
                                class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-xs"
                            >
                                üì∫ Videos
                            </button>
                            <button 
                                onclick="viewChannelPlaylists('${channel.id.channelId}', '${escapeHtml(channel.snippet.title)}')" 
                                class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                            >
                                üìã Playlists
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }



        function showNavigationBar(pathText) {
            document.getElementById('navigationBar').classList.remove('hidden');
            document.getElementById('navigationPath').textContent = pathText;
        }

        function hideNavigationBar() {
            document.getElementById('navigationBar').classList.add('hidden');
            navigationStack = [];
        }

        function navigateUp() {
            if (navigationStack.length > 0) {
                const previousState = navigationStack.pop();
                
                // Restore previous search state
                searchType = previousState.searchType;
                document.getElementById('searchInput').value = previousState.query;
                currentChannelId = previousState.channelId;
                
                // Update search type buttons
                setSearchTypeUI(searchType);
                
                // Show previous results using cached data (NO API calls)
                if (previousState.searchData) {
                    currentSearchData = previousState.searchData;
                    
                    if (previousState.searchData.type === 'channels') {
                        displayChannelResults(previousState.searchData.data);
                    } else if (previousState.searchData.type === 'playlists') {
                        displayYouTubePlaylists(previousState.searchData.data, previousState.searchData.channelTitle);
                    } else if (previousState.searchData.type === 'videos') {
                        displayVideoResults(previousState.searchData.data);
                    }
                } else {
                    clearSearchResults();
                }
                
                // Update navigation
                if (navigationStack.length === 0) {
                    hideNavigationBar();
                } else {
                    showNavigationBar(navigationStack[navigationStack.length - 1].pathText);
                }
            } else {
                hideNavigationBar();
                clearSearchResults();
            }
        }

        function setSearchTypeUI(type) {
            document.getElementById('videoSearchBtn').classList.toggle('bg-primary', type === 'video');
            document.getElementById('videoSearchBtn').classList.toggle('bg-gray-600', type !== 'video');
            document.getElementById('channelSearchBtn').classList.toggle('bg-primary', type === 'channel');
            document.getElementById('channelSearchBtn').classList.toggle('bg-gray-600', type !== 'channel');
            
            const placeholder = type === 'video' ? 'Search for videos...' : 'Search for channels...';
            document.getElementById('searchInput').placeholder = placeholder;
        }

        function clearSearchResults() {
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            currentChannelId = null;
            currentSearchData = null;
            hideNavigationBar();
        }

        function escapeHtml(text) {
            return text.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('noResults').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Playlist management
        function showCreatePlaylistForm() {
            document.getElementById('createPlaylistForm').classList.remove('hidden');
            document.getElementById('playlistNameInput').focus();
        }

        function hideCreatePlaylistForm() {
            document.getElementById('createPlaylistForm').classList.add('hidden');
            document.getElementById('playlistNameInput').value = '';
        }

        function createPlaylist() {
            const nameInput = document.getElementById('playlistNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a playlist name');
                return;
            }
            
            if (playlists[name]) {
                alert('Playlist already exists');
                return;
            }
            
            playlists[name] = {
                name: name,
                videos: [],
                created: new Date().toISOString()
            };
            
            saveSettings();
            renderPlaylists();
            hideCreatePlaylistForm();
        }

        function deletePlaylist(name) {
            if (confirm(`Delete playlist "${name}"?`)) {
                delete playlists[name];
                if (currentPlaylist === name) {
                    clearCurrentPlaylist();
                }
                saveSettings();
                renderPlaylists();
            }
        }

        function renderPlaylists() {
            const container = document.getElementById('playlistsList');
            const playlistNames = Object.keys(playlists);
            
            if (playlistNames.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400 text-sm">No playlists yet. Create one to get started!</p>';
                return;
            }
            
            container.innerHTML = playlistNames.map(name => `
                <div class="playlist-item p-3 bg-white dark:bg-gray-700 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex-1 cursor-pointer" onclick="loadPlaylist('${name}')">
                            <div class="font-medium">${name}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${playlists[name].videos.length} videos</div>
                        </div>
                        <button 
                            onclick="deletePlaylist('${name}')" 
                            class="text-red-500 hover:text-red-700 transition-colors ml-2"
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="playlist-actions">
                        <button 
                            onclick="showRenameForm('${escapeHtml(name)}')" 
                            class="playlist-action-btn btn-rename"
                            title="Rename playlist"
                        >
                            üìù Rename
                        </button>
                        <button 
                            onclick="duplicatePlaylist('${escapeHtml(name)}')" 
                            class="playlist-action-btn btn-duplicate"
                            title="Duplicate playlist"
                        >
                            üìã Copy
                        </button>
                        <button 
                            onclick="showMergeDialog('${escapeHtml(name)}')" 
                            class="playlist-action-btn btn-merge"
                            title="Merge with other playlists"
                        >
                            üîÄ Merge
                        </button>
                        <button 
                            onclick="showPlaylistInfo('${escapeHtml(name)}')" 
                            class="playlist-action-btn btn-info"
                            title="Show playlist info"
                        >
                            üìä Info
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadPlaylist(name) {
            currentPlaylist = name;
            currentVideoIndex = 0;
            renderCurrentPlaylist();
        }

        function clearCurrentPlaylist() {
            currentPlaylist = null;
            currentVideoIndex = 0;
            document.getElementById('currentPlaylistSection').classList.add('hidden');
            clearVideo();
        }

        function renderCurrentPlaylist() {
            if (!currentPlaylist) return;
            
            const section = document.getElementById('currentPlaylistSection');
            const title = document.getElementById('currentPlaylistTitle');
            const container = document.getElementById('currentPlaylistVideos');
            
            title.textContent = currentPlaylist;
            section.classList.remove('hidden');
            
            const videos = playlists[currentPlaylist].videos;
            
            if (videos.length === 0) {
                container.innerHTML = '<p class="text-gray-600 dark:text-gray-400 text-sm">No videos in this playlist yet.</p>';
                return;
            }
            
            const isSelectionMode = container.classList.contains('selection-mode');
            
            container.innerHTML = videos.map((video, index) => `
                <div class="playlist-video-item playlist-item flex items-center gap-3 p-2 rounded cursor-pointer ${index === currentVideoIndex ? 'active' : ''}" 
                     data-index="${index}"
                     draggable="${!isSelectionMode}"
                     onclick="${isSelectionMode ? `toggleVideoSelection(${index})` : `playVideoFromPlaylist(${index})`}"
                     ondragstart="handleDragStart(event, ${index})"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, ${index})"
                     ondragend="handleDragEnd(event)">
                    ${isSelectionMode ? `
                        <input type="checkbox" class="video-checkbox" data-index="${index}" onchange="updateSelectedCount()">
                    ` : ''}
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-16 h-12 object-cover rounded ${!isSelectionMode ? 'cursor-grab' : ''}"
                         ${!isSelectionMode ? `
                         ontouchstart="handleVideoTouchStart(event, ${index})"
                         ontouchmove="handleVideoTouchMove(event, ${index})"
                         ontouchend="handleVideoTouchEnd(event, ${index})"
                         onclick="event.stopPropagation(); playVideoFromPlaylist(${index})"
                         ` : ''}>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm line-clamp-2">${video.title}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${video.channel}</div>
                    </div>
                    ${!isSelectionMode ? `
                        <button 
                            onclick="removeFromPlaylist(${index}); event.stopPropagation();" 
                            class="text-red-500 hover:text-red-700 transition-colors"
                        >
                            ‚úï
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function showAddToPlaylistMenu(videoId, title, channel, thumbnail, buttonElement) {
            const playlistNames = Object.keys(playlists);
            
            if (playlistNames.length === 0) {
                alert('Create a playlist first!');
                return;
            }
            
            // Remove any existing dropdown
            const existingDropdown = document.querySelector('.playlist-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            // Create dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'playlist-dropdown fixed bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-xl py-2 min-w-48 max-h-64 overflow-y-auto';
            dropdown.style.zIndex = '9999';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-600';
            header.textContent = 'Add to playlist:';
            dropdown.appendChild(header);
            
            // Add playlist options
            playlistNames.forEach(playlistName => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors';
                option.textContent = `${playlistName} (${playlists[playlistName].videos.length} videos)`;
                option.onclick = () => {
                    addToPlaylist(playlistName, { id: videoId, title, channel, thumbnail });
                    dropdown.remove();
                };
                dropdown.appendChild(option);
            });
            
            // Position dropdown using fixed positioning
            const buttonRect = buttonElement.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // Calculate position
            let top = buttonRect.bottom + 4;
            let left = buttonRect.left;
            
            // Adjust if dropdown would go off-screen
            const dropdownHeight = Math.min(playlistNames.length * 40 + 60, 256); // Estimate height
            const dropdownWidth = 192; // min-w-48 = 192px
            
            // Adjust vertical position if it goes below viewport
            if (top + dropdownHeight > viewportHeight) {
                top = buttonRect.top - dropdownHeight - 4;
            }
            
            // Adjust horizontal position if it goes off right edge
            if (left + dropdownWidth > viewportWidth) {
                left = viewportWidth - dropdownWidth - 10;
            }
            
            // Ensure it doesn't go off left edge
            if (left < 10) {
                left = 10;
            }
            
            dropdown.style.top = top + 'px';
            dropdown.style.left = left + 'px';
            
            // Append to body for better positioning
            document.body.appendChild(dropdown);
            
            // Close dropdown when clicking outside
            const closeDropdown = (e) => {
                if (!dropdown.contains(e.target) && e.target !== buttonElement) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            };
            
            // Add event listener after a small delay to prevent immediate closure
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 100);
        }

        function addToPlaylist(playlistName, video) {
            if (!playlists[playlistName]) return;
            
            // Check if video already exists in playlist
            const exists = playlists[playlistName].videos.some(v => v.id === video.id);
            if (exists) {
                alert('Video already in playlist!');
                return;
            }
            
            playlists[playlistName].videos.push(video);
            saveSettings();
            
            if (currentPlaylist === playlistName) {
                renderCurrentPlaylist();
            }
            
            renderPlaylists();
        }

        function removeFromPlaylist(index) {
            if (!currentPlaylist) return;
            
            playlists[currentPlaylist].videos.splice(index, 1);
            
            // Adjust current video index if needed
            if (currentVideoIndex >= index && currentVideoIndex > 0) {
                currentVideoIndex--;
            }
            
            saveSettings();
            renderCurrentPlaylist();
            renderPlaylists();
        }

        // Media Session API Integration
        function initializeMediaSession() {
            if ('mediaSession' in navigator) {
                console.log('Media Session API supported');
                
                // Set up action handlers
                navigator.mediaSession.setActionHandler('play', () => {
                    console.log('Media session: play requested');
                    userPausedManually = false; // Reset manual pause flag
                    if (player && player.playVideo) {
                        player.playVideo();
                    }
                });
                
                navigator.mediaSession.setActionHandler('pause', () => {
                    console.log('Media session: pause requested');
                    userPausedManually = true; // Mark as manual pause
                    if (player && player.pauseVideo) {
                        player.pauseVideo();
                    }
                });
                
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    console.log('Media session: previous track requested');
                    // Check if we have a current playlist with videos
                    if (currentPlaylist && playlists[currentPlaylist] && playlists[currentPlaylist].videos.length > 1) {
                        playPrevious();
                    } else {
                        console.log('No playlist or insufficient videos for previous track');
                    }
                });
                
                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    console.log('Media session: next track requested');
                    // Check if we have a current playlist with videos
                    if (currentPlaylist && playlists[currentPlaylist] && playlists[currentPlaylist].videos.length > 1) {
                        playNext();
                    } else {
                        console.log('No playlist or insufficient videos for next track');
                    }
                });
                
                navigator.mediaSession.setActionHandler('stop', () => {
                    console.log('Media session: stop requested');
                    userPausedManually = true; // Mark as manual stop
                    clearVideo();
                });
                
                // Seek handlers for more granular control
                navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                    if (player && player.getCurrentTime && player.seekTo) {
                        const currentTime = player.getCurrentTime();
                        const seekTime = Math.max(0, currentTime - (details.seekOffset || 10));
                        player.seekTo(seekTime);
                    }
                });
                
                navigator.mediaSession.setActionHandler('seekforward', (details) => {
                    if (player && player.getCurrentTime && player.seekTo && player.getDuration) {
                        const currentTime = player.getCurrentTime();
                        const duration = player.getDuration();
                        const seekTime = Math.min(duration, currentTime + (details.seekOffset || 10));
                        player.seekTo(seekTime);
                    }
                });
                
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    if (player && player.seekTo && details.seekTime) {
                        player.seekTo(details.seekTime);
                    }
                });
            } else {
                console.log('Media Session API not supported');
            }
        }
        
        function updateMediaSessionMetadata(title, artist, artwork) {
            if ('mediaSession' in navigator) {
                currentVideoInfo = { title, artist, artwork };
                
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title,
                    artist: artist,
                    album: 'YouTube Player',
                    artwork: [
                        { src: artwork, sizes: '96x96', type: 'image/jpeg' },
                        { src: artwork, sizes: '128x128', type: 'image/jpeg' },
                        { src: artwork, sizes: '192x192', type: 'image/jpeg' },
                        { src: artwork, sizes: '256x256', type: 'image/jpeg' },
                        { src: artwork, sizes: '384x384', type: 'image/jpeg' },
                        { src: artwork, sizes: '512x512', type: 'image/jpeg' }
                    ]
                });
            }
        }
        
        function updateMediaSessionPlaybackState(playerState) {
            if ('mediaSession' in navigator) {
                // Update playback state based on YouTube player state
                switch (playerState) {
                    case YT.PlayerState.PLAYING:
                        navigator.mediaSession.playbackState = 'playing';
                        updateMediaSessionPosition();
                        break;
                    case YT.PlayerState.PAUSED:
                        navigator.mediaSession.playbackState = 'paused';
                        break;
                    case YT.PlayerState.ENDED:
                        navigator.mediaSession.playbackState = 'none';
                        break;
                    case YT.PlayerState.BUFFERING:
                        // Keep current state while buffering
                        break;
                    default:
                        navigator.mediaSession.playbackState = 'none';
                }
            }
        }
        
        function updateMediaSessionPosition() {
            if ('mediaSession' in navigator && player && player.getCurrentTime && player.getDuration) {
                try {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    const playbackRate = player.getPlaybackRate && player.getPlaybackRate() || 1;
                    
                    // Only update if we have valid data and aren't playing ads
                    if (currentTime >= 0 && currentTime <= duration && duration > 0 && duration < 86400 && !isAdPlaying) {
                        // Ensure position doesn't exceed duration
                        const safePosition = Math.min(currentTime, duration - 1);
                        
                        navigator.mediaSession.setPositionState({
                            duration: duration,
                            playbackRate: playbackRate,
                            position: safePosition
                        });
                    }
                } catch (error) {
                    console.log('Error updating media session position:', error);
                    // Clear position state on error to prevent stuck progress bars
                    try {
                        navigator.mediaSession.setPositionState({});
                    } catch (clearError) {
                        console.log('Error clearing position state:', clearError);
                    }
                }
            }
        }
        
        // Start periodic position updates when media session is active
        function startMediaSessionPositionUpdates() {
            // Update position every 5 seconds when playing
            setInterval(() => {
                if (player && navigator.mediaSession && navigator.mediaSession.playbackState === 'playing') {
                    updateMediaSessionPosition();
                }
            }, 5000);
        }

        // Video playback
        function playVideo(videoId, title, channel) {
            const videoContainer = document.getElementById('videoContainer');
            const videoTitle = document.getElementById('videoTitle');
            const videoChannel = document.getElementById('videoChannel');
            
            videoTitle.textContent = title;
            videoChannel.textContent = channel;
            videoContainer.classList.remove('hidden');
            
            // Initialize media session if not already done
            if (!navigator.mediaSession || !navigator.mediaSession.metadata) {
                initializeMediaSession();
                startMediaSessionPositionUpdates();
            }
            
            // Get video thumbnail URL for media session
            const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            
            // Update media session metadata
            updateMediaSessionMetadata(title, channel, thumbnailUrl);
            
            // Initialize or update YouTube player
            if (!player) {
                // Wait for API to be ready
                if (!playerReady || !window.YT) {
                    setTimeout(() => playVideo(videoId, title, channel), 100);
                    return;
                }
                
                // Create new player
                player = new YT.Player('videoPlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        autoplay: 1,
                        rel: 0,          // Reduce related videos
                        showinfo: 0,     // Hide video info
                        modestbranding: 1, // Reduce YouTube branding
                        iv_load_policy: 3, // Hide video annotations
                        cc_load_policy: 0, // Hide closed captions by default
                        fs: 1,           // Allow fullscreen
                        disablekb: 0     // Enable keyboard controls
                    },
                    events: {
                        onStateChange: onPlayerStateChange,
                        onAdStateChange: onAdStateChange
                    }
                });
                
                // Start periodic ad checking
                setInterval(checkForAds, 1000); // Check every second
            } else {
                // Update existing player
                player.loadVideoById(videoId);
            }
            
            // Load video details for the drawer
            loadVideoDetails(videoId);
            
            videoContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Video Details Drawer Functions
        let currentVideoDetails = null;

        function toggleVideoDetails() {
            const drawer = document.getElementById('videoDetailsDrawer');
            drawer.classList.toggle('open');
        }

        async function loadVideoDetails(videoId) {
            if (!apiKey) {
                showVideoDetailsError();
                return;
            }

            showVideoDetailsLoading();
            
            try {
                // Fetch video details including statistics
                const videoUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoId}&key=${apiKey}`;
                const videoResponse = await fetch(videoUrl);
                
                if (!videoResponse.ok) {
                    throw new Error(`Video API Error (${videoResponse.status})`);
                }
                
                const videoData = await videoResponse.json();
                
                if (!videoData.items || videoData.items.length === 0) {
                    throw new Error('Video not found');
                }
                
                const video = videoData.items[0];
                
                // Fetch channel details
                const channelUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${video.snippet.channelId}&key=${apiKey}`;
                const channelResponse = await fetch(channelUrl);
                
                let channelData = null;
                if (channelResponse.ok) {
                    const channelJson = await channelResponse.json();
                    if (channelJson.items && channelJson.items.length > 0) {
                        channelData = channelJson.items[0];
                    }
                }
                
                // Store current video details
                currentVideoDetails = {
                    video: video,
                    channel: channelData
                };
                
                displayVideoDetails(video, channelData);
                
            } catch (error) {
                console.error('Video details error:', error);
                showVideoDetailsError();
            }
        }

        function displayVideoDetails(video, channel) {
            hideVideoDetailsLoading();
            
            // Show video statistics
            const stats = video.statistics;
            document.getElementById('viewCount').textContent = formatNumber(stats.viewCount || 0);
            document.getElementById('likeCount').textContent = formatNumber(stats.likeCount || 0);
            document.getElementById('commentCount').textContent = formatNumber(stats.commentCount || 0);
            document.getElementById('publishedDate').textContent = formatPublishDate(video.snippet.publishedAt);
            
            document.getElementById('videoStats').classList.remove('hidden');
            
            // Show video description
            const description = video.snippet.description || 'No description available.';
            document.getElementById('descriptionText').textContent = description;
            
            // Show expand button if description is long
            const expandBtn = document.getElementById('expandDescription');
            if (description.length > 300) {
                expandBtn.classList.remove('hidden');
                expandBtn.onclick = toggleDescription;
            } else {
                expandBtn.classList.add('hidden');
            }
            
            document.getElementById('videoDescription').classList.remove('hidden');
            
            // Show channel information
            if (channel) {
                document.getElementById('channelThumbnail').src = channel.snippet.thumbnails.default?.url || '';
                document.getElementById('channelTitle').textContent = channel.snippet.title;
                
                const subscriberCount = formatNumber(channel.statistics.subscriberCount || 0);
                document.getElementById('subscriberCount').textContent = `${subscriberCount} subscribers`;
                
                document.getElementById('channelInfo').classList.remove('hidden');
            }
        }

        function formatNumber(num) {
            const number = parseInt(num);
            if (number >= 1000000000) {
                return (number / 1000000000).toFixed(1) + 'B';
            } else if (number >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            } else if (number >= 1000) {
                return (number / 1000).toFixed(1) + 'K';
            }
            return number.toLocaleString();
        }

        function formatPublishDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return '1 day ago';
            if (diffDays < 30) return `${diffDays} days ago`;
            if (diffMonths === 1) return '1 month ago';
            if (diffMonths < 12) return `${diffMonths} months ago`;
            if (diffYears === 1) return '1 year ago';
            return `${diffYears} years ago`;
        }

        function toggleDescription() {
            const content = document.querySelector('.description-content');
            const btn = document.getElementById('expandDescription');
            
            content.classList.toggle('expanded');
            btn.textContent = content.classList.contains('expanded') ? 'Show less' : 'Show more';
        }

        function showVideoDetailsLoading() {
            // Hide all sections
            document.getElementById('videoStats').classList.add('hidden');
            document.getElementById('videoDescription').classList.add('hidden');
            document.getElementById('channelInfo').classList.add('hidden');
            document.getElementById('videoDetailsError').classList.add('hidden');
            
            // Show loading
            document.getElementById('videoDetailsLoading').classList.remove('hidden');
        }

        function hideVideoDetailsLoading() {
            document.getElementById('videoDetailsLoading').classList.add('hidden');
        }

        function showVideoDetailsError() {
            // Hide all sections
            document.getElementById('videoStats').classList.add('hidden');
            document.getElementById('videoDescription').classList.add('hidden');
            document.getElementById('channelInfo').classList.add('hidden');
            document.getElementById('videoDetailsLoading').classList.add('hidden');
            
            // Show error
            document.getElementById('videoDetailsError').classList.remove('hidden');
        }

        function viewChannelFromDetails() {
            if (!currentVideoDetails || !currentVideoDetails.channel) return;
            
            const channel = currentVideoDetails.channel;
            viewChannelVideos(channel.id, channel.snippet.title);
        }

        function playVideoFromPlaylist(index) {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (index < 0 || index >= videos.length) return;
            
            currentVideoIndex = index;
            const video = videos[index];
            
            playVideo(video.id, video.title, video.channel);
            renderCurrentPlaylist(); // Update active indicator
        }

        function clearVideo() {
            const videoContainer = document.getElementById('videoContainer');
            
            // Clear media session
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'none';
                navigator.mediaSession.metadata = null;
            }
            
            // Destroy YouTube player if it exists
            if (player && player.destroy) {
                player.destroy();
                player = null;
            }
            
            videoContainer.classList.add('hidden');
        }

        // Playback controls
        function toggleShuffle() {
            playbackSettings.shuffle = !playbackSettings.shuffle;
            saveSettings();
            updatePlaybackUI();
        }

        function toggleRepeat() {
            const modes = ['off', 'all', 'one'];
            const currentIndex = modes.indexOf(playbackSettings.repeat);
            playbackSettings.repeat = modes[(currentIndex + 1) % modes.length];
            saveSettings();
            updatePlaybackUI();
        }

        function updatePlaybackUI() {
            document.getElementById('shuffleStatus').textContent = playbackSettings.shuffle ? 'On' : 'Off';
            document.getElementById('shuffleBtn').classList.toggle('bg-primary', playbackSettings.shuffle);
            document.getElementById('shuffleBtn').classList.toggle('bg-gray-600', !playbackSettings.shuffle);
            
            const repeatText = playbackSettings.repeat === 'off' ? 'Off' : 
                              playbackSettings.repeat === 'all' ? 'All' : 'One';
            document.getElementById('repeatStatus').textContent = repeatText;
            document.getElementById('repeatBtn').classList.toggle('bg-primary', playbackSettings.repeat !== 'off');
            document.getElementById('repeatBtn').classList.toggle('bg-gray-600', playbackSettings.repeat === 'off');
        }

        function playNext() {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (videos.length === 0) return;
            
            let nextIndex;
            
            if (playbackSettings.shuffle) {
                nextIndex = Math.floor(Math.random() * videos.length);
            } else {
                nextIndex = (currentVideoIndex + 1) % videos.length;
            }
            
            playVideoFromPlaylist(nextIndex);
        }

        function playPrevious() {
            if (!currentPlaylist) return;
            
            const videos = playlists[currentPlaylist].videos;
            if (videos.length === 0) return;
            
            let prevIndex;
            
            if (playbackSettings.shuffle) {
                prevIndex = Math.floor(Math.random() * videos.length);
            } else {
                prevIndex = currentVideoIndex === 0 ? videos.length - 1 : currentVideoIndex - 1;
            }
            
            playVideoFromPlaylist(prevIndex);
        }

        // Channel content functions
        async function viewChannelVideos(channelId, channelTitle) {
            // Save current state to navigation stack
            if (currentSearchData) {
                navigationStack.push({
                    searchType: searchType,
                    query: document.getElementById('searchInput').value,
                    channelId: currentChannelId,
                    searchData: currentSearchData,
                    pathText: `${channelTitle} - Channels`
                });
            }
            
            currentChannelId = channelId;
            document.getElementById('searchInput').value = `${channelTitle} - Videos`;
            showNavigationBar(`${channelTitle} - Videos`);
            await searchVideos(channelId);
        }

        async function viewChannelPlaylists(channelId, channelTitle) {
            if (!apiKey) {
                alert('Please set up your API key first');
                return;
            }
            
            // Save current state to navigation stack
            if (currentSearchData) {
                navigationStack.push({
                    searchType: searchType,
                    query: document.getElementById('searchInput').value,
                    channelId: currentChannelId,
                    searchData: currentSearchData,
                    pathText: `${channelTitle} - Channels`
                });
            }
            
            showLoading();
            
            try {
                const url = `https://www.googleapis.com/youtube/v3/playlists?part=snippet&channelId=${channelId}&maxResults=50&key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error (${response.status})`);
                }
                
                const data = await response.json();
                showNavigationBar(`${channelTitle} - Playlists`);
                displayYouTubePlaylists(data.items, channelTitle);
                
            } catch (error) {
                console.error('Playlist search error:', error);
                hideLoading();
                alert(`Failed to load playlists: ${error.message}`);
            }
        }

        function displayYouTubePlaylists(playlists, channelTitle) {
            hideLoading();
            const resultsContainer = document.getElementById('searchResults');
            const noResultsDiv = document.getElementById('noResults');
            
            if (!playlists || playlists.length === 0) {
                resultsContainer.innerHTML = '';
                noResultsDiv.classList.remove('hidden');
                currentSearchData = null;
                return;
            }
            
            noResultsDiv.classList.add('hidden');
            document.getElementById('searchInput').value = `${channelTitle} - Playlists`;
            
            // Store the current search data
            currentSearchData = {
                type: 'playlists',
                data: playlists,
                channelTitle: channelTitle
            };
            
            resultsContainer.innerHTML = `
                <div class="col-span-full mb-4 text-center text-sm text-gray-600 dark:text-gray-400">
                    Found ${playlists.length} playlists
                </div>
            ` + playlists.map(playlist => `
                <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md overflow-hidden">
                    <div class="relative">
                        <img src="${playlist.snippet.thumbnails.medium?.url || playlist.snippet.thumbnails.default?.url || ''}" alt="${playlist.snippet.title}" class="w-full h-32 object-cover">
                        <div class="absolute bottom-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
                            üìã Playlist
                        </div>
                    </div>
                    <div class="p-3">
                        <h4 class="font-semibold text-sm line-clamp-2 mb-2" title="${playlist.snippet.title}">
                            ${playlist.snippet.title}
                        </h4>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                            ${playlist.snippet.channelTitle}
                        </p>
                        <div class="flex gap-2">
                            <button 
                                onclick="viewPlaylistVideos('${playlist.id}', '${escapeHtml(playlist.snippet.title)}')" 
                                class="px-3 py-1 bg-primary text-white rounded hover:bg-opacity-90 transition-colors text-xs"
                            >
                                üì∫ View Videos
                            </button>
                            <button 
                                onclick="importYouTubePlaylist('${playlist.id}', '${escapeHtml(playlist.snippet.title)}')" 
                                class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                            >
                                üì• Import
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewPlaylistVideos(playlistId, playlistTitle) {
            if (!apiKey) {
                alert('Please set up your API key first');
                return;
            }
            
            // Save current state to navigation stack (the playlists view)
            if (currentSearchData) {
                // Get the current navigation path to save it properly
                const currentPath = document.getElementById('navigationPath').textContent;
                
                navigationStack.push({
                    searchType: searchType,
                    query: document.getElementById('searchInput').value,
                    channelId: currentChannelId,
                    searchData: currentSearchData,
                    pathText: currentPath
                });
            }
            
            showLoading();
            
            try {
                const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50&key=${apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error (${response.status})`);
                }
                
                const data = await response.json();
                const videos = data.items.map(item => ({
                    id: { videoId: item.snippet.resourceId.videoId },
                    snippet: item.snippet
                }));
                displayVideoResults(videos);
                document.getElementById('searchInput').value = `${playlistTitle} - Videos`;
                showNavigationBar(`${playlistTitle} - Videos`);
                
            } catch (error) {
                console.error('Playlist videos error:', error);
                hideLoading();
                alert(`Failed to load playlist videos: ${error.message}`);
            }
        }

        // Global variable to store current search results data
        let currentSearchData = null;

        async function importYouTubePlaylist(playlistId, playlistTitle) {
            if (!apiKey) {
                alert('Please set up your API key first');
                return;
            }
            
            if (playlists[playlistTitle]) {
                if (!confirm(`Playlist "${playlistTitle}" already exists. Overwrite it?`)) {
                    return;
                }
            }
            
            showLoading();
            
            try {
                // Import ALL videos from playlist (no limits)
                let allVideos = [];
                let nextPageToken = '';
                let totalFetched = 0;
                
                do {
                    const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50${nextPageToken ? '&pageToken=' + nextPageToken : ''}&key=${apiKey}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`API Error (${response.status})`);
                    }
                    
                    const data = await response.json();
                    const videos = data.items.map(item => ({
                        id: item.snippet.resourceId.videoId,
                        title: item.snippet.title,
                        channel: item.snippet.videoOwnerChannelTitle || item.snippet.channelTitle,
                        thumbnail: item.snippet.thumbnails.default?.url || ''
                    }));
                    
                    allVideos = allVideos.concat(videos);
                    totalFetched += videos.length;
                    nextPageToken = data.nextPageToken || '';
                    
                    console.log(`Imported ${totalFetched} videos so far...`);
                    
                } while (nextPageToken);
                
                playlists[playlistTitle] = {
                    name: playlistTitle,
                    videos: allVideos,
                    created: new Date().toISOString(),
                    imported: true
                };
                
                saveSettings();
                renderPlaylists();
                hideLoading();
                alert(`Successfully imported ${allVideos.length} videos from "${playlistTitle}"`);
                
            } catch (error) {
                console.error('Import playlist error:', error);
                hideLoading();
                alert(`Failed to import playlist: ${error.message}`);
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        });

        document.getElementById('playlistNameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                createPlaylist();
            }
        });

        // Background Playback System
        function initializeBackgroundPlayback() {
            console.log('Initializing background playback system...');
            
            // Initialize Audio Context for background playback
            initializeAudioContext();
            
            // Set up Page Visibility API
            setupPageVisibilityHandling();
            
            // Set up Wake Lock (if supported)
            setupWakeLock();
            
            // Set up beforeunload handling
            setupUnloadHandling();
            
            // Ensure media session is active
            if ('mediaSession' in navigator) {
                // Set initial playback state
                navigator.mediaSession.playbackState = 'none';
            }
            
            console.log('Background playback system initialized');
        }
        
        function initializeAudioContext() {
            try {
                // Create AudioContext to maintain audio processing in background
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                if (window.AudioContext) {
                    audioContext = new AudioContext();
                    
                    // Create a silent audio buffer to keep context active
                    const buffer = audioContext.createBuffer(1, 1, 22050);
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioContext.destination);
                    source.start();
                    
                    console.log('Audio context initialized for background playback');
                }
            } catch (error) {
                console.log('Audio context initialization failed:', error);
            }
        }
        
        function setupPageVisibilityHandling() {
            // Page Visibility API to handle tab switching
            let visibilityChange;
            let hidden;
            
            if (typeof document.hidden !== "undefined") {
                hidden = "hidden";
                visibilityChange = "visibilitychange";
            } else if (typeof document.msHidden !== "undefined") {
                hidden = "msHidden";
                visibilityChange = "msvisibilitychange";
            } else if (typeof document.webkitHidden !== "undefined") {
                hidden = "webkitHidden";
                visibilityChange = "webkitvisibilitychange";
            }
            
            if (typeof document[hidden] !== "undefined") {
                document.addEventListener(visibilityChange, handleVisibilityChange, false);
                console.log('Page visibility handling enabled');
            }
            
            // Handle page focus/blur events as backup
            window.addEventListener('focus', handlePageFocus);
            window.addEventListener('blur', handlePageBlur);
        }
        
        function handleVisibilityChange() {
            isPageVisible = !document.hidden;
            
            if (!backgroundPlaybackEnabled || !player) return;
            
            if (isPageVisible) {
                console.log('Page became visible - resuming normal playback');
                handlePageFocus();
            } else {
                console.log('Page became hidden - maintaining background playback');
                handlePageBlur();
            }
        }
        
        function handlePageFocus() {
            // Page became visible/focused
            if (player && backgroundPlaybackEnabled) {
                // Resume audio context if suspended
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().catch(console.error);
                }
                
                // Ensure video continues playing if it was playing
                try {
                    const state = player.getPlayerState();
                    if (state === YT.PlayerState.PAUSED && navigator.mediaSession?.playbackState === 'playing') {
                        // Resume if media session indicates it should be playing
                        player.playVideo();
                    }
                } catch (error) {
                    console.log('Error resuming playback on focus:', error);
                }
            }
        }
        
        function handlePageBlur() {
            // Page became hidden/lost focus
            if (player && backgroundPlaybackEnabled && !userPausedManually) {
                try {
                    const state = player.getPlayerState();
                    
                    // Only try to maintain playback if user didn't manually pause
                    if (state === YT.PlayerState.PLAYING || lastKnownPlaybackState === YT.PlayerState.PLAYING) {
                        console.log('Maintaining background playback...');
                        
                        // Maintain audio context
                        if (audioContext && audioContext.state !== 'running') {
                            audioContext.resume().catch(console.error);
                        }
                        
                        // Apply background playback strategies
                        maintainBackgroundPlayback();
                    }
                    
                } catch (error) {
                    console.log('Error in background playback handling:', error);
                }
            } else if (userPausedManually) {
                console.log('User manually paused - not attempting background playback');
            }
        }
        
        function maintainBackgroundPlayback() {
            if (!player || !backgroundPlaybackEnabled) return;
            
            try {
                // Strategy 1: Ensure media session is properly set
                if ('mediaSession' in navigator && currentVideoInfo.title) {
                    updateMediaSessionMetadata(currentVideoInfo.title, currentVideoInfo.artist, currentVideoInfo.artwork);
                    navigator.mediaSession.playbackState = 'playing';
                }
                
                // Strategy 2: Keep audio context active
                if (audioContext) {
                    // Create periodic silent audio to maintain context
                    setInterval(() => {
                        if (!isPageVisible && audioContext.state === 'running') {
                            const buffer = audioContext.createBuffer(1, 1, 22050);
                            const source = audioContext.createBufferSource();
                            source.buffer = buffer;
                            source.connect(audioContext.destination);
                            source.start();
                        }
                    }, 10000); // Every 10 seconds
                }
                
                // Strategy 3: Prevent player from being paused by mobile browser
                const checkPlaybackState = () => {
                    if (!isPageVisible && player && !userPausedManually && backgroundPlaybackEnabled) {
                        try {
                            const state = player.getPlayerState();
                            const mediaSessionState = navigator.mediaSession?.playbackState;
                            
                            // Only resume if:
                            // 1. Player is paused
                            // 2. User didn't manually pause 
                            // 3. Media session shows we should be playing
                            // 4. Background playback is enabled
                            if (state === YT.PlayerState.PAUSED && 
                                mediaSessionState === 'playing' && 
                                !userPausedManually) {
                                
                                console.log('Attempting to resume background playback...');
                                
                                // Try to resume playback (with limited attempts)
                                let attemptCount = 0;
                                const resumeAttempt = () => {
                                    if (player && player.playVideo && attemptCount < 2 && !userPausedManually) {
                                        player.playVideo();
                                        attemptCount++;
                                        
                                        setTimeout(() => {
                                            // Check again after a short delay
                                            if (player.getPlayerState() === YT.PlayerState.PAUSED && 
                                                !userPausedManually && 
                                                navigator.mediaSession?.playbackState === 'playing') {
                                                resumeAttempt();
                                            }
                                        }, 500);
                                    }
                                };
                                resumeAttempt();
                            }
                        } catch (error) {
                            console.log('Error checking playback state:', error);
                        }
                    }
                };
                
                // Check every 1 second when page is hidden for faster response
                const backgroundCheck = setInterval(() => {
                    if (isPageVisible) {
                        clearInterval(backgroundCheck);
                        return;
                    }
                    checkPlaybackState();
                }, 1000);
                
                // Strategy 4: Use Web Locks API to maintain active state
                if ('locks' in navigator) {
                    navigator.locks.request('background-playback', { mode: 'shared' }, () => {
                        return new Promise((resolve) => {
                            // Keep lock active while playing in background
                            const checkLock = () => {
                                if (isPageVisible || !backgroundPlaybackEnabled || !player) {
                                    resolve();
                                    return;
                                }
                                setTimeout(checkLock, 5000);
                            };
                            checkLock();
                        });
                    }).catch(console.error);
                }
                
            } catch (error) {
                console.log('Error in maintainBackgroundPlayback:', error);
            }
        }
        
        function setupWakeLock() {
            // Screen Wake Lock API to prevent device sleep during playback
            if ('wakeLock' in navigator) {
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Screen wake lock activated');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('Screen wake lock released');
                            wakeLock = null;
                        });
                    } catch (error) {
                        console.log('Wake lock request failed:', error);
                    }
                };
                
                // Request wake lock when video starts playing
                const originalPlayVideo = window.playVideo;
                if (originalPlayVideo) {
                    window.playVideo = function(...args) {
                        requestWakeLock();
                        return originalPlayVideo.apply(this, args);
                    };
                }
            }
        }
        
        function setupUnloadHandling() {
            // Handle page unload to maintain playback state
            window.addEventListener('beforeunload', (event) => {
                if (player && backgroundPlaybackEnabled) {
                    try {
                        const state = player.getPlayerState();
                        if (state === YT.PlayerState.PLAYING) {
                            // Save current playback state
                            const currentTime = player.getCurrentTime();
                            const videoId = player.getVideoData && player.getVideoData().video_id;
                            
                            if (videoId && currentTime) {
                                setLocalStorage('ytplayer_last_position', {
                                    videoId: videoId,
                                    currentTime: currentTime,
                                    timestamp: Date.now()
                                });
                            }
                        }
                    } catch (error) {
                        console.log('Error saving playback state:', error);
                    }
                }
            });
            
            // Handle page show (when returning from background)
            window.addEventListener('pageshow', (event) => {
                if (event.persisted) {
                    // Page was restored from cache
                    handlePageFocus();
                }
            });
        }
        
        function enableBackgroundPlayback() {
            backgroundPlaybackEnabled = true;
            console.log('Background playback enabled');
            
            // Initialize audio context if not already done
            if (!audioContext) {
                initializeAudioContext();
            }
        }
        
        function disableBackgroundPlayback() {
            backgroundPlaybackEnabled = false;
            console.log('Background playback disabled');
            
            // Release wake lock if active
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // Enhanced Playlist Management Features

        // Drag and Drop Variables
        let draggedIndex = null;
        let draggedElement = null;

        // Selection Mode Variables
        let isSelectionMode = false;
        let selectedVideos = new Set();

        // Rename Playlist Functions
        function showRenameForm(oldName) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'renameOverlay';
            
            const form = document.createElement('div');
            form.className = 'rename-form';
            
            form.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Rename Playlist</h3>
                <input 
                    type="text" 
                    id="renameInput" 
                    value="${oldName}"
                    class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded mb-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white"
                    placeholder="Enter new name..."
                >
                <div class="flex gap-3 justify-end">
                    <button 
                        onclick="hideRenameForm()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="confirmRename('${escapeHtml(oldName)}')" 
                        class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors"
                    >
                        Rename
                    </button>
                </div>
            `;
            
            overlay.appendChild(form);
            document.body.appendChild(overlay);
            
            // Focus input and select text
            const input = document.getElementById('renameInput');
            input.focus();
            input.select();
            
            // Handle Enter key
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    confirmRename(oldName);
                }
            });
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideRenameForm();
                }
            });
        }

        function hideRenameForm() {
            const overlay = document.getElementById('renameOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function confirmRename(oldName) {
            const input = document.getElementById('renameInput');
            const newName = input.value.trim();
            
            if (!newName) {
                alert('Please enter a valid name');
                return;
            }
            
            if (newName === oldName) {
                hideRenameForm();
                return;
            }
            
            if (playlists[newName]) {
                alert('A playlist with this name already exists');
                return;
            }
            
            // Rename the playlist
            playlists[newName] = { ...playlists[oldName] };
            playlists[newName].name = newName;
            delete playlists[oldName];
            
            // Update current playlist if it was renamed
            if (currentPlaylist === oldName) {
                currentPlaylist = newName;
            }
            
            saveSettings();
            renderPlaylists();
            renderCurrentPlaylist();
            hideRenameForm();
        }

        // Merge Playlists Functions
        function showMergeDialog(targetPlaylist) {
            const playlistNames = Object.keys(playlists).filter(name => name !== targetPlaylist);
            
            if (playlistNames.length === 0) {
                alert('No other playlists available to merge');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'mergeOverlay';
            
            const form = document.createElement('div');
            form.className = 'rename-form';
            form.style.minWidth = '400px';
            
            form.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Merge Playlists</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Select playlists to merge into "${targetPlaylist}":
                </p>
                <div class="max-h-64 overflow-y-auto mb-4 space-y-2">
                    ${playlistNames.map(name => `
                        <label class="flex items-center gap-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded cursor-pointer">
                            <input type="checkbox" value="${name}" class="merge-checkbox">
                            <span class="flex-1">${name} (${playlists[name].videos.length} videos)</span>
                        </label>
                    `).join('')}
                </div>
                <div class="flex gap-3 justify-end">
                    <button 
                        onclick="hideMergeDialog()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="confirmMerge('${escapeHtml(targetPlaylist)}')" 
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                    >
                        Merge
                    </button>
                </div>
            `;
            
            overlay.appendChild(form);
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideMergeDialog();
                }
            });
        }

        function hideMergeDialog() {
            const overlay = document.getElementById('mergeOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function confirmMerge(targetPlaylist) {
            const checkboxes = document.querySelectorAll('.merge-checkbox:checked');
            const selectedPlaylists = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedPlaylists.length === 0) {
                alert('Please select at least one playlist to merge');
                return;
            }
            
            let totalVideos = 0;
            const allVideos = [...playlists[targetPlaylist].videos];
            const existingVideoIds = new Set(allVideos.map(v => v.id));
            
            // Merge videos from selected playlists
            selectedPlaylists.forEach(playlistName => {
                const videos = playlists[playlistName].videos;
                videos.forEach(video => {
                    if (!existingVideoIds.has(video.id)) {
                        allVideos.push(video);
                        existingVideoIds.add(video.id);
                        totalVideos++;
                    }
                });
                
                // Delete the merged playlist
                delete playlists[playlistName];
                
                // Clear current playlist if it was one of the merged ones
                if (currentPlaylist === playlistName) {
                    clearCurrentPlaylist();
                }
            });
            
            playlists[targetPlaylist].videos = allVideos;
            
            saveSettings();
            renderPlaylists();
            renderCurrentPlaylist();
            hideMergeDialog();
            
            alert(`Successfully merged ${selectedPlaylists.length} playlists. Added ${totalVideos} new videos to "${targetPlaylist}".`);
        }

        // Duplicate Playlist
        function duplicatePlaylist(playlistName) {
            let newName = `${playlistName} (Copy)`;
            let counter = 2;
            
            while (playlists[newName]) {
                newName = `${playlistName} (Copy ${counter})`;
                counter++;
            }
            
            playlists[newName] = {
                name: newName,
                videos: [...playlists[playlistName].videos],
                created: new Date().toISOString(),
                duplicatedFrom: playlistName
            };
            
            saveSettings();
            renderPlaylists();
        }

        // Show Playlist Info
        function showPlaylistInfo(playlistName) {
            const playlist = playlists[playlistName];
            const createdDate = new Date(playlist.created).toLocaleDateString();
            const remarks = playlist.remarks || '';
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'playlistInfoOverlay';
            
            const form = document.createElement('div');
            form.className = 'rename-form';
            form.style.minWidth = '400px';
            form.style.maxWidth = '500px';
            
            form.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">üìä Playlist Info</h3>
                
                <div class="space-y-3 mb-4">
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700 dark:text-gray-300">Name:</span>
                        <span class="text-gray-900 dark:text-white">${playlistName}</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700 dark:text-gray-300">Videos:</span>
                        <span class="text-gray-900 dark:text-white">${playlist.videos.length}</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700 dark:text-gray-300">Created:</span>
                        <span class="text-gray-900 dark:text-white">${createdDate}</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="font-medium text-gray-700 dark:text-gray-300">Source:</span>
                        <span class="text-gray-900 dark:text-white">${playlist.imported ? 'Imported from YouTube' : 'Created locally'}</span>
                    </div>
                    
                    ${playlist.duplicatedFrom ? `
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700 dark:text-gray-300">Duplicated from:</span>
                            <span class="text-gray-900 dark:text-white">${playlist.duplicatedFrom}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="mb-4">
                    <label class="block font-medium text-gray-700 dark:text-gray-300 mb-2">
                        üìù Remarks / Notes:
                    </label>
                    <textarea 
                        id="playlistRemarks" 
                        placeholder="Add your notes about this playlist..."
                        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white resize-vertical"
                        rows="4"
                        style="min-height: 80px; max-height: 200px;"
                    >${remarks}</textarea>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Use this space to add personal notes, descriptions, or reminders about this playlist.
                    </div>
                </div>
                
                <div class="flex gap-3 justify-end">
                    <button 
                        onclick="hidePlaylistInfo()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="savePlaylistRemarks('${escapeHtml(playlistName)}')" 
                        class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition-colors"
                    >
                        üíæ Save
                    </button>
                </div>
            `;
            
            overlay.appendChild(form);
            document.body.appendChild(overlay);
            
            // Focus the textarea
            const textarea = document.getElementById('playlistRemarks');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length); // Move cursor to end
            
            // Handle keyboard shortcuts
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hidePlaylistInfo();
                } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    // Ctrl+Enter or Cmd+Enter to save
                    savePlaylistRemarks(playlistName);
                }
            });
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hidePlaylistInfo();
                }
            });
        }

        function hidePlaylistInfo() {
            const overlay = document.getElementById('playlistInfoOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function savePlaylistRemarks(playlistName) {
            const textarea = document.getElementById('playlistRemarks');
            const remarks = textarea.value.trim();
            
            // Save remarks to playlist
            playlists[playlistName].remarks = remarks;
            
            saveSettings();
            hidePlaylistInfo();
            
            // Show brief success feedback
            const feedback = document.createElement('div');
            feedback.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity';
            feedback.textContent = '‚úÖ Remarks saved!';
            document.body.appendChild(feedback);
            
            // Auto-remove feedback after 2 seconds
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => feedback.remove(), 300);
            }, 2000);
        }

        // Drag and Drop Functions
        function handleDragStart(event, index) {
            if (isSelectionMode) {
                event.preventDefault();
                return;
            }
            
            draggedIndex = index;
            draggedElement = event.target;
            
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        }

        function handleDragOver(event) {
            if (isSelectionMode || draggedIndex === null) return;
            
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const rect = event.target.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            
            if (event.clientY < midpoint) {
                event.target.classList.add('drag-over');
            } else {
                event.target.classList.remove('drag-over');
            }
        }

        function handleDrop(event, dropIndex) {
            if (isSelectionMode || draggedIndex === null) return;
            
            event.preventDefault();
            
            if (draggedIndex === dropIndex) return;
            
            const videos = playlists[currentPlaylist].videos;
            const draggedVideo = videos[draggedIndex];
            
            // Remove dragged video
            videos.splice(draggedIndex, 1);
            
            // Adjust drop index if needed
            if (draggedIndex < dropIndex) {
                dropIndex--;
            }
            
            // Insert at new position
            videos.splice(dropIndex, 0, draggedVideo);
            
            // Update current video index if needed
            if (currentVideoIndex === draggedIndex) {
                currentVideoIndex = dropIndex;
            } else if (currentVideoIndex > draggedIndex && currentVideoIndex <= dropIndex) {
                currentVideoIndex--;
            } else if (currentVideoIndex < draggedIndex && currentVideoIndex >= dropIndex) {
                currentVideoIndex++;
            }
            
            saveSettings();
            renderCurrentPlaylist();
        }

        function handleDragEnd(event) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            
            // Remove all drag-over classes
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            draggedIndex = null;
            draggedElement = null;
        }

        // Selection Mode Functions
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            selectedVideos.clear();
            
            const container = document.getElementById('currentPlaylistVideos');
            const button = document.getElementById('playlistSelectButton');
            const controls = document.getElementById('selectionControls');
            
            if (isSelectionMode) {
                container.classList.add('selection-mode');
                button.textContent = 'Done';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
                controls.classList.remove('hidden');
            } else {
                container.classList.remove('selection-mode');
                button.textContent = 'Select';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                controls.classList.add('hidden');
            }
            
            renderCurrentPlaylist();
            updateSelectedCount();
        }

        function toggleVideoSelection(index) {
            if (!isSelectionMode) return;
            
            const checkbox = document.querySelector(`input[data-index="${index}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectedCount();
            }
        }

        function updateSelectedCount() {
            if (!isSelectionMode) return;
            
            const checkboxes = document.querySelectorAll('.video-checkbox:checked');
            selectedVideos = new Set(Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)));
            
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = selectedVideos.size;
            }
        }

        function selectAllVideos() {
            const checkboxes = document.querySelectorAll('.video-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        function deselectAllVideos() {
            const checkboxes = document.querySelectorAll('.video-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        // Bulk Operations
        function moveSelectedVideos() {
            if (selectedVideos.size === 0) {
                alert('Please select videos to move');
                return;
            }
            
            const playlistNames = Object.keys(playlists).filter(name => name !== currentPlaylist);
            
            if (playlistNames.length === 0) {
                alert('No other playlists available');
                return;
            }
            
            showMoveVideosDialog();
        }

        function copySelectedVideos() {
            if (selectedVideos.size === 0) {
                alert('Please select videos to copy');
                return;
            }
            
            const playlistNames = Object.keys(playlists).filter(name => name !== currentPlaylist);
            
            if (playlistNames.length === 0) {
                alert('No other playlists available');
                return;
            }
            
            showCopyVideosDialog();
        }

        // Move Videos Dialog
        function showMoveVideosDialog() {
            const playlistNames = Object.keys(playlists).filter(name => name !== currentPlaylist);
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'moveVideosOverlay';
            
            const form = document.createElement('div');
            form.className = 'rename-form';
            form.style.minWidth = '350px';
            
            form.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Move Videos</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Select playlist to move ${selectedVideos.size} selected videos to:
                </p>
                <div class="max-h-64 overflow-y-auto mb-4 space-y-2">
                    ${playlistNames.map(name => `
                        <label class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-600 rounded cursor-pointer border border-gray-200 dark:border-gray-600">
                            <input type="radio" name="targetPlaylist" value="${escapeHtml(name)}" class="move-radio">
                            <div class="flex-1">
                                <div class="font-medium">${name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${playlists[name].videos.length} videos</div>
                            </div>
                        </label>
                    `).join('')}
                </div>
                <div class="flex gap-3 justify-end">
                    <button 
                        onclick="hideMoveVideosDialog()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="confirmMoveVideos()" 
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                    >
                        üìÅ Move Videos
                    </button>
                </div>
            `;
            
            overlay.appendChild(form);
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideMoveVideosDialog();
                }
            });
        }

        function hideMoveVideosDialog() {
            const overlay = document.getElementById('moveVideosOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function confirmMoveVideos() {
            const selectedRadio = document.querySelector('input[name="targetPlaylist"]:checked');
            
            if (!selectedRadio) {
                alert('Please select a playlist');
                return;
            }
            
            const targetPlaylist = selectedRadio.value;
            
            const currentVideos = playlists[currentPlaylist].videos;
            const selectedIndices = Array.from(selectedVideos).sort((a, b) => b - a); // Sort descending
            const videosToMove = [];
            
            // Remove selected videos (in reverse order to maintain indices)
            selectedIndices.forEach(index => {
                videosToMove.push(currentVideos[index]);
                currentVideos.splice(index, 1);
            });
            
            // Add to target playlist
            playlists[targetPlaylist].videos.push(...videosToMove.reverse());
            
            // Adjust current video index
            let adjustment = 0;
            selectedIndices.forEach(index => {
                if (index <= currentVideoIndex) {
                    adjustment++;
                }
            });
            currentVideoIndex = Math.max(0, currentVideoIndex - adjustment);
            
            saveSettings();
            renderPlaylists();
            renderCurrentPlaylist();
            selectedVideos.clear();
            updateSelectedCount();
            hideMoveVideosDialog();
            
            alert(`Moved ${videosToMove.length} videos to "${targetPlaylist}"`);
        }

        // Copy Videos Dialog
        function showCopyVideosDialog() {
            const playlistNames = Object.keys(playlists).filter(name => name !== currentPlaylist);
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'copyVideosOverlay';
            
            const form = document.createElement('div');
            form.className = 'rename-form';
            form.style.minWidth = '350px';
            
            form.innerHTML = `
                <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Copy Videos</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Select playlist to copy ${selectedVideos.size} selected videos to:
                </p>
                <div class="max-h-64 overflow-y-auto mb-4 space-y-2">
                    ${playlistNames.map(name => `
                        <label class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-600 rounded cursor-pointer border border-gray-200 dark:border-gray-600">
                            <input type="radio" name="targetPlaylist" value="${escapeHtml(name)}" class="copy-radio">
                            <div class="flex-1">
                                <div class="font-medium">${name}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${playlists[name].videos.length} videos</div>
                            </div>
                        </label>
                    `).join('')}
                </div>
                <div class="flex gap-3 justify-end">
                    <button 
                        onclick="hideCopyVideosDialog()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="confirmCopyVideos()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                        üìã Copy Videos
                    </button>
                </div>
            `;
            
            overlay.appendChild(form);
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideCopyVideosDialog();
                }
            });
        }

        function hideCopyVideosDialog() {
            const overlay = document.getElementById('copyVideosOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function confirmCopyVideos() {
            const selectedRadio = document.querySelector('input[name="targetPlaylist"]:checked');
            
            if (!selectedRadio) {
                alert('Please select a playlist');
                return;
            }
            
            const targetPlaylist = selectedRadio.value;
            
            const currentVideos = playlists[currentPlaylist].videos;
            const videosToCopy = Array.from(selectedVideos).map(index => ({ ...currentVideos[index] }));
            
            // Add to target playlist (filter duplicates)
            const existingIds = new Set(playlists[targetPlaylist].videos.map(v => v.id));
            const newVideos = videosToCopy.filter(video => !existingIds.has(video.id));
            
            playlists[targetPlaylist].videos.push(...newVideos);
            
            saveSettings();
            renderPlaylists();
            selectedVideos.clear();
            updateSelectedCount();
            hideCopyVideosDialog();
            
            if (newVideos.length < videosToCopy.length) {
                alert(`Copied ${newVideos.length} videos to "${targetPlaylist}" (${videosToCopy.length - newVideos.length} duplicates skipped)`);
            } else {
                alert(`Copied ${newVideos.length} videos to "${targetPlaylist}"`);
            }
        }

        function deleteSelectedVideos() {
            if (selectedVideos.size === 0) {
                alert('Please select videos to delete');
                return;
            }
            
            if (!confirm(`Delete ${selectedVideos.size} selected videos?`)) {
                return;
            }
            
            const currentVideos = playlists[currentPlaylist].videos;
            const selectedIndices = Array.from(selectedVideos).sort((a, b) => b - a); // Sort descending
            
            // Remove selected videos (in reverse order to maintain indices)
            selectedIndices.forEach(index => {
                currentVideos.splice(index, 1);
            });
            
            // Adjust current video index
            let adjustment = 0;
            selectedIndices.forEach(index => {
                if (index <= currentVideoIndex) {
                    adjustment++;
                }
            });
            currentVideoIndex = Math.max(0, currentVideoIndex - adjustment);
            
            saveSettings();
            renderPlaylists();
            renderCurrentPlaylist();
            selectedVideos.clear();
            updateSelectedCount();
        }

        // Enhanced Touch Support for Video Items (Drag and Drop on Mobile)
        let videoDragData = {
            isDragging: false,
            startPos: { x: 0, y: 0 },
            currentIndex: -1,
            dragElement: null,
            dragThreshold: 15
        };

        function handleVideoTouchStart(event, index) {
            if (isSelectionMode) return;
            
            // Store initial touch data
            videoDragData.startPos = {
                x: event.touches[0].clientX,
                y: event.touches[0].clientY
            };
            videoDragData.currentIndex = index;
            videoDragData.dragElement = event.target.closest('.playlist-video-item');
            videoDragData.isDragging = false;
            
            // Prevent text selection
            event.preventDefault();
            
            // Add touch feedback
            videoDragData.dragElement?.classList.add('touch-active');
        }

        function handleVideoTouchMove(event, index) {
            if (isSelectionMode || videoDragData.currentIndex !== index) return;
            
            event.preventDefault(); // Prevent scrolling while dragging
            
            const currentPos = {
                x: event.touches[0].clientX,
                y: event.touches[0].clientY
            };
            
            const distance = Math.sqrt(
                Math.pow(currentPos.x - videoDragData.startPos.x, 2) +
                Math.pow(currentPos.y - videoDragData.startPos.y, 2)
            );
            
            // Start dragging if moved beyond threshold
            if (!videoDragData.isDragging && distance > videoDragData.dragThreshold) {
                videoDragData.isDragging = true;
                
                // Add dragging visual feedback
                videoDragData.dragElement?.classList.add('dragging');
                videoDragData.dragElement?.classList.remove('touch-active');
                
                // Add haptic feedback if available
                if (navigator.vibrate) {
                    navigator.vibrate(30);
                }
            }
            
            if (videoDragData.isDragging) {
                // Find the element under the touch point
                const elementBelow = document.elementFromPoint(currentPos.x, currentPos.y);
                const videoItemBelow = elementBelow?.closest('.playlist-video-item');
                
                // Remove drag-over class from all items
                document.querySelectorAll('.playlist-video-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                
                // Add drag-over class to target item
                if (videoItemBelow && videoItemBelow !== videoDragData.dragElement) {
                    videoItemBelow.classList.add('drag-over');
                }
            }
        }

        function handleVideoTouchEnd(event, index) {
            videoDragData.dragElement?.classList.remove('touch-active');
            
            if (videoDragData.isDragging && videoDragData.currentIndex === index) {
                // Find the drop target
                const lastTouchPos = {
                    x: event.changedTouches[0].clientX,
                    y: event.changedTouches[0].clientY
                };
                
                const elementBelow = document.elementFromPoint(lastTouchPos.x, lastTouchPos.y);
                const dropTarget = elementBelow?.closest('.playlist-video-item');
                
                if (dropTarget && dropTarget !== videoDragData.dragElement) {
                    const dropIndex = parseInt(dropTarget.dataset.index);
                    
                    if (!isNaN(dropIndex) && dropIndex !== index) {
                        // Perform the move operation
                        performVideoMove(index, dropIndex);
                        
                        // Add haptic feedback for successful drop
                        if (navigator.vibrate) {
                            navigator.vibrate([50, 30, 50]);
                        }
                    }
                }
                
                // Clean up dragging state
                videoDragData.dragElement?.classList.remove('dragging');
                document.querySelectorAll('.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
            }
            
            // Reset drag data
            videoDragData = {
                isDragging: false,
                startPos: { x: 0, y: 0 },
                currentIndex: -1,
                dragElement: null,
                dragThreshold: 15
            };
        }

        function performVideoMove(fromIndex, toIndex) {
            if (!currentPlaylist || fromIndex === toIndex) return;
            
            const videos = playlists[currentPlaylist].videos;
            const movedVideo = videos[fromIndex];
            
            // Remove the video from its current position
            videos.splice(fromIndex, 1);
            
            // Adjust the target index if needed
            let targetIndex = toIndex;
            if (fromIndex < toIndex) {
                targetIndex--;
            }
            
            // Insert the video at the new position
            videos.splice(targetIndex, 0, movedVideo);
            
            // Update current video index if needed
            if (currentVideoIndex === fromIndex) {
                currentVideoIndex = targetIndex;
            } else if (currentVideoIndex > fromIndex && currentVideoIndex <= toIndex) {
                currentVideoIndex--;
            } else if (currentVideoIndex < fromIndex && currentVideoIndex >= targetIndex) {
                currentVideoIndex++;
            }
            
            saveSettings();
            renderCurrentPlaylist();
        }

        // Format date helper
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 30) return `${diffDays} days ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return `${Math.floor(diffDays / 365)} years ago`;
        }
    </script>
</body>
</html>
