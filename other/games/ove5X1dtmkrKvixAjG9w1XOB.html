<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ®ºéŠæˆ²</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸº</text></svg>"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .double-tap {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        .role-card {
            transition: all 0.3s ease;
        }
        .role-hidden {
            background: #1f2937;
            color: #1f2937;
        }
        .role-revealed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .action-button {
            transition: all 0.2s ease;
        }
        .action-button:active {
            transform: scale(0.95);
        }
        .selected {
            background: #3b82f6 !important;
            color: white !important;
        }
        .phone-center {
            border: 2px dashed #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dot {
            transition: transform 0.2s;
        }

        .theme-toggle input:checked + .toggle-bg {
            background-color: #3b82f6;
        }

        .theme-toggle input:checked + .toggle-bg .dot {
            transform: translateX(24px);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- éŠæˆ²æ¨™é¡Œ -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">ğŸº ç‹¼äººæ®ºéŠæˆ²</h1>
            <div class="flex justify-center space-x-4">
                <button id="showPlayerManager" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition duration-200">
                    ğŸ‘¥ ç©å®¶ç®¡ç†
                </button>
                <button id="showSettings" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition duration-200">
                    âš™ï¸ éŠæˆ²è¨­ç½®
                </button>
            </div>
        </div>
        
        <!-- è¨­ç½®éšæ®µ -->
        <div id="setup" class="max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">éŠæˆ²è¨­ç½®</h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 dark:text-gray-300 mb-2">ç©å®¶æ•¸é‡</label>
                <select id="playerCount" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="6">6äºº</option>
                    <option value="7">7äºº</option>
                    <option value="8">8äºº</option>
                    <option value="9" selected="">9äºº</option>
                    <option value="10">10äºº</option>
                    <option value="11">11äºº</option>
                    <option value="12">12äºº</option>
                </select>
            </div>

            <!-- ç©å®¶é¸æ“‡ -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-gray-700 dark:text-gray-300">åƒèˆ‡ç©å®¶</label>
                    <div class="flex space-x-2">
                        <button id="addGuestPlayer" class="text-sm bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded transition duration-200">
                            â• è¨ªå®¢
                        </button>
                        <button id="autoSelectPlayers" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition duration-200">
                            è‡ªå‹•é¸æ“‡
                        </button>
                    </div>
                </div>
                <div id="playerSelectionGrid" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                    <!-- ç©å®¶é¸æ“‡åˆ—è¡¨ -->
                </div>
                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                    å·²é¸æ“‡: <span id="selectedPlayerCount">0</span> / <span id="requiredPlayerCount">9</span> äºº
                </div>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-gray-700 dark:text-gray-300">è§’è‰²é…ç½®</label>
                    <button id="useCustomConfig" class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded transition duration-200">
                        è‡ªè¨‚é…ç½®
                    </button>
                </div>
                <div id="roleConfig" class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                    <!-- å‹•æ…‹ç”Ÿæˆè§’è‰²é…ç½® -->
                </div>
            </div>
            
            <!-- è‡ªè¨‚è§’è‰²é…ç½® -->
            <div id="customRoleConfig" class="hidden mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">è‡ªè¨‚è§’è‰²é…ç½®</h3>
                <div class="space-y-3" id="roleInputs">
                    <!-- å‹•æ…‹ç”Ÿæˆè§’è‰²è¼¸å…¥ -->
                </div>
                <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
                    ç¸½è¨ˆ: <span id="totalPlayers">0</span> äºº
                </div>
                <div class="flex space-x-2 mt-3">
                    <button id="applyCustomConfig" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition duration-200">
                        å¥—ç”¨
                    </button>
                    <button id="cancelCustomConfig" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-200">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
            
            <div class="phone-center p-4 rounded-lg mb-4">
                <p class="text-center text-amber-700 dark:text-amber-300 text-sm">
                    ğŸ“± è«‹å°‡æ‰‹æ©Ÿæ”¾åœ¨æ‰€æœ‰ç©å®¶çš„æ­£ä¸­é–“ï¼Œæ–¹ä¾¿å¤§å®¶æ“ä½œ
                </p>
            </div>
            
            <button id="startGame" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                é–‹å§‹éŠæˆ²
            </button>
        </div>
        
        <!-- è§’è‰²åˆ†é…éšæ®µ -->
        <div id="roleAssignment" class="hidden max-w-md mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 text-center">è§’è‰²åˆ†é…</h2>
            <div class="text-center mb-6">
                <div class="flex items-center justify-center mb-4">
                    <img id="currentPlayerAvatar" class="player-avatar mr-3" src="" alt="">
                    <p class="text-gray-600 dark:text-gray-400">è«‹å°‡æ‰‹æ©Ÿäº¤çµ¦ <span id="currentPlayerText" class="font-bold text-blue-600">ç©å®¶</span></p>
                </div>
                <div class="role-card role-hidden double-tap w-full h-48 rounded-lg flex items-center justify-center mb-4 cursor-pointer" id="roleCard">
                    <p class="text-lg font-semibold">é›™æ“ŠæŸ¥çœ‹è§’è‰²</p>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400">æŸ¥çœ‹å®Œç•¢å¾Œé›™æ“Šéš±è—ï¼Œå†äº¤çµ¦ä¸‹ä¸€ä½ç©å®¶</p>
            </div>
            <button id="nextPlayer" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                ä¸‹ä¸€ä½ç©å®¶
            </button>
        </div>
        
        <!-- éŠæˆ²é€²è¡Œéšæ®µ -->
        <div id="gamePlay" class="hidden max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2">ç¬¬ <span id="dayCount">1</span> å¤©</h2>
                <p id="gamePhase" class="text-lg text-blue-600 font-medium">å¤œæ™šéšæ®µ</p>
            </div>
            
            <!-- ç©å®¶ç‹€æ…‹åˆ—è¡¨ -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">ç©å®¶ç‹€æ…‹</h3>
                    <button id="forceEndGame" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded transition duration-200">
                        å¼·åˆ¶çµæŸéŠæˆ²
                    </button>
                </div>
                <div id="playerList" class="grid grid-cols-2 gap-2">
                    <!-- å‹•æ…‹ç”Ÿæˆç©å®¶åˆ—è¡¨ -->
                </div>
            </div>
            
            <!-- å¤œæ™šæ“ä½œ -->
            <div id="nightActions" class="mb-6">
                <div class="text-center">
                    <p id="actionText" class="text-lg text-gray-700 dark:text-gray-300 mb-4">è«‹æ‰€æœ‰ç©å®¶é–‰çœ¼</p>
                    <div id="roleActionPanel" class="hidden mb-4">
                        <!-- è§’è‰²æŠ€èƒ½æ“ä½œé¢æ¿ -->
                    </div>
                    <button id="nextAction" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        ä¸‹ä¸€æ­¥
                    </button>
                    <div id="autoTimer" class="hidden mt-2 text-sm text-gray-500 dark:text-gray-400">
                        è‡ªå‹•é€²è¡Œä¸‹ä¸€æ­¥: <span id="countdown">2</span>ç§’
                    </div>
                </div>
            </div>
            
            <!-- ç™½å¤©è¨è«– -->
            <div id="dayDiscussion" class="hidden mb-6">
                <div class="text-center">
                    <p id="deathAnnouncement" class="text-lg text-gray-700 dark:text-gray-300 mb-4"></p>
                    <div id="hunterAction" class="hidden mb-4">
                        <p class="text-red-600 font-semibold mb-3">çµäººæ­»äº¡ï¼Œè«‹é¸æ“‡è¦é–‹æ§çš„ç›®æ¨™</p>
                        <div id="hunterTargets" class="grid grid-cols-3 gap-2 mb-3">
                            <!-- çµäººé–‹æ§ç›®æ¨™ -->
                        </div>
                        <button id="skipHunterShot" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition duration-200">
                            ä¸é–‹æ§
                        </button>
                    </div>
                    <p class="text-md text-gray-600 dark:text-gray-400 mb-4">è«‹ç©å®¶å€‘é€²è¡Œè¨è«–</p>
                    <button id="startVoting" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        é–‹å§‹æŠ•ç¥¨
                    </button>
                </div>
            </div>
            
            <!-- æŠ•ç¥¨éšæ®µ -->
            <div id="votingPhase" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 text-center">
                    è«‹ <span id="currentVoterText" class="text-blue-600">ç©å®¶</span> æŠ•ç¥¨
                </h3>
                <div id="votingOptions" class="grid grid-cols-2 gap-3 mb-4">
                    <!-- å‹•æ…‹ç”ŸæˆæŠ•ç¥¨é¸é … -->
                </div>
                <button id="skipVote" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 mb-2">
                    è·³éæŠ•ç¥¨
                </button>
                <button id="nextVoter" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                    ä¸‹ä¸€ä½ç©å®¶
                </button>
            </div>

            <!-- éºè¨€éšæ®µ -->
            <div id="lastWordsPhase" class="hidden">
                <div class="text-center">
                    <div class="flex items-center justify-center mb-4">
                        <img id="lastWordsPlayerAvatar" class="player-avatar mr-3" src="" alt="">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">
                            <span id="lastWordsPlayerName" class="text-red-600">ç©å®¶</span> è«‹èªªéºè¨€
                        </h3>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">è«‹è¢«æŠ•ç¥¨å‡ºå±€çš„ç©å®¶èªªå‡ºéºè¨€</p>
                    <button id="finishLastWords" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        éºè¨€å®Œç•¢
                    </button>
                </div>
            </div>
        </div>
        
        <!-- éŠæˆ²çµæŸ -->
        <div id="gameEnd" class="hidden max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-center text-gray-800 dark:text-white mb-4">éŠæˆ²çµæŸ</h2>
            <div id="winnerAnnouncement" class="text-center mb-6">
                <!-- å‹åˆ©å…¬å‘Š -->
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">è§’è‰²æ­æ›‰èˆ‡ç©åˆ†çµç®—</h3>
                <div id="finalRoles" class="space-y-2">
                    <!-- æœ€çµ‚è§’è‰²åˆ—è¡¨ -->
                </div>
            </div>
            <button id="restartGame" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                é‡æ–°é–‹å§‹
            </button>
        </div>
    </div>

    <!-- ç©å®¶ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="playerManagerModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">ğŸ‘¥ ç©å®¶ç®¡ç†</h2>
                    <button id="closePlayerManager" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        âœ•
                    </button>
                </div>
                
                <div class="mb-4">
                    <button id="addPlayerBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition duration-200">
                        â• æ·»åŠ ç©å®¶
                    </button>
                </div>
                
                <div id="playerManagerList" class="space-y-3">
                    <!-- ç©å®¶åˆ—è¡¨ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç©å®¶ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="playerEditModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="playerEditTitle" class="text-xl font-semibold text-gray-800 dark:text-white">ç·¨è¼¯ç©å®¶</h2>
                    <button id="closePlayerEdit" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        âœ•
                    </button>
                </div>
                
                <form id="playerEditForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 mb-2">ç©å®¶å§“å</label>
                        <input type="text" id="playerNameInput" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required="">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 mb-2">é ­åƒ</label>
                        <div class="flex items-center space-x-4">
                            <img id="playerAvatarPreview" class="player-avatar" src="" alt="é è¦½">
                            <input type="file" id="playerAvatarInput" accept="image/*" class="text-sm text-gray-500 dark:text-gray-400">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 mb-2">ç©åˆ†</label>
                        <input type="number" id="playerScoreInput" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="0">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition duration-200">
                            ä¿å­˜
                        </button>
                        <button type="button" id="cancelPlayerEdit" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-200">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²è¨­ç½®æ¨¡æ…‹æ¡† -->
    <div id="settingsModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">âš™ï¸ éŠæˆ²è¨­ç½®</h2>
                    <button id="closeSettings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        âœ•
                    </button>
                </div>
                
                <form id="settingsForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 mb-2">å…¥å ´ç©åˆ†</label>
                        <input type="number" id="entryPointsInput" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="0" value="10">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">åƒèˆ‡éŠæˆ²éœ€è¦æ‰£é™¤çš„ç©åˆ†</p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 mb-2">ç²å‹ç©åˆ†</label>
                        <input type="number" id="winPointsInput" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="0" value="20">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">ç²å‹ç©å®¶ç²å¾—çš„ç©åˆ†</p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 mb-2">å¤±æ•—ç©åˆ†</label>
                        <input type="number" id="losePointsInput" class="w-full p-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="0" value="5">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">å¤±æ•—ç©å®¶æ‰£é™¤çš„é¡å¤–ç©åˆ†</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition duration-200">
                            ä¿å­˜
                        </button>
                        <button type="button" id="cancelSettings" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-200">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- è¨ªå®¢ç©å®¶æ¨¡æ…‹æ¡† -->
    <div id="guestPlayerModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">ğŸ® æ·»åŠ è¨ªå®¢ç©å®¶</h2>
                    <button id="closeGuestPlayer" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        âœ•
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-300 mb-2">
                            å°‡æ·»åŠ ï¼š<span id="nextGuestName">è¨ªå®¢1</span>
                        </h3>
                        <p class="text-sm text-blue-600 dark:text-blue-400">
                            ç³»çµ±æœƒè‡ªå‹•å‘½åè¨ªå®¢ç©å®¶
                        </p>
                    </div>
                    
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg">
                        <p class="text-sm text-orange-700 dark:text-orange-300">
                            ğŸ’¡ è¨ªå®¢ç©å®¶ä¸æœƒä¿å­˜æª”æ¡ˆï¼Œä¹Ÿä¸åƒèˆ‡ç©åˆ†çµç®—
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button id="confirmAddGuest" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded transition duration-200">
                            æ·»åŠ è¨ªå®¢
                        </button>
                        <button id="cancelGuestPlayer" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-200">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æœ¬åœ°å­˜å„²ç®¡ç†
        const Storage = {
            getPlayers: () => JSON.parse(localStorage.getItem('werewolf_players') || '[]'),
            savePlayers: (players) => localStorage.setItem('werewolf_players', JSON.stringify(players)),
            getSettings: () => JSON.parse(localStorage.getItem('werewolf_settings') || '{"entryPoints": 10, "winPoints": 20, "losePoints": 5}'),
            saveSettings: (settings) => localStorage.setItem('werewolf_settings', JSON.stringify(settings))
        };

        // éŠæˆ²ç‹€æ…‹ç®¡ç†
        let gameState = {
            players: [],
            selectedPlayers: [],
            currentPlayer: 0,
            currentVoter: 0,
            day: 1,
            phase: 'setup',
            nightActionIndex: 0,
            votes: {},
            selectedVote: null,
            votingResult: null,
            nightActions: {
                guardTarget: null,
                werewolfTarget: null,
                witchSave: false,
                witchPoison: null,
                seerTarget: null,
                witchUsedPotion: false,
                witchUsedPoison: false,
                bakerMark: null,
                littleGirlCaught: false
            },
            customConfig: null
        };

        // è§’è‰²å®šç¾©
        const roles = {
            'ç‹¼äºº': { team: 'werewolf', description: 'å¤œæ™šå¯ä»¥æ®ºå®³ä¸€åç©å®¶', emoji: 'ğŸº' },
            'æ‘æ°‘': { team: 'villager', description: 'å–„è‰¯çš„æ‘æ°‘ï¼Œæ²’æœ‰ç‰¹æ®Šèƒ½åŠ›', emoji: 'ğŸ‘¨' },
            'é è¨€å®¶': { team: 'villager', description: 'å¤œæ™šå¯ä»¥æŸ¥é©—ä¸€åç©å®¶çš„èº«ä»½', emoji: 'ğŸ”®' },
            'å¥³å·«': { team: 'villager', description: 'æ“æœ‰ä¸€ç“¶è§£è—¥å’Œä¸€ç“¶æ¯’è—¥', emoji: 'ğŸ§™â€â™€ï¸' },
            'çµäºº': { team: 'villager', description: 'æ­»äº¡æ™‚å¯ä»¥é–‹æ§å¸¶èµ°ä¸€åç©å®¶', emoji: 'ğŸ¹' },
            'å®ˆè¡›': { team: 'villager', description: 'å¤œæ™šå¯ä»¥å®ˆè­·ä¸€åç©å®¶', emoji: 'ğŸ›¡ï¸' },
            'å°å¥³å­©': { team: 'villager', description: 'ç‹¼äººæ®ºäººæ™‚å¯å·çœ‹ï¼Œä½†è¢«ç™¼ç¾æœƒæ­»äº¡', emoji: 'ğŸ‘§' },
            'éºµåŒ…å¸«å‚…': { team: 'villager', description: 'å¤œæ™šæ¨™è¨˜ç©å®¶ï¼Œé™åˆ¶ç‹¼äººæ”»æ“Šç¯„åœ', emoji: 'ğŸ' }
        };

        // é è¨­è§’è‰²é…ç½®
        const defaultRoleConfigs = {
            6: { 'ç‹¼äºº': 2, 'æ‘æ°‘': 2, 'é è¨€å®¶': 1, 'å¥³å·«': 1 },
            7: { 'ç‹¼äºº': 2, 'æ‘æ°‘': 3, 'é è¨€å®¶': 1, 'å¥³å·«': 1 },
            8: { 'ç‹¼äºº': 2, 'æ‘æ°‘': 2, 'é è¨€å®¶': 1, 'å¥³å·«': 1, 'çµäºº': 1, 'å°å¥³å­©': 1 },
            9: { 'ç‹¼äºº': 3, 'æ‘æ°‘': 2, 'é è¨€å®¶': 1, 'å¥³å·«': 1, 'çµäºº': 1, 'å°å¥³å­©': 1 },
            10: { 'ç‹¼äºº': 3, 'æ‘æ°‘': 2, 'é è¨€å®¶': 1, 'å¥³å·«': 1, 'çµäºº': 1, 'å®ˆè¡›': 1, 'éºµåŒ…å¸«å‚…': 1 },
            11: { 'ç‹¼äºº': 3, 'æ‘æ°‘': 3, 'é è¨€å®¶': 1, 'å¥³å·«': 1, 'çµäºº': 1, 'å®ˆè¡›': 1, 'å°å¥³å­©': 1 },
            12: { 'ç‹¼äºº': 4, 'æ‘æ°‘': 2, 'é è¨€å®¶': 1, 'å¥³å·«': 1, 'çµäºº': 1, 'å®ˆè¡›': 1, 'å°å¥³å­©': 1, 'éºµåŒ…å¸«å‚…': 1 }
        };

        let isSpeaking = false;

        // TTS èªéŸ³åˆæˆ (å¸¶åŒæ­¥åŠŸèƒ½)
        function speak(text, lang = 'zh-HK') {
            return new Promise((resolve) => {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    
                    isSpeaking = true;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    
                    const voices = speechSynthesis.getVoices();
                    const cantonese = voices.find(voice => 
                        voice.lang.includes('zh-HK') || 
                        voice.lang.includes('yue') ||
                        voice.name.toLowerCase().includes('cantonese')
                    );
                    
                    if (cantonese) {
                        utterance.voice = cantonese;
                    }
                    
                    utterance.onend = () => {
                        isSpeaking = false;
                        resolve();
                    };
                    
                    utterance.onerror = () => {
                        isSpeaking = false;
                        resolve();
                    };
                    
                    speechSynthesis.speak(utterance);
                } else {
                    resolve();
                }
            });
        }

        // ç©å®¶ç®¡ç†åŠŸèƒ½
        function showPlayerManager() {
            document.getElementById('playerManagerModal').classList.remove('hidden');
            loadPlayerList();
        }

        function hidePlayerManager() {
            document.getElementById('playerManagerModal').classList.add('hidden');
        }

        function loadPlayerList() {
            const players = Storage.getPlayers();
            const list = document.getElementById('playerManagerList');
            
            if (players.length === 0) {
                list.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">æš«ç„¡ç©å®¶è³‡æ–™</p>';
                return;
            }
            
            list.innerHTML = players.map(player => `
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center">
                        <img src="${player.avatar || createDefaultAvatar(player.name)}" class="player-avatar mr-3" alt="">
                        <div>
                            <h3 class="font-semibold text-gray-800 dark:text-white">${player.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">ç©åˆ†: ${player.score}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editPlayer('${player.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            ç·¨è¼¯
                        </button>
                        <button onclick="deletePlayer('${player.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function createDefaultAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 80;
            const ctx = canvas.getContext('2d');
            
            // ç”ŸæˆèƒŒæ™¯é¡è‰²
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
            const bgColor = colors[name.charCodeAt(0) % colors.length];
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, 80, 80);
            
            // æ·»åŠ æ–‡å­—
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(name.charAt(0), 40, 40);
            
            return canvas.toDataURL();
        }

        function showPlayerEdit(playerId = null) {
            const modal = document.getElementById('playerEditModal');
            const title = document.getElementById('playerEditTitle');
            const form = document.getElementById('playerEditForm');
            
            form.dataset.playerId = playerId || '';
            
            if (playerId) {
                const player = Storage.getPlayers().find(p => p.id === playerId);
                title.textContent = 'ç·¨è¼¯ç©å®¶';
                document.getElementById('playerNameInput').value = player.name;
                document.getElementById('playerScoreInput').value = player.score;
                document.getElementById('playerAvatarPreview').src = player.avatar || createDefaultAvatar(player.name);
            } else {
                title.textContent = 'æ·»åŠ ç©å®¶';
                form.reset();
                document.getElementById('playerScoreInput').value = 100;
                document.getElementById('playerAvatarPreview').src = '';
            }
            
            modal.classList.remove('hidden');
        }

        function hidePlayerEdit() {
            document.getElementById('playerEditModal').classList.add('hidden');
        }

        function editPlayer(playerId) {
            showPlayerEdit(playerId);
        }

        function deletePlayer(playerId) {
            showConfirmDialog('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç©å®¶å—ï¼Ÿ', () => {
                const players = Storage.getPlayers().filter(p => p.id !== playerId);
                Storage.savePlayers(players);
                loadPlayerList();
                updatePlayerSelection();
            });
        }

        function savePlayer(event) {
            event.preventDefault();
            
            const form = event.target;
            const playerId = form.dataset.playerId;
            const name = document.getElementById('playerNameInput').value.trim();
            const score = parseInt(document.getElementById('playerScoreInput').value) || 100;
            const avatarFile = document.getElementById('playerAvatarInput').files[0];
            
            if (!name) {
                showAlert('è«‹è¼¸å…¥ç©å®¶å§“å');
                return;
            }
            
            const players = Storage.getPlayers();
            
            // æª¢æŸ¥é‡è¤‡åç¨±
            const existingPlayer = players.find(p => p.name === name && p.id !== playerId);
            if (existingPlayer) {
                showAlert('ç©å®¶å§“åå·²å­˜åœ¨');
                return;
            }
            
            if (avatarFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    savePlayerData(playerId, name, score, e.target.result);
                };
                reader.readAsDataURL(avatarFile);
            } else {
                const existingAvatar = playerId ? players.find(p => p.id === playerId)?.avatar : null;
                savePlayerData(playerId, name, score, existingAvatar || createDefaultAvatar(name));
            }
        }

        function savePlayerData(playerId, name, score, avatar) {
            const players = Storage.getPlayers();
            
            if (playerId) {
                const index = players.findIndex(p => p.id === playerId);
                players[index] = { ...players[index], name, score, avatar };
            } else {
                const newPlayer = {
                    id: Date.now().toString(),
                    name,
                    score,
                    avatar
                };
                players.push(newPlayer);
            }
            
            Storage.savePlayers(players);
            hidePlayerEdit();
            loadPlayerList();
            updatePlayerSelection();
        }

        // è¨­ç½®ç®¡ç†
        function showSettings() {
            const settings = Storage.getSettings();
            document.getElementById('entryPointsInput').value = settings.entryPoints;
            document.getElementById('winPointsInput').value = settings.winPoints;
            document.getElementById('losePointsInput').value = settings.losePoints;
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function hideSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings(event) {
            event.preventDefault();
            
            const entryPoints = document.getElementById('entryPointsInput').value;
            const winPoints = document.getElementById('winPointsInput').value;
            const losePoints = document.getElementById('losePointsInput').value;
            
            const settings = {
                entryPoints: entryPoints === '' ? 10 : parseInt(entryPoints),
                winPoints: winPoints === '' ? 20 : parseInt(winPoints),
                losePoints: losePoints === '' ? 5 : parseInt(losePoints)
            };
            
            Storage.saveSettings(settings);
            hideSettings();
            showAlert('è¨­ç½®å·²ä¿å­˜');
        }

        // ç©å®¶é¸æ“‡åŠŸèƒ½ï¼ˆåŒ…å«è¨ªå®¢æ”¯æŒï¼‰
        function updatePlayerSelection() {
            const players = Storage.getPlayers();
            const grid = document.getElementById('playerSelectionGrid');
            const requiredCount = parseInt(document.getElementById('playerCount').value);
            
            document.getElementById('requiredPlayerCount').textContent = requiredCount;
            
            // åˆä½µæ­£å¼ç©å®¶å’Œè¨ªå®¢ç©å®¶
            const allPlayerItems = [];
            
            // æ·»åŠ æ­£å¼ç©å®¶
            players.forEach(player => {
                allPlayerItems.push({
                    id: player.id,
                    name: player.name,
                    avatar: player.avatar || createDefaultAvatar(player.name),
                    info: `${player.score}åˆ†`,
                    isGuest: false
                });
            });
            
            // æ·»åŠ å·²é¸ä¸­çš„è¨ªå®¢ç©å®¶
            gameState.selectedPlayers.forEach(playerId => {
                if (playerId.startsWith('guest_')) {
                    const guestData = gameState.guestPlayers?.[playerId];
                    if (guestData) {
                        allPlayerItems.push({
                            id: guestData.id,
                            name: guestData.name,
                            avatar: guestData.avatar,
                            info: 'è¨ªå®¢',
                            isGuest: true
                        });
                    }
                }
            });
            
            if (allPlayerItems.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center col-span-2">è«‹å…ˆæ·»åŠ ç©å®¶è³‡æ–™æˆ–è¨ªå®¢</p>';
                return;
            }
            
            grid.innerHTML = allPlayerItems.map(player => `
                <div class="player-selection-item flex items-center p-2 border border-gray-300 dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 ${gameState.selectedPlayers.includes(player.id) ? 'bg-blue-100 dark:bg-blue-800 border-blue-500' : ''}" 
                     data-player-id="${player.id}">
                    <img src="${player.avatar}" class="w-8 h-8 rounded-full mr-2" alt="">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${player.name} ${player.isGuest ? 'ğŸ‘¤' : ''}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${player.info}</p>
                    </div>
                    ${player.isGuest ? `
                        <button onclick="removeGuestPlayer('${player.id}')" class="ml-2 text-red-500 hover:text-red-700 text-xs" title="ç§»é™¤è¨ªå®¢">
                            âœ•
                        </button>
                    ` : ''}
                </div>
            `).join('');
            
            // æ·»åŠ é»æ“Šäº‹ä»¶
            grid.querySelectorAll('.player-selection-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // å¦‚æœé»æ“Šçš„æ˜¯ç§»é™¤æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œé¸æ“‡é‚è¼¯
                    if (e.target.tagName === 'BUTTON') {
                        return;
                    }
                    const playerId = this.dataset.playerId;
                    togglePlayerSelection(playerId);
                });
            });
            
            updateSelectedPlayerCount();
        }

        function togglePlayerSelection(playerId) {
            const requiredCount = parseInt(document.getElementById('playerCount').value);
            const index = gameState.selectedPlayers.indexOf(playerId);
            
            if (index === -1) {
                if (gameState.selectedPlayers.length < requiredCount) {
                    gameState.selectedPlayers.push(playerId);
                }
            } else {
                gameState.selectedPlayers.splice(index, 1);
            }
            
            updatePlayerSelection();
        }

        function updateSelectedPlayerCount() {
            document.getElementById('selectedPlayerCount').textContent = gameState.selectedPlayers.length;
        }

        function autoSelectPlayers() {
            const players = Storage.getPlayers();
            const requiredCount = parseInt(document.getElementById('playerCount').value);
            
            if (players.length < requiredCount) {
                showAlert(`ç©å®¶æ•¸é‡ä¸è¶³ï¼Œéœ€è¦${requiredCount}äººï¼Œç›®å‰åªæœ‰${players.length}äºº`);
                return;
            }
            
            // éš¨æ©Ÿé¸æ“‡ç©å®¶
            const shuffled = [...players].sort(() => Math.random() - 0.5);
            gameState.selectedPlayers = shuffled.slice(0, requiredCount).map(p => p.id);
            updatePlayerSelection();
        }

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            updateRoleConfig();
            updatePlayerSelection();
            setupCustomConfigEvents();
            setupEventListeners();
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // ç©å®¶ç®¡ç†
            document.getElementById('showPlayerManager').addEventListener('click', showPlayerManager);
            document.getElementById('closePlayerManager').addEventListener('click', hidePlayerManager);
            document.getElementById('addPlayerBtn').addEventListener('click', () => showPlayerEdit());
            document.getElementById('playerEditForm').addEventListener('submit', savePlayer);
            document.getElementById('cancelPlayerEdit').addEventListener('click', hidePlayerEdit);
            document.getElementById('closePlayerEdit').addEventListener('click', hidePlayerEdit);
            
            // é ­åƒé è¦½
            document.getElementById('playerAvatarInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('playerAvatarPreview').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // è¨­ç½®ç®¡ç†
            document.getElementById('showSettings').addEventListener('click', showSettings);
            document.getElementById('closeSettings').addEventListener('click', hideSettings);
            document.getElementById('settingsForm').addEventListener('submit', saveSettings);
            document.getElementById('cancelSettings').addEventListener('click', hideSettings);
            
            // è¨ªå®¢ç©å®¶
            document.getElementById('addGuestPlayer').addEventListener('click', showGuestPlayer);
            document.getElementById('closeGuestPlayer').addEventListener('click', hideGuestPlayer);
            document.getElementById('confirmAddGuest').addEventListener('click', addGuestPlayer);
            document.getElementById('cancelGuestPlayer').addEventListener('click', hideGuestPlayer);
            
            // ç©å®¶é¸æ“‡
            document.getElementById('autoSelectPlayers').addEventListener('click', autoSelectPlayers);
            document.getElementById('playerCount').addEventListener('change', function() {
                gameState.selectedPlayers = [];
                updateRoleConfig();
                updatePlayerSelection();
            });
            
            // éŠæˆ²æ§åˆ¶
            document.getElementById('startGame').addEventListener('click', startGame);
            document.getElementById('nextPlayer').addEventListener('click', nextPlayer);
            document.getElementById('nextAction').addEventListener('click', nextNightAction);
            document.getElementById('startVoting').addEventListener('click', startVoting);
            document.getElementById('skipVote').addEventListener('click', skipVote);
            document.getElementById('nextVoter').addEventListener('click', nextVoter);
            document.getElementById('finishLastWords').addEventListener('click', finishLastWords);
            document.getElementById('restartGame').addEventListener('click', restartGame);
            document.getElementById('forceEndGame').addEventListener('click', forceEndGame);
            
            // è§’è‰²å¡ç‰‡
            let tapCount = 0;
            let tapTimer = null;
            document.getElementById('roleCard').addEventListener('click', function() {
                tapCount++;
                if (tapCount === 1) {
                    tapTimer = setTimeout(() => {
                        tapCount = 0;
                    }, 300);
                } else if (tapCount === 2) {
                    clearTimeout(tapTimer);
                    tapCount = 0;
                    toggleRoleCard();
                }
            });
        }

        // è¨­ç½®è‡ªè¨‚é…ç½®äº‹ä»¶
        function setupCustomConfigEvents() {
            document.getElementById('useCustomConfig').addEventListener('click', showCustomConfig);
            document.getElementById('applyCustomConfig').addEventListener('click', applyCustomConfig);
            document.getElementById('cancelCustomConfig').addEventListener('click', hideCustomConfig);
        }

        // å…¶ä»–éŠæˆ²åŠŸèƒ½ä¿æŒåŸæ¨£ï¼Œä½†éœ€è¦ä¿®æ”¹æŠ•ç¥¨çµæœè™•ç†
        function processVotingResult() {
            let maxVotes = 0;
            let votedOut = [];
            
            for (const [playerId, votes] of Object.entries(gameState.votes)) {
                if (votes > maxVotes) {
                    maxVotes = votes;
                    votedOut = [parseInt(playerId)];
                } else if (votes === maxVotes && votes > 0) {
                    votedOut.push(parseInt(playerId));
                }
            }
            
            let resultMessage = '';
            if (votedOut.length === 1 && maxVotes > 0) {
                const players = Storage.getPlayers();
                const playerData = players.find(p => p.id === gameState.selectedPlayers[votedOut[0] - 1]);
                resultMessage = `æŠ•ç¥¨çµæœï¼š${playerData?.name || votedOut[0] + 'è™Ÿ'}ç©å®¶è¢«æ·˜æ±°`;
                gameState.votingResult = votedOut[0];
            } else {
                resultMessage = 'æŠ•ç¥¨å¹³ç¥¨ï¼Œæœ¬è¼ªç„¡äººè¢«æ·˜æ±°';
                gameState.votingResult = null;
            }
            
            // éš±è—æŠ•ç¥¨ç•Œé¢ï¼Œé¡¯ç¤ºæŠ•ç¥¨çµæœä¸¦æ’­å ±
            document.getElementById('votingPhase').classList.add('hidden');
            
            // æ’­å ±æŠ•ç¥¨çµæœï¼Œå¿…é ˆæ’­å ±å®Œæˆæ‰èƒ½ç¹¼çºŒ
            speak(resultMessage).then(() => {
                if (gameState.votingResult) {
                    // æœ‰äººè¢«æŠ•ç¥¨å‡ºå±€ï¼Œé€²å…¥éºè¨€éšæ®µ
                    showLastWordsPhase();
                } else {
                    // ç„¡äººå‡ºå±€ï¼Œç›´æ¥é€²å…¥ä¸‹ä¸€å¤©
                    continueToNextDay();
                }
            });
        }

        function showLastWordsPhase() {
            const votedOutIndex = gameState.votingResult - 1;
            const players = Storage.getPlayers();
            const playerData = players.find(p => p.id === gameState.selectedPlayers[votedOutIndex]);
            
            document.getElementById('lastWordsPhase').classList.remove('hidden');
            document.getElementById('lastWordsPlayerName').textContent = playerData?.name || `${gameState.votingResult}è™Ÿ`;
            document.getElementById('lastWordsPlayerAvatar').src = playerData?.avatar || createDefaultAvatar(playerData?.name || '');
            
            speak(`è«‹${playerData?.name || gameState.votingResult + 'è™Ÿ'}ç©å®¶èªªéºè¨€`);
        }

        function finishLastWords() {
            // æ¨™è¨˜ç©å®¶æ­»äº¡
            const player = gameState.players.find(p => p.id === gameState.votingResult);
            if (player) {
                player.alive = false;
            }
            
            document.getElementById('lastWordsPhase').classList.add('hidden');
            
            if (checkGameEnd()) {
                return;
            }
            
            continueToNextDay();
        }

        // çµç®—ç©åˆ†
        function calculateScores(winningTeam) {
            const settings = Storage.getSettings();
            const players = Storage.getPlayers();
            const scoreChanges = [];
            
            gameState.players.forEach((gamePlayer, index) => {
                const playerId = gameState.selectedPlayers[index];
                const playerData = players.find(p => p.id === playerId);
                
                if (playerData) {
                    let scoreChange = -settings.entryPoints; // å…¥å ´è²»
                    
                    if (gamePlayer.team === winningTeam) {
                        scoreChange += settings.winPoints; // ç²å‹çå‹µ
                    } else {
                        scoreChange -= settings.losePoints; // å¤±æ•—æ‡²ç½°
                    }
                    
                    playerData.score = Math.max(0, playerData.score + scoreChange);
                    scoreChanges.push({
                        name: playerData.name,
                        role: gamePlayer.role,
                        change: scoreChange,
                        newScore: playerData.score
                    });
                }
            });
            
            Storage.savePlayers(players);
            return scoreChanges;
        }

        // ä¿®æ”¹çµæŸéŠæˆ²å‡½æ•¸
        function endGame(winner) {
            gameState.phase = 'ended';
            
            document.getElementById('gamePlay').classList.add('hidden');
            document.getElementById('gameEnd').classList.remove('hidden');
            
            const winningTeam = winner.includes('å¥½äºº') ? 'villager' : 'werewolf';
            const scoreChanges = calculateScores(winningTeam);
            
            document.getElementById('winnerAnnouncement').innerHTML = 
                `<h3 class="text-xl font-bold text-green-600 mb-2">${winner}å‹åˆ©ï¼</h3>`;
            
            const finalRoles = document.getElementById('finalRoles');
            finalRoles.innerHTML = scoreChanges.map(change => `
                <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded">
                    <div class="flex items-center">
                        <span class="font-semibold mr-2">${change.name}</span>
                        <span class="text-blue-600 dark:text-blue-400">${roles[change.role].emoji} ${change.role}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-sm ${change.change >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${change.change >= 0 ? '+' : ''}${change.change}
                        </span>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            ç¸½åˆ†: ${change.newScore}
                        </div>
                    </div>
                </div>
            `).join('');
            
            speak(`éŠæˆ²çµæŸï¼Œ${winner}å‹åˆ©`);
        }

        // å…¶ä»–å‡½æ•¸ä¿æŒåŸæ¨£ï¼Œåªéœ€è¦è£œå……å‰©é¤˜çš„æ ¸å¿ƒéŠæˆ²é‚è¼¯
        function showCustomConfig() {
            document.getElementById('customRoleConfig').classList.remove('hidden');
            updateRoleInputs();
        }

        function hideCustomConfig() {
            document.getElementById('customRoleConfig').classList.add('hidden');
        }

        function updateRoleInputs() {
            const roleInputs = document.getElementById('roleInputs');
            roleInputs.innerHTML = '';
            
            Object.keys(roles).forEach(role => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                div.innerHTML = `
                    <span class="text-gray-700 dark:text-gray-300">${roles[role].emoji} ${role}</span>
                    <input type="number" min="0" max="12" value="0" 
                           class="w-16 p-2 text-base border border-gray-300 dark:border-gray-600 rounded 
                                  bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           data-role="${role}">
                `;
                roleInputs.appendChild(div);
            });
            
            roleInputs.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateTotalPlayers);
            });
        }

        function updateTotalPlayers() {
            const inputs = document.querySelectorAll('#roleInputs input');
            let total = 0;
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            document.getElementById('totalPlayers').textContent = total;
        }

        function applyCustomConfig() {
            const inputs = document.querySelectorAll('#roleInputs input');
            const config = {};
            let total = 0;
            
            inputs.forEach(input => {
                const role = input.getAttribute('data-role');
                const count = parseInt(input.value) || 0;
                if (count > 0) {
                    config[role] = count;
                    total += count;
                }
            });
            
            if (total < 3) {
                showAlert('ç©å®¶ç¸½æ•¸ä¸èƒ½å°‘æ–¼3äºº');
                return;
            }
            
            const werewolfCount = config['ç‹¼äºº'] || 0;
            const villagerCount = total - werewolfCount;
            
            if (werewolfCount === 0) {
                showAlert('å¿…é ˆè‡³å°‘æœ‰1å€‹ç‹¼äºº');
                return;
            }
            
            if (werewolfCount >= villagerCount) {
                showAlert('ç‹¼äººæ•¸é‡ä¸èƒ½å¤§æ–¼ç­‰æ–¼å¥½äººæ•¸é‡');
                return;
            }
            
            gameState.customConfig = config;
            document.getElementById('playerCount').value = Math.min(total, 12);
            gameState.selectedPlayers = [];
            updateRoleConfig();
            updatePlayerSelection();
            hideCustomConfig();
        }

        function updateRoleConfig() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const config = gameState.customConfig || defaultRoleConfigs[playerCount];
            const configDiv = document.getElementById('roleConfig');
            
            let configText = '';
            for (const [role, count] of Object.entries(config)) {
                configText += `${roles[role].emoji} ${role} ${count}äºº, `;
            }
            configText = configText.slice(0, -2);
            
            configDiv.textContent = configText;
        }

        function startGame() {
            const requiredCount = parseInt(document.getElementById('playerCount').value);
            
            if (gameState.selectedPlayers.length !== requiredCount) {
                showAlert(`è«‹é¸æ“‡${requiredCount}åç©å®¶`);
                return;
            }
            
            const config = gameState.customConfig || defaultRoleConfigs[requiredCount];
            
            if (!config) {
                showAlert('è«‹é¸æ“‡æœ‰æ•ˆçš„ç©å®¶æ•¸é‡');
                return;
            }
            
            // ç”Ÿæˆè§’è‰²åˆ—è¡¨
            const roleList = [];
            for (const [role, count] of Object.entries(config)) {
                for (let i = 0; i < count; i++) {
                    roleList.push(role);
                }
            }
            
            // éš¨æ©Ÿåˆ†é…è§’è‰²
            for (let i = roleList.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roleList[i], roleList[j]] = [roleList[j], roleList[i]];
            }
            
            // åˆå§‹åŒ–ç©å®¶
            gameState.players = roleList.map((role, index) => ({
                id: index + 1,
                role: role,
                team: roles[role].team,
                alive: true,
                protected: false
            }));
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameState.nightActions = {
                guardTarget: null,
                werewolfTarget: null,
                witchSave: false,
                witchPoison: null,
                seerTarget: null,
                witchUsedPotion: false,
                witchUsedPoison: false
            };
            
            gameState.phase = 'roleAssignment';
            gameState.currentPlayer = 0;
            
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('roleAssignment').classList.remove('hidden');
            
            updateRoleAssignment();
            speak('éŠæˆ²é–‹å§‹ï¼Œè«‹å°‡æ‰‹æ©Ÿäº¤çµ¦ç¬¬ä¸€ä½ç©å®¶æŸ¥çœ‹è§’è‰²');
        }

        function updateRoleAssignment() {
            const players = Storage.getPlayers();
            const playerId = gameState.selectedPlayers[gameState.currentPlayer];
            const playerData = players.find(p => p.id === playerId);
            
            document.getElementById('currentPlayerText').textContent = playerData?.name || `${gameState.currentPlayer + 1}è™Ÿ`;
            document.getElementById('currentPlayerAvatar').src = playerData?.avatar || createDefaultAvatar(playerData?.name || '');
            
            const roleCard = document.getElementById('roleCard');
            roleCard.className = 'role-card role-hidden double-tap w-full h-48 rounded-lg flex items-center justify-center mb-4 cursor-pointer';
            roleCard.innerHTML = '<p class="text-lg font-semibold">é›™æ“ŠæŸ¥çœ‹è§’è‰²</p>';
        }

        function toggleRoleCard() {
            const roleCard = document.getElementById('roleCard');
            const player = gameState.players[gameState.currentPlayer];
            
            if (roleCard.classList.contains('role-hidden')) {
                roleCard.classList.remove('role-hidden');
                roleCard.classList.add('role-revealed');
                roleCard.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-3xl mb-2">${roles[player.role].emoji}</h3>
                        <h3 class="text-2xl font-bold mb-2">${player.role}</h3>
                        <p class="text-sm">${roles[player.role].description}</p>
                    </div>
                `;
            } else {
                roleCard.classList.remove('role-revealed');
                roleCard.classList.add('role-hidden');
                roleCard.innerHTML = '<p class="text-lg font-semibold">é›™æ“ŠæŸ¥çœ‹è§’è‰²</p>';
            }
        }

        function nextPlayer() {
            gameState.currentPlayer++;
            
            if (gameState.currentPlayer >= gameState.players.length) {
                startNightPhase();
            } else {
                updateRoleAssignment();
                const players = Storage.getPlayers();
                const playerId = gameState.selectedPlayers[gameState.currentPlayer];
                const playerData = players.find(p => p.id === playerId);
                speak(`è«‹å°‡æ‰‹æ©Ÿäº¤çµ¦${playerData?.name || (gameState.currentPlayer + 1) + 'è™Ÿ'}ç©å®¶`);
            }
        }

        async function startNightPhase() {
            gameState.phase = 'night';
            gameState.nightActionIndex = 0;
            
            document.getElementById('roleAssignment').classList.add('hidden');
            document.getElementById('gamePlay').classList.remove('hidden');
            
            updatePlayerList();
            
            await speak('å¤©é»‘äº†ï¼Œè«‹æ‰€æœ‰ç©å®¶é–‰çœ¼');
            updateNightAction();
        }

        function updatePlayerList() {
            const playerList = document.getElementById('playerList');
            const players = Storage.getPlayers();
            playerList.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerId = gameState.selectedPlayers[index];
                const playerData = players.find(p => p.id === playerId);
                
                const playerDiv = document.createElement('div');
                playerDiv.className = `p-2 rounded text-center text-sm flex items-center ${
                    player.alive 
                        ? 'bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100' 
                        : 'bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-100'
                }`;
                
                playerDiv.innerHTML = `
                    <img src="${playerData?.avatar || createDefaultAvatar(playerData?.name || '')}" class="w-6 h-6 rounded-full mr-2" alt="">
                    <span>${playerData?.name || (index + 1) + 'è™Ÿ'} ${player.alive ? 'å­˜æ´»' : 'æ­»äº¡'}</span>
                `;
                playerList.appendChild(playerDiv);
            });
        }

        // è£œå……å…¶é¤˜çš„éŠæˆ²é‚è¼¯å‡½æ•¸ï¼ˆå¤œæ™šè¡Œå‹•ã€æŠ•ç¥¨ç­‰ï¼‰
        // ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼Œé€™è£¡åªå±•ç¤ºä¸»è¦çš„æ–°åŠŸèƒ½å¯¦ç¾
        // å…¶ä»–å‡½æ•¸å¦‚ generateNightSequence, updateNightAction ç­‰ä¿æŒåŸæœ‰é‚è¼¯

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 fade-in">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded" 
                                onclick="this.closest('.fixed').remove()">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 fade-in">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">å–æ¶ˆ</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            
            const cancelBtn = modal.querySelector('.cancel-btn');
            const confirmBtn = modal.querySelector('.confirm-btn');
            
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            confirmBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
                onConfirm();
            });
            
            document.body.appendChild(modal);
        }

        function restartGame() {
            // åœæ­¢èªéŸ³åˆæˆ
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            // æ¸…é™¤ä»»ä½•è¨ˆæ™‚å™¨
            if (autoTimer) {
                clearTimeout(autoTimer);
                autoTimer = null;
            }
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameState = {
                players: [],
                selectedPlayers: [],
                guestPlayers: {},
                currentPlayer: 0,
                currentVoter: 0,
                day: 1,
                phase: 'setup',
                nightActionIndex: 0,
                votes: {},
                selectedVote: null,
                votingResult: null,
                nightActions: {
                    guardTarget: null,
                    werewolfTarget: null,
                    witchSave: false,
                    witchPoison: null,
                    seerTarget: null,
                    witchUsedPotion: false,
                    witchUsedPoison: false
                },
                customConfig: null
            };
            
            // éš±è—æ‰€æœ‰éŠæˆ²éšæ®µç•Œé¢
            document.getElementById('gameEnd').classList.add('hidden');
            document.getElementById('gamePlay').classList.add('hidden');
            document.getElementById('roleAssignment').classList.add('hidden');
            document.getElementById('lastWordsPhase').classList.add('hidden');
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('dayDiscussion').classList.add('hidden');
            document.getElementById('nightActions').classList.add('hidden');
            
            // é‡ç½®å¤œæ™šè¡Œå‹•ç›¸é—œç•Œé¢
            document.getElementById('roleActionPanel').classList.add('hidden');
            document.getElementById('autoTimer').classList.add('hidden');
            document.getElementById('nextAction').classList.remove('hidden');
            document.getElementById('actionText').textContent = 'è«‹æ‰€æœ‰ç©å®¶é–‰çœ¼';
            
            // é¡¯ç¤ºè¨­ç½®ç•Œé¢
            document.getElementById('setup').classList.remove('hidden');
            
            // é‡ç½®ç•Œé¢ç‹€æ…‹
            document.getElementById('dayCount').textContent = '1';
            document.getElementById('gamePhase').textContent = 'å¤œæ™šéšæ®µ';
            
            // é‡æ–°æ›´æ–°é…ç½®å’Œç©å®¶é¸æ“‡
            updateRoleConfig();
            updatePlayerSelection();
        }

        function forceEndGame() {
            showConfirmDialog('ç¢ºå®šè¦å¼·åˆ¶çµæŸéŠæˆ²å—ï¼Ÿ', () => {
                endGame('éŠæˆ²å¼·åˆ¶çµæŸ');
            });
        }

        // è¨ªå®¢ç©å®¶åŠŸèƒ½
        function showGuestPlayer() {
            // æ›´æ–°ä¸‹ä¸€å€‹è¨ªå®¢åç¨±é¡¯ç¤º
            const nextGuestNumber = getNextGuestNumber();
            document.getElementById('nextGuestName').textContent = `è¨ªå®¢${nextGuestNumber}`;
            document.getElementById('guestPlayerModal').classList.remove('hidden');
        }

        function hideGuestPlayer() {
            document.getElementById('guestPlayerModal').classList.add('hidden');
        }

        function getNextGuestNumber() {
            const players = Storage.getPlayers();
            const existingGuestNumbers = [];
            
            // æ”¶é›†å·²å­˜åœ¨çš„è¨ªå®¢ç·¨è™Ÿ
            players.forEach(player => {
                if (player.name.startsWith('è¨ªå®¢')) {
                    const number = parseInt(player.name.replace('è¨ªå®¢', ''));
                    if (!isNaN(number)) {
                        existingGuestNumbers.push(number);
                    }
                }
            });
            
            // æ”¶é›†ç•¶å‰é¸ä¸­çš„è¨ªå®¢ç·¨è™Ÿ
            gameState.selectedPlayers.forEach(playerId => {
                if (playerId.startsWith('guest_')) {
                    const guestData = gameState.guestPlayers?.[playerId];
                    if (guestData && guestData.name.startsWith('è¨ªå®¢')) {
                        const number = parseInt(guestData.name.replace('è¨ªå®¢', ''));
                        if (!isNaN(number)) {
                            existingGuestNumbers.push(number);
                        }
                    }
                }
            });
            
            // æ‰¾åˆ°æœ€å°çš„å¯ç”¨ç·¨è™Ÿ
            let nextNumber = 1;
            while (existingGuestNumbers.includes(nextNumber)) {
                nextNumber++;
            }
            
            return nextNumber;
        }

        function addGuestPlayer() {
            const requiredCount = parseInt(document.getElementById('playerCount').value);
            if (gameState.selectedPlayers.length >= requiredCount) {
                showAlert('å·²é”åˆ°æœ€å¤§ç©å®¶æ•¸é‡');
                return;
            }
            
            // è‡ªå‹•ç”Ÿæˆè¨ªå®¢åç¨±
            const guestNumber = getNextGuestNumber();
            const name = `è¨ªå®¢${guestNumber}`;
            
            // å‰µå»ºè¨ªå®¢ç©å®¶ID
            const guestId = `guest_${Date.now()}`;
            gameState.selectedPlayers.push(guestId);
            
            // å°‡è¨ªå®¢è³‡æ–™è‡¨æ™‚å­˜å„²åœ¨ gameState ä¸­
            if (!gameState.guestPlayers) {
                gameState.guestPlayers = {};
            }
            gameState.guestPlayers[guestId] = {
                id: guestId,
                name: name,
                avatar: createDefaultAvatar(name),
                isGuest: true
            };
            
            hideGuestPlayer();
            updatePlayerSelection();
        }

        // ç²å–ç©å®¶è³‡æ–™ï¼ˆåŒ…æ‹¬è¨ªå®¢ï¼‰
        function getPlayerData(playerId) {
            if (playerId.startsWith('guest_')) {
                return gameState.guestPlayers?.[playerId] || null;
            } else {
                const players = Storage.getPlayers();
                return players.find(p => p.id === playerId) || null;
            }
        }

        function removeGuestPlayer(guestId) {
            // å¾é¸ä¸­åˆ—è¡¨ç§»é™¤
            const index = gameState.selectedPlayers.indexOf(guestId);
            if (index !== -1) {
                gameState.selectedPlayers.splice(index, 1);
            }
            
            // å¾è¨ªå®¢è³‡æ–™ç§»é™¤
            if (gameState.guestPlayers) {
                delete gameState.guestPlayers[guestId];
            }
            
            updatePlayerSelection();
        }

        // è£œå……æ ¸å¿ƒéŠæˆ²é‚è¼¯å‡½æ•¸
        function generateNightSequence() {
            const sequence = [{ text: 'è«‹æ‰€æœ‰ç©å®¶é–‰çœ¼', speak: 'è«‹æ‰€æœ‰ç©å®¶é–‰çœ¼', role: null, auto: true }];
            
            const roleOrder = ['éºµåŒ…å¸«å‚…', 'å®ˆè¡›', 'ç‹¼äºº', 'å°å¥³å­©', 'å¥³å·«', 'é è¨€å®¶'];
            
            roleOrder.forEach(role => {
                if (hasRole(role)) {
                    if (role === 'éºµåŒ…å¸«å‚…') {
                        sequence.push(
                            { text: 'éºµåŒ…å¸«å‚…è«‹çœçœ¼ï¼Œé¸æ“‡è¦æ¨™è¨˜çš„äºº', speak: 'éºµåŒ…å¸«å‚…è«‹çœçœ¼ï¼Œé¸æ“‡è¦æ¨™è¨˜å˜…äºº', role: 'éºµåŒ…å¸«å‚…', auto: false },
                            { text: 'éºµåŒ…å¸«å‚…è«‹é–‰çœ¼', speak: 'éºµåŒ…å¸«å‚…è«‹é–‰çœ¼', role: null, auto: true }
                        );
                    } else if (role === 'ç‹¼äºº') {
                        sequence.push(
                            { text: 'ç‹¼äººè«‹çœçœ¼ï¼Œé¸æ“‡è¦æ®ºçš„äºº', speak: 'ç‹¼äººè«‹çœçœ¼ï¼Œé¸æ“‡è¦æ®ºå˜…äºº', role: 'ç‹¼äºº', auto: false },
                            { text: 'ç‹¼äººè«‹é–‰çœ¼', speak: 'ç‹¼äººè«‹é–‰çœ¼', role: null, auto: true }
                        );
                    } else if (role === 'å¥³å·«') {
                        sequence.push(
                            { text: 'å¥³å·«è«‹çœçœ¼', speak: 'å¥³å·«è«‹çœçœ¼', role: 'å¥³å·«', auto: false },
                            { text: 'å¥³å·«è«‹é–‰çœ¼', speak: 'å¥³å·«è«‹é–‰çœ¼', role: null, auto: true }
                        );
                    } else if (role === 'é è¨€å®¶') {
                        sequence.push(
                            { text: 'é è¨€å®¶è«‹çœçœ¼ï¼Œé¸æ“‡è¦æŸ¥é©—çš„äºº', speak: 'é è¨€å®¶è«‹çœçœ¼ï¼Œé¸æ“‡è¦æŸ¥é©—å˜…äºº', role: 'é è¨€å®¶', auto: false },
                            { text: 'é è¨€å®¶è«‹é–‰çœ¼', speak: 'é è¨€å®¶è«‹é–‰çœ¼', role: null, auto: true }
                        );
                    } else if (role === 'å®ˆè¡›') {
                        sequence.push(
                            { text: 'å®ˆè¡›è«‹çœçœ¼ï¼Œé¸æ“‡è¦ä¿è­·çš„äºº', speak: 'å®ˆè¡›è«‹çœçœ¼ï¼Œé¸æ“‡è¦ä¿è­·å˜…äºº', role: 'å®ˆè¡›', auto: false },
                            { text: 'å®ˆè¡›è«‹é–‰çœ¼', speak: 'å®ˆè¡›è«‹é–‰çœ¼', role: null, auto: true }
                        );
                    }
                }
            });
            
            return sequence;
        }

        function hasRole(role) {
            return gameState.players.some(p => p.role === role);
        }

        function hasRoleAlive(role) {
            return gameState.players.some(p => p.role === role && p.alive);
        }

        let autoTimer = null;

        async function updateNightAction() {
            const nightSequence = generateNightSequence();
            
            if (gameState.nightActionIndex >= nightSequence.length) {
                startDayPhase();
                return;
            }
            
            const action = nightSequence[gameState.nightActionIndex];
            document.getElementById('actionText').textContent = action.text;
            
            if (autoTimer) {
                clearTimeout(autoTimer);
                autoTimer = null;
            }
            
            const roleActionPanel = document.getElementById('roleActionPanel');
            const autoTimerDiv = document.getElementById('autoTimer');
            const nextActionBtn = document.getElementById('nextAction');
            
            roleActionPanel.classList.add('hidden');
            autoTimerDiv.classList.add('hidden');
            nextActionBtn.classList.add('hidden');
            
            await speak(action.speak);
            
            if (action.role && hasRoleAlive(action.role)) {
                showRoleActionPanel(action.role);
                roleActionPanel.classList.remove('hidden');
                nextActionBtn.classList.remove('hidden');
            } else {
                if (action.auto) {
                    autoTimerDiv.classList.remove('hidden');
                    startCountdown(2);
                } else {
                    nextActionBtn.classList.remove('hidden');
                }
            }
        }

        function startCountdown(seconds) {
            let countdown = seconds;
            document.getElementById('countdown').textContent = countdown;
            
            autoTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('countdown').textContent = countdown;
                } else {
                    clearInterval(autoTimer);
                    autoTimer = null;
                    document.getElementById('autoTimer').classList.add('hidden');
                    document.getElementById('nextAction').classList.remove('hidden');
                    nextNightAction();
                }
            }, 1000);
        }

        function showRoleActionPanel(role) {
            const panel = document.getElementById('roleActionPanel');
            const alivePlayers = gameState.players.filter(p => p.alive);
            
            switch (role) {
                case 'éºµåŒ…å¸«å‚…':
                    panel.innerHTML = `
                        <h4 class="text-lg font-semibold mb-3 text-center">ğŸ éºµåŒ…å¸«å‚…è«‹é¸æ“‡è¦æ¨™è¨˜çš„ç©å®¶</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 text-center">æ¨™è¨˜å¾Œï¼Œç‹¼äººåªèƒ½æ”»æ“Šè¢«æ¨™è¨˜çš„ç©å®¶æˆ–å…¶å·¦å³é„°å±…</p>
                        <div class="grid grid-cols-3 gap-2" id="bakerTargets">
                            ${alivePlayers.map(p => `
                                <button class="action-button bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded" 
                                        onclick="setBakerMark(${p.id})">${p.id}è™Ÿ</button>
                            `).join('')}
                        </div>
                        <button class="mt-3 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded" 
                                onclick="setBakerMark(null)">ä¸æ¨™è¨˜ä»»ä½•äºº</button>
                    `;
                    break;
                    
                case 'å®ˆè¡›':
                    panel.innerHTML = `
                        <h4 class="text-lg font-semibold mb-3 text-center">ğŸ›¡ï¸ å®ˆè¡›è«‹é¸æ“‡è¦ä¿è­·çš„ç©å®¶</h4>
                        <div class="grid grid-cols-3 gap-2" id="guardTargets">
                            ${alivePlayers.map(p => `
                                <button class="action-button bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded" 
                                        onclick="setGuardTarget(${p.id})">${p.id}è™Ÿ</button>
                            `).join('')}
                        </div>
                        <button class="mt-3 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded" 
                                onclick="setGuardTarget(null)">ä¸ä¿è­·ä»»ä½•äºº</button>
                    `;
                    break;
                    
                case 'ç‹¼äºº':
                    // å¦‚æœæœ‰éºµåŒ…å¸«å‚…æ¨™è¨˜ï¼Œé™åˆ¶ç‹¼äººçš„æ”»æ“Šé¸é …
                    let availableTargets = alivePlayers;
                    let restrictionText = '';
                    
                    if (gameState.nightActions.bakerMark) {
                        const markedPlayer = gameState.nightActions.bakerMark;
                        const markedIndex = gameState.players.findIndex(p => p.id === markedPlayer && p.alive);
                        
                        if (markedIndex !== -1) {
                            const leftNeighbor = getLeftNeighbor(markedIndex);
                            const rightNeighbor = getRightNeighbor(markedIndex);
                            
                            const allowedIds = [markedPlayer];
                            if (leftNeighbor && leftNeighbor.alive) allowedIds.push(leftNeighbor.id);
                            if (rightNeighbor && rightNeighbor.alive) allowedIds.push(rightNeighbor.id);
                            
                            availableTargets = alivePlayers.filter(p => allowedIds.includes(p.id));
                            restrictionText = `<p class="text-sm text-yellow-600 dark:text-yellow-400 mb-3 text-center">éºµåŒ…å¸«å‚…é™åˆ¶ï¼šåªèƒ½æ”»æ“Š${markedPlayer}è™ŸåŠå…¶å·¦å³é„°å±…</p>`;
                        }
                    }
                    
                    panel.innerHTML = `
                        <h4 class="text-lg font-semibold mb-3 text-center">ğŸº ç‹¼äººè«‹é¸æ“‡è¦æ®ºå®³çš„ç©å®¶</h4>
                        ${restrictionText}
                        <div class="grid grid-cols-3 gap-2" id="werewolfTargets">
                            ${availableTargets.map(p => `
                                <button class="action-button bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded" 
                                        onclick="setWerewolfTarget(${p.id})">${p.id}è™Ÿ</button>
                            `).join('')}
                        </div>
                        <button class="mt-3 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded" 
                                onclick="setWerewolfTarget(null)">ä¸æ®ºä»»ä½•äºº</button>
                    `;
                    break;
                    
                case 'å¥³å·«':
                    const witchInfo = gameState.nightActions.werewolfTarget ? 
                        `${gameState.nightActions.werewolfTarget}è™Ÿç©å®¶è¢«ç‹¼äººæ®ºå®³` : 'æ²’æœ‰äººè¢«ç‹¼äººæ®ºå®³';
                    panel.innerHTML = `
                        <h4 class="text-lg font-semibold mb-3 text-center">ğŸ§™â€â™€ï¸ å¥³å·«çš„å›åˆ</h4>
                        <p class="text-center mb-3">${witchInfo}</p>
                        <div class="space-y-2">
                            ${!gameState.nightActions.witchUsedPotion ? `
                                <button class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded" 
                                        onclick="showSaveTargets()">ä½¿ç”¨è§£è—¥æ•‘äºº</button>
                            ` : ''}
                            ${!gameState.nightActions.witchUsedPoison ? `
                                <button class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded" 
                                        onclick="showPoisonTargets()">ä½¿ç”¨æ¯’è—¥</button>
                            ` : ''}
                            <button class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded" 
                                    onclick="setWitchAction('skip')">è·³é</button>
                        </div>
                        <div id="saveTargets" class="hidden mt-3">
                            <p class="text-center mb-2">é¸æ“‡è¦æ•‘çš„ç©å®¶ï¼š</p>
                            <div class="grid grid-cols-3 gap-2">
                                ${alivePlayers.map(p => `
                                    <button class="action-button bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded" 
                                            onclick="setWitchSaveTarget(${p.id})">${p.id}è™Ÿ</button>
                                `).join('')}
                            </div>
                        </div>
                        <div id="poisonTargets" class="hidden mt-3">
                            <p class="text-center mb-2">é¸æ“‡è¦æ¯’æ®ºçš„ç©å®¶ï¼š</p>
                            <div class="grid grid-cols-3 gap-2">
                                ${alivePlayers.map(p => `
                                    <button class="action-button bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded" 
                                            onclick="setWitchPoison(${p.id})">${p.id}è™Ÿ</button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'é è¨€å®¶':
                    panel.innerHTML = `
                        <h4 class="text-lg font-semibold mb-3 text-center">ğŸ”® é è¨€å®¶è«‹é¸æ“‡è¦æŸ¥é©—çš„ç©å®¶</h4>
                        <div class="grid grid-cols-3 gap-2" id="seerTargets">
                            ${alivePlayers.map(p => `
                                <button class="action-button bg-purple-500 hover:bg-purple-600 text-white py-2 px-3 rounded" 
                                        onclick="setSeerTarget(${p.id})">${p.id}è™Ÿ</button>
                            `).join('')}
                        </div>
                        <div id="seerResult" class="hidden mt-3 p-3 bg-yellow-100 dark:bg-yellow-800 rounded text-center">
                            <!-- æŸ¥é©—çµæœ -->
                        </div>
                    `;
                    break;
            }
        }

        // æ–°å¢éºµåŒ…å¸«å‚…å’Œå°å¥³å­©çš„åŠŸèƒ½å‡½æ•¸
        function setBakerMark(playerId) {
            gameState.nightActions.bakerMark = playerId;
            document.getElementById('roleActionPanel').classList.add('hidden');
        }



        function getLeftNeighbor(playerIndex) {
            const alivePlayers = gameState.players.filter(p => p.alive);
            const aliveIndex = alivePlayers.findIndex(p => p.id === gameState.players[playerIndex].id);
            if (aliveIndex === -1) return null;
            
            const leftIndex = (aliveIndex - 1 + alivePlayers.length) % alivePlayers.length;
            return alivePlayers[leftIndex];
        }

        function getRightNeighbor(playerIndex) {
            const alivePlayers = gameState.players.filter(p => p.alive);
            const aliveIndex = alivePlayers.findIndex(p => p.id === gameState.players[playerIndex].id);
            if (aliveIndex === -1) return null;
            
            const rightIndex = (aliveIndex + 1) % alivePlayers.length;
            return alivePlayers[rightIndex];
        }

        function setGuardTarget(playerId) {
            gameState.nightActions.guardTarget = playerId;
            document.getElementById('roleActionPanel').classList.add('hidden');
        }

        function setWerewolfTarget(playerId) {
            gameState.nightActions.werewolfTarget = playerId;
            document.getElementById('roleActionPanel').classList.add('hidden');
        }

        function showSaveTargets() {
            document.getElementById('saveTargets').classList.remove('hidden');
        }

        function setWitchSaveTarget(playerId) {
            gameState.nightActions.witchSave = playerId;
            gameState.nightActions.witchUsedPotion = true;
            document.getElementById('roleActionPanel').classList.add('hidden');
        }

        function showPoisonTargets() {
            document.getElementById('poisonTargets').classList.remove('hidden');
        }

        function setWitchPoison(playerId) {
            gameState.nightActions.witchPoison = playerId;
            gameState.nightActions.witchUsedPoison = true;
            document.getElementById('roleActionPanel').classList.add('hidden');
        }

        function setWitchAction(action) {
            if (action === 'skip') {
                document.getElementById('roleActionPanel').classList.add('hidden');
            }
        }

        function setSeerTarget(playerId) {
            if (gameState.nightActions.seerTarget) {
                return;
            }
            
            gameState.nightActions.seerTarget = playerId;
            const target = gameState.players.find(p => p.id === playerId);
            const result = target.team === 'werewolf' ? 'å£äºº' : 'å¥½äºº';
            
            const buttons = document.querySelectorAll('#seerTargets .action-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
            
            document.getElementById('seerResult').classList.remove('hidden');
            document.getElementById('seerResult').textContent = `${playerId}è™Ÿæ˜¯${result}`;
        }

        function nextNightAction() {
            gameState.nightActionIndex++;
            updateNightAction();
        }

        function startDayPhase() {
            gameState.phase = 'day';
            
            const deaths = [];
            
            if (gameState.nightActions.werewolfTarget) {
                const target = gameState.nightActions.werewolfTarget;
                if (target !== gameState.nightActions.guardTarget) {
                    if (gameState.nightActions.witchSave !== target) {
                        deaths.push(target);
                    }
                }
            }
            
            if (gameState.nightActions.witchPoison) {
                deaths.push(gameState.nightActions.witchPoison);
            }
            
            let deathMessage = '';
            if (deaths.length === 0) {
                deathMessage = 'æ˜¨æ™šéå¸¸å¹³å®‰ï¼Œæ²’æœ‰äººæ­»äº¡';
            } else {
                deaths.forEach(playerId => {
                    const player = gameState.players.find(p => p.id === playerId);
                    player.alive = false;
                });
                
                const deathList = deaths.map(id => `${id}è™Ÿ`).join('ã€');
                deathMessage = `æ˜¨æ™šï¼Œ${deathList}ç©å®¶æ­»äº¡äº†`;
            }
            
            document.getElementById('deathAnnouncement').textContent = deathMessage;
            speak(deathMessage);
            
            const deadHunter = deaths.find(id => {
                const player = gameState.players.find(p => p.id === id);
                return player && player.role === 'çµäºº';
            });
            
            if (deadHunter) {
                showHunterAction();
            } else {
                document.getElementById('nightActions').classList.add('hidden');
                document.getElementById('dayDiscussion').classList.remove('hidden');
                document.getElementById('hunterAction').classList.add('hidden');
            }
            
            updatePlayerList();
            
            gameState.nightActions = {
                guardTarget: null,
                werewolfTarget: null,
                witchSave: false,
                witchPoison: null,
                seerTarget: null,
                witchUsedPotion: gameState.nightActions.witchUsedPotion,
                witchUsedPoison: gameState.nightActions.witchUsedPoison
            };
            
            if (!deadHunter && checkGameEnd()) {
                return;
            }
        }

        function showHunterAction() {
            document.getElementById('nightActions').classList.add('hidden');
            document.getElementById('dayDiscussion').classList.remove('hidden');
            document.getElementById('hunterAction').classList.remove('hidden');
            
            const hunterTargets = document.getElementById('hunterTargets');
            const alivePlayers = gameState.players.filter(p => p.alive);
            
            hunterTargets.innerHTML = alivePlayers.map(p => `
                <button class="action-button bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded" 
                        onclick="hunterShoot(${p.id})">${p.id}è™Ÿ</button>
            `).join('');
            
            speak('çµäººæ­»äº¡ï¼Œè«‹é¸æ“‡è¦é–‹æ§å˜…ç›®æ¨™');
        }

        function hunterShoot(playerId) {
            const target = gameState.players.find(p => p.id === playerId);
            target.alive = false;
            
            document.getElementById('hunterAction').classList.add('hidden');
            updatePlayerList();
            
            speak(`çµäººé–‹æ§å¸¶èµ°${playerId}è™Ÿç©å®¶`);
            
            checkGameEnd();
        }

        document.getElementById('skipHunterShot').addEventListener('click', function() {
            document.getElementById('hunterAction').classList.add('hidden');
            speak('çµäººé¸æ“‡ä¸é–‹æ§');
            checkGameEnd();
        });

        function startVoting() {
            gameState.phase = 'voting';
            gameState.currentVoter = 0;
            gameState.votes = {};
            gameState.selectedVote = null;
            
            while (gameState.currentVoter < gameState.players.length && 
                   !gameState.players[gameState.currentVoter].alive) {
                gameState.currentVoter++;
            }
            
            document.getElementById('dayDiscussion').classList.add('hidden');
            document.getElementById('votingPhase').classList.remove('hidden');
            
            updateVotingOptions();
            updateCurrentVoter();
            
            speak('é–‹å§‹æŠ•ç¥¨ï¼Œè«‹å°‡æ‰‹æ©Ÿäº¤çµ¦ç¬¬ä¸€ä½å­˜æ´»çš„ç©å®¶');
        }

        function updateVotingOptions() {
            const votingOptions = document.getElementById('votingOptions');
            votingOptions.innerHTML = '';
            
            const alivePlayers = gameState.players.filter(p => p.alive);
            
            alivePlayers.forEach(player => {
                const button = document.createElement('button');
                button.className = 'action-button bg-gray-200 dark:bg-gray-600 hover:bg-blue-500 hover:text-white text-gray-800 dark:text-gray-200 font-semibold py-3 px-4 rounded-lg transition duration-200';
                button.textContent = `${player.id}è™Ÿ`;
                button.onclick = () => selectVote(player.id);
                votingOptions.appendChild(button);
            });
        }

        function selectVote(playerId) {
            gameState.selectedVote = playerId;
            
            const buttons = document.querySelectorAll('#votingOptions .action-button');
            buttons.forEach(btn => {
                if (btn.textContent === `${playerId}è™Ÿ`) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function skipVote() {
            gameState.selectedVote = null;
            nextVoter();
        }

        function nextVoter() {
            const currentPlayer = gameState.players[gameState.currentVoter];
            
            if (currentPlayer.alive && gameState.selectedVote) {
                if (!gameState.votes[gameState.selectedVote]) {
                    gameState.votes[gameState.selectedVote] = 0;
                }
                gameState.votes[gameState.selectedVote]++;
            }
            
            do {
                gameState.currentVoter++;
            } while (gameState.currentVoter < gameState.players.length && 
                     !gameState.players[gameState.currentVoter].alive);
            
            if (gameState.currentVoter >= gameState.players.length) {
                processVotingResult();
            } else {
                gameState.selectedVote = null;
                updateCurrentVoter();
                updateVotingOptions();
                
                const nextVoterNum = gameState.currentVoter + 1;
                speak(`è«‹å°‡æ‰‹æ©Ÿäº¤çµ¦${nextVoterNum}è™Ÿç©å®¶æŠ•ç¥¨`);
            }
        }

        function updateCurrentVoter() {
            const currentVoterNum = gameState.currentVoter + 1;
            document.getElementById('currentVoterText').textContent = `${currentVoterNum}è™Ÿ`;
        }

        function continueToNextDay() {
            gameState.day++;
            gameState.nightActionIndex = 0;
            gameState.phase = 'night';
            
            document.getElementById('dayCount').textContent = gameState.day;
            document.getElementById('gamePhase').textContent = 'å¤œæ™šéšæ®µ';
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('nightActions').classList.remove('hidden');
            
            updatePlayerList();
            updateNightAction();
        }

        function checkGameEnd() {
            const aliveWerewolves = gameState.players.filter(p => p.alive && p.team === 'werewolf').length;
            const aliveVillagers = gameState.players.filter(p => p.alive && p.team === 'villager').length;
            
            if (aliveWerewolves === 0) {
                endGame('å¥½äººé™£ç‡Ÿ');
                return true;
            } else if (aliveWerewolves >= aliveVillagers) {
                endGame('ç‹¼äººé™£ç‡Ÿ');
                return true;
            }
            
            return false;
        }

        // åˆå§‹åŒ–
        initGame();
    </script>
    <!-- Theme Toggle -->
    <div class="flex justify-center mt-6">
        <div class="theme-toggle">
            <label for="theme-toggle" class="flex items-center cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="theme-toggle" class="sr-only" />
                    <div class="toggle-bg block bg-gray-400 w-14 h-8 rounded-full transition-colors duration-200">
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-200"></div>
                    </div>
                </div>
                <div class="ml-3 text-gray-700 dark:text-gray-300">ğŸŒ™ æ·±è‰²æ¨¡å¼</div>
            </label>
        </div>
    </div>

    <script>
        // Enhanced theme management
        function initTheme() {
            const toggle = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Determine initial theme
            const shouldBeDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);
            
            if (shouldBeDark) {
                document.documentElement.classList.add('dark');
                toggle.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                toggle.checked = false;
            }
            
            // Toggle theme on change
            toggle.addEventListener('change', () => {
                if (toggle.checked) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
            
            // Remove the automatic theme change listener to prevent conflicts
            // (The original code was conflicting with manual toggle)
        }
        
        // Initialize theme when page loads
        initTheme();
    </script>

</body></html>
