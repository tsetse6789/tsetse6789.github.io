<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game Pro by Nut</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
    <!-- Fixed Toolbar -->
    <header class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Title -->
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold text-primary">Quiz Game Pro by Nut</h1>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <button id="importGameBtn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary border border-gray-300 dark:border-gray-600 rounded-md hover:border-primary transition-colors">
                        üìÅ Import Game
                    </button>
                    <button id="joinGameBtn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary border border-gray-300 dark:border-gray-600 rounded-md hover:border-primary transition-colors">
                        üéÆ Join Game
                    </button>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="Search games..." class="w-64 px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                        <button class="absolute right-2 top-2">üîç</button>
                    </div>
                    <button id="historyBtn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary border border-gray-300 dark:border-gray-600 rounded-md hover:border-primary transition-colors">
                        üìä History
                    </button>
                </div>
                
                <!-- Mobile Navigation -->
                <div class="md:hidden flex items-center space-x-2">
                    <button id="searchBtnMobile" class="p-2 text-gray-700 dark:text-gray-300 hover:text-primary">üîç</button>
                    <button id="importGameBtnMobile" class="p-2 text-gray-700 dark:text-gray-300 hover:text-primary">üìÅ</button>
                    <button id="joinGameBtnMobile" class="p-2 text-gray-700 dark:text-gray-300 hover:text-primary">üéÆ</button>
                    <button id="historyBtnMobile" class="p-2 text-gray-700 dark:text-gray-300 hover:text-primary">üìä</button>
                </div>
            </div>
            
            <!-- Mobile Search (Hidden by default) -->
            <div id="mobileSearch" class="hidden md:hidden pb-4">
                <input id="searchInputMobile" type="text" placeholder="Search games..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-16 min-h-screen">
        <!-- Main App UI -->
        <div id="mainAppUI" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4">My Games</h2>
                <div id="gamesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Games will be populated here -->
                </div>
                <div id="noGamesMessage" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
                    <div class="text-6xl mb-4">üéØ</div>
                    <h3 class="text-xl font-medium mb-2">No games yet</h3>
                    <p>Import your first game to get started!</p>
                </div>
            </div>
        </div>

        <!-- Host Game UI -->
        <div id="hostGameUI" class="hidden max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Host content will be populated here -->
        </div>

        <!-- Player Game UI -->
        <div id="playerGameUI" class="hidden max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Player content will be populated here -->
        </div>
    </main>

    <!-- Modals -->
    <!-- Import Game Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Import Game</h3>
                    <button id="closeImportModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">‚úï</button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">Select JSON File</label>
                    <input id="gameFileInput" type="file" accept=".json" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div id="gamePreview" class="hidden mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <!-- Game preview content -->
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancelImport" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">Cancel</button>
                    <button id="confirmImport" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Import Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div id="joinModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Join Game</h3>
                    <button id="closeJoinModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">‚úï</button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Enter PIN Code</label>
                        <input id="pinInput" type="text" placeholder="Enter 6-digit PIN" maxlength="6" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent text-center text-2xl font-mono">
                    </div>
                    
                    <div class="text-center text-gray-500 dark:text-gray-400">OR</div>
                    
                    <div>
                        <button id="scanQRBtn" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            üì∑ Scan QR Code
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancelJoin" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">Cancel</button>
                    <button id="confirmJoin" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Join Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Scan QR Code</h3>
                    <button id="closeQRScanner" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">‚úï</button>
                </div>
                
                <div class="text-center">
                    <div id="qrReader" class="w-full h-64 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                        <p class="text-gray-500 dark:text-gray-400">Camera loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Name Modal -->
    <div id="playerNameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full slide-up">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold mb-2">Enter Your Name</h3>
                    <p class="text-gray-600 dark:text-gray-400">Join the game as a player</p>
                </div>
                
                <div class="mb-6">
                    <input id="playerNameInput" type="text" placeholder="Your name" maxlength="20" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancelPlayerName" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">Cancel</button>
                    <button id="confirmPlayerName" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Join Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto slide-up">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Game History</h3>
                    <button id="closeHistoryModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">‚úï</button>
                </div>
                
                <div id="historyContent" class="space-y-4">
                    <!-- History content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDq-IhF_STfdLx0MfLnsXaljqTwRZPjois",
            authDomain: "quiz-app-2c732.firebaseapp.com",
            databaseURL: "https://quiz-app-2c732-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quiz-app-2c732",
            storageBucket: "quiz-app-2c732.firebasestorage.app",
            messagingSenderId: "449014089910",
            appId: "1:449014089910:web:5d45e0702e29bc1d42be17",
            measurementId: "G-QF2Q8HJJY5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Sample questions structure for reference
        const questions = [
            {
                question: "What is the capital of France?",
                questionType: "multiple choice",
                questionContent: "What is the capital of France?",
                time: "00:30",
                points: 100,
                answerType: "radio",
                answerSettings: {
                    options: ["London", "Berlin", "Paris", "Madrid"]
                },
                answer: 2
            },
            {
                question: "Rate your programming skills",
                questionType: "rating",
                questionContent: "Rate your programming skills from 1 to 10",
                time: "00:20",
                points: 50,
                answerType: "range",
                answerSettings: {
                    min: 1,
                    max: 10
                },
                answer: null
            },
            {
                question: "Select programming languages you know",
                questionType: "multiple select",
                questionContent: "Select all programming languages you know",
                time: "00:45",
                points: 75,
                answerType: "checkbox",
                answerSettings: {
                    options: ["JavaScript", "Python", "Java", "C++", "Go"]
                },
                answer: [0, 1]
            },
            {
                question: "What is your favorite color?",
                questionType: "text",
                questionContent: "What is your favorite color?",
                time: "00:15",
                points: 25,
                answerType: "text",
                answerSettings: {
                    maxLength: 50
                },
                answer: ["blue", "red", "green"]
            },
            {
                question: "How many continents are there?",
                questionType: "number",
                questionContent: "How many continents are there?",
                time: "00:20",
                points: 100,
                answerType: "number",
                answerSettings: {
                    min: 1,
                    max: 10
                },
                answer: 7
            },
            {
                question: "Arrange these planets by distance from sun",
                questionType: "arrange",
                questionContent: "Arrange these planets by their distance from the sun (closest to farthest)",
                time: "01:00",
                points: 150,
                answerType: "rearrange",
                answerSettings: {
                    items: ["Venus", "Mercury", "Earth", "Mars"]
                },
                answer: "1,0,2,3"
            }
        ];

        // Global variables
        let currentUser = null;
        let currentRoom = null;
        let currentGame = null;
        let gameData = [];
        let gameHistory = [];
        let isHost = false;
        let currentQuestionIndex = 0;
        let questionTimer = null;
        let playerAnswers = {};
        let gameStarted = false;

        // Storage functions using localStorage
        const storage = {
            get games() {
                return JSON.parse(localStorage.getItem('quizGames') || '[]');
            },
            set games(value) {
                localStorage.setItem('quizGames', JSON.stringify(value));
            },
            get history() {
                return JSON.parse(localStorage.getItem('quizHistory') || '[]');
            },
            set history(value) {
                localStorage.setItem('quizHistory', JSON.stringify(value));
            }
        };

        // Utility functions
        function generatePIN() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function parseTimeString(timeStr) {
            // Parse time string like "01:30" to seconds
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 slide-up">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded transition-colors" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 slide-up">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" onclick="this.closest('.fixed').remove()">Cancel</button>
                        <button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition-colors" onclick="this.closest('.fixed').remove(); (${onConfirm})()">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize app
        function initializeApp() {
            setupEventListeners();
            loadGames();
            updateUI();
        }

        function setupEventListeners() {
            // Mobile search toggle
            document.getElementById('searchBtnMobile').addEventListener('click', () => {
                const mobileSearch = document.getElementById('mobileSearch');
                mobileSearch.classList.toggle('hidden');
                if (!mobileSearch.classList.contains('hidden')) {
                    document.getElementById('searchInputMobile').focus();
                }
            });

            // Import game buttons
            document.getElementById('importGameBtn').addEventListener('click', openImportModal);
            document.getElementById('importGameBtnMobile').addEventListener('click', openImportModal);
            
            // Join game buttons
            document.getElementById('joinGameBtn').addEventListener('click', openJoinModal);
            document.getElementById('joinGameBtnMobile').addEventListener('click', openJoinModal);
            
            // History buttons
            document.getElementById('historyBtn').addEventListener('click', openHistoryModal);
            document.getElementById('historyBtnMobile').addEventListener('click', openHistoryModal);

            // Modal close buttons
            document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
            document.getElementById('closeJoinModal').addEventListener('click', closeJoinModal);
            document.getElementById('closeQRScanner').addEventListener('click', closeQRScanner);
            document.getElementById('closeHistoryModal').addEventListener('click', closeHistoryModal);

            // Import modal
            document.getElementById('gameFileInput').addEventListener('change', handleFileSelect);
            document.getElementById('cancelImport').addEventListener('click', closeImportModal);
            document.getElementById('confirmImport').addEventListener('click', confirmImport);

            // Join modal
            document.getElementById('pinInput').addEventListener('input', handlePinInput);
            document.getElementById('scanQRBtn').addEventListener('click', openQRScanner);
            document.getElementById('cancelJoin').addEventListener('click', closeJoinModal);
            document.getElementById('confirmJoin').addEventListener('click', confirmJoin);

            // Player name modal
            document.getElementById('playerNameInput').addEventListener('input', handlePlayerNameInput);
            document.getElementById('cancelPlayerName').addEventListener('click', closePlayerNameModal);
            document.getElementById('confirmPlayerName').addEventListener('click', confirmPlayerName);

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('searchInputMobile').addEventListener('input', handleSearch);
        }

        // Modal functions
        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('gameFileInput').value = '';
            document.getElementById('gamePreview').classList.add('hidden');
            document.getElementById('confirmImport').disabled = true;
        }

        function openJoinModal() {
            document.getElementById('joinModal').classList.remove('hidden');
        }

        function closeJoinModal() {
            document.getElementById('joinModal').classList.add('hidden');
            document.getElementById('pinInput').value = '';
            document.getElementById('confirmJoin').disabled = true;
        }

        function openQRScanner() {
            document.getElementById('qrScannerModal').classList.remove('hidden');
            startQRScanner();
        }

        function startQRScanner() {
            const qrReaderElement = document.getElementById('qrReader');
            qrReaderElement.innerHTML = '<video id="qrVideo" class="w-full h-full object-cover rounded"></video>';
            
            const video = document.getElementById('qrVideo');
            
            // Request camera permission and start scanning
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    
                    const qrScanner = new QrScanner(video, result => {
                        // Found QR code
                        const pin = result.data;
                        if (pin && pin.length === 6 && /^\d{6}$/.test(pin)) {
                            // Stop scanner
                            qrScanner.stop();
                            stream.getTracks().forEach(track => track.stop());
                            closeQRScanner();
                            
                            // Auto-fill PIN and check room
                            document.getElementById('pinInput').value = pin;
                            checkRoomExists(pin);
                        }
                    }, {
                        returnDetailedScanResult: true,
                        highlightScanRegion: true,
                        highlightCodeOutline: true,
                    });
                    
                    qrScanner.start();
                    
                    // Store scanner reference for cleanup
                    window.currentQRScanner = qrScanner;
                    window.currentVideoStream = stream;
                })
                .catch(function(err) {
                    console.error('Camera access denied:', err);
                    qrReaderElement.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center p-4">
                            <div class="text-4xl mb-2">üì∑</div>
                            <p class="text-gray-500 dark:text-gray-400 mb-2">Camera access required</p>
                            <p class="text-sm text-gray-400">Please allow camera access to scan QR codes</p>
                        </div>
                    `;
                });
        }

        function closeQRScanner() {
            document.getElementById('qrScannerModal').classList.add('hidden');
            
            // Clean up camera resources
            if (window.currentQRScanner) {
                window.currentQRScanner.stop();
                window.currentQRScanner = null;
            }
            if (window.currentVideoStream) {
                window.currentVideoStream.getTracks().forEach(track => track.stop());
                window.currentVideoStream = null;
            }
        }

        function openHistoryModal() {
            document.getElementById('historyModal').classList.remove('hidden');
            loadGameHistory();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function openPlayerNameModal() {
            document.getElementById('playerNameModal').classList.remove('hidden');
        }

        function closePlayerNameModal() {
            document.getElementById('playerNameModal').classList.add('hidden');
            document.getElementById('playerNameInput').value = '';
            document.getElementById('confirmPlayerName').disabled = true;
        }

        // Game management functions
        function loadGames() {
            // Simulate loading from localStorage
            updateGamesList();
        }

        function updateGamesList() {
            const gamesList = document.getElementById('gamesList');
            const noGamesMessage = document.getElementById('noGamesMessage');
            
            if (storage.games.length === 0) {
                gamesList.innerHTML = '';
                noGamesMessage.classList.remove('hidden');
            } else {
                noGamesMessage.classList.add('hidden');
                gamesList.innerHTML = storage.games.map((game, index) => `
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                        <h3 class="text-lg font-semibold mb-2">${game.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-1">By: ${game.author}</p>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">${game.questions.length} questions</p>
                        <div class="flex space-x-3">
                            <button onclick="playGame(${index})" class="flex-1 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                                ‚ñ∂Ô∏è Play
                            </button>
                            <button onclick="deleteGame(${index})" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function deleteGame(index) {
            showConfirmDialog('Are you sure you want to delete this game?', () => {
                const currentGames = storage.games;
                currentGames.splice(index, 1);
                storage.games = currentGames;
                updateGamesList();
            });
        }

        function playGame(index) {
            currentGame = storage.games[index];
            isHost = true;
            startHostingGame();
        }

        // Import functionality
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const gameData = JSON.parse(e.target.result);
                        showGamePreview(gameData);
                    } catch (error) {
                        showCustomAlert('Invalid JSON file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function showGamePreview(gameData) {
            const preview = document.getElementById('gamePreview');
            preview.innerHTML = `
                <h4 class="font-semibold mb-2">Game Preview</h4>
                <p><strong>Name:</strong> ${gameData.name || 'Untitled'}</p>
                <p><strong>Author:</strong> ${gameData.author || 'Unknown'}</p>
                <p><strong>Questions:</strong> ${gameData.questions ? gameData.questions.length : 0}</p>
                <p><strong>Description:</strong> ${gameData.description || 'No description'}</p>
            `;
            preview.classList.remove('hidden');
            document.getElementById('confirmImport').disabled = false;
        }

        function confirmImport() {
            const file = document.getElementById('gameFileInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const gameData = JSON.parse(e.target.result);
                        // Get current games, add new game, and save back to localStorage
                        const currentGames = storage.games;
                        currentGames.push(gameData);
                        storage.games = currentGames;
                        updateGamesList();
                        closeImportModal();
                        showCustomAlert('Game imported successfully!');
                    } catch (error) {
                        showCustomAlert('Error importing game. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Join game functionality
        function handlePinInput(event) {
            const pin = event.target.value;
            document.getElementById('confirmJoin').disabled = pin.length !== 6;
        }

        function handlePlayerNameInput(event) {
            const name = event.target.value.trim();
            document.getElementById('confirmPlayerName').disabled = name.length === 0;
        }

        function confirmJoin() {
            const pin = document.getElementById('pinInput').value;
            if (pin.length === 6) {
                checkRoomExists(pin);
            }
        }

        function checkRoomExists(pin) {
            database.ref(`rooms/${pin}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    currentRoom = pin;
                    closeJoinModal();
                    openPlayerNameModal();
                } else {
                    showCustomAlert('Room not found. Please check the PIN code.');
                }
            });
        }

        function confirmPlayerName() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (playerName) {
                currentUser = {
                    name: playerName,
                    id: Date.now().toString()
                };
                isHost = false;
                joinGameAsPlayer();
                closePlayerNameModal();
            }
        }

        // Host game functionality
        function startHostingGame() {
            const pin = generatePIN();
            currentRoom = pin;
            
            // Create room in Firebase
            database.ref(`rooms/${pin}`).set({
                host: 'host',
                game: currentGame,
                players: {},
                gameState: 'waiting',
                currentQuestion: null,
                created: Date.now()
            });

            showHostUI();
        }

        function showHostUI() {
            document.getElementById('mainAppUI').classList.add('hidden');
            document.getElementById('hostGameUI').classList.remove('hidden');
            
            const hostUI = document.getElementById('hostGameUI');
            hostUI.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold mb-4">${currentGame.name}</h2>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-md mx-auto">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Game PIN</p>
                        <p class="text-4xl font-bold text-primary mb-4">${currentRoom}</p>
                        <div id="qrCode" class="mb-4"></div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Players can scan this QR code or enter the PIN to join</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Players <span id="playerCount" class="text-sm text-gray-500">(0)</span></h3>
                        <div id="playersList" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 min-h-[200px]">
                            <p class="text-gray-500 dark:text-gray-400 text-center">Waiting for players to join...</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Game Info</h3>
                        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <p class="mb-2"><strong>Questions:</strong> ${currentGame.questions.length}</p>
                            <p class="mb-4"><strong>Author:</strong> ${currentGame.author}</p>
                            <button id="startGameBtn" class="w-full px-4 py-3 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Start Game
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 text-center">
                    <button onclick="endHosting()" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        End Game
                    </button>
                </div>
            `;

            // Generate QR code
            setTimeout(() => {
                const qrCodeElement = document.getElementById('qrCode');
                if (qrCodeElement && typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(qrCodeElement, currentRoom, { 
                        width: 200,
                        height: 200,
                        colorDark: '#5D5CDE',
                        colorLight: '#FFFFFF'
                    }, function (error) {
                        if (error) {
                            console.error('QR Code generation failed:', error);
                            // Fallback to text display
                            qrCodeElement.innerHTML = `
                                <div class="w-48 h-48 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mx-auto">
                                    <div class="text-center">
                                        <div class="text-4xl mb-2">üì±</div>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">QR Code unavailable</p>
                                        <p class="text-xs text-gray-500">Use PIN: ${currentRoom}</p>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } else {
                    // Fallback if QRCode library is not available
                    qrCodeElement.innerHTML = `
                        <div class="w-48 h-48 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mx-auto">
                            <div class="text-center">
                                <div class="text-4xl mb-2">üì±</div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">QR Code unavailable</p>
                                <p class="text-xs text-gray-500">Use PIN: ${currentRoom}</p>
                            </div>
                        </div>
                    `;
                }
            }, 100);

            // Set up listeners after DOM is ready
            setTimeout(() => {
                // Listen for players joining
                database.ref(`rooms/${currentRoom}/players`).on('value', updatePlayersList);
                
                // Start game button
                const startBtn = document.getElementById('startGameBtn');
                if (startBtn) {
                    startBtn.addEventListener('click', startGame);
                }
            }, 100);
        }

        function updatePlayersList(snapshot) {
            const players = snapshot.val() || {};
            const playersList = document.getElementById('playersList');
            const playerCount = document.getElementById('playerCount');
            const startBtn = document.getElementById('startGameBtn');
            
            const playersArray = Object.values(players);
            playerCount.textContent = `(${playersArray.length})`;
            
            if (playersArray.length === 0) {
                playersList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Waiting for players to join...</p>';
                if (startBtn) startBtn.disabled = true;
            } else {
                playersList.innerHTML = playersArray.map(player => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg mb-2">
                        <span class="font-medium">${player.name}</span>
                        <span class="text-sm text-green-600 dark:text-green-400">Connected</span>
                    </div>
                `).join('');
                if (startBtn) startBtn.disabled = false;
            }
        }

        function startGame() {
            gameStarted = true;
            currentQuestionIndex = 0;
            
            // Randomize questions
            const shuffledQuestions = [...currentGame.questions].sort(() => Math.random() - 0.5);
            currentGame.questions = shuffledQuestions;
            
            database.ref(`rooms/${currentRoom}/gameState`).set('playing');
            showNextQuestion();
        }

        function showNextQuestion() {
            if (currentQuestionIndex >= currentGame.questions.length) {
                endGame();
                return;
            }
            
            const question = currentGame.questions[currentQuestionIndex];
            playerAnswers = {};
            
            // Update game state
            database.ref(`rooms/${currentRoom}/currentQuestion`).set({
                ...question,
                index: currentQuestionIndex,
                timeLeft: question.time || 30,
                status: 'active'
            });
            
            showHostQuestionUI(question);
            startQuestionTimer(question.time || 30);
        }

        function showHostQuestionUI(question) {
            const hostUI = document.getElementById('hostGameUI');
            hostUI.innerHTML = `
                <div class="text-center mb-8">
                    <div class="mb-4">
                        <span class="text-sm text-gray-500">Question ${currentQuestionIndex + 1} of ${currentGame.questions.length}</span>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">${question.questionContent}</h2>
                    <div class="flex justify-center items-center space-x-4 mb-6">
                        <div class="text-lg font-semibold">Time: <span id="timer" class="text-primary">${formatTime(question.time || 30)}</span></div>
                        <div class="text-lg font-semibold">Points: ${question.points}</div>
                    </div>
                </div>
                
                <div class="max-w-4xl mx-auto">
                    ${renderQuestionForHost(question)}
                </div>
                
                <div class="mt-8 text-center space-x-4">
                    <button onclick="finishQuestion()" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        Finish Question
                    </button>
                    <button onclick="endHosting()" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        End Game
                    </button>
                </div>
            `;
        }

        function renderQuestionForHost(question) {
            let content = `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Question Preview</h3>
            `;
            
            switch (question.answerType) {
                case 'radio':
                    content += `
                        <div class="space-y-2">
                            ${question.answerSettings.options.map((option, index) => `
                                <div class="p-3 border border-gray-200 dark:border-gray-600 rounded-md ${index === question.answer ? 'bg-green-100 dark:bg-green-900 border-green-500' : ''}">
                                    ${option} ${index === question.answer ? '‚úì' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                case 'checkbox':
                    content += `
                        <div class="space-y-2">
                            ${question.answerSettings.options.map((option, index) => `
                                <div class="p-3 border border-gray-200 dark:border-gray-600 rounded-md ${question.answer.includes(index) ? 'bg-green-100 dark:bg-green-900 border-green-500' : ''}">
                                    ${option} ${question.answer.includes(index) ? '‚úì' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                case 'range':
                    content += `
                        <div class="text-center">
                            <p>Range: ${question.answerSettings.min} - ${question.answerSettings.max}</p>
                        </div>
                    `;
                    break;
                case 'text':
                    content += `
                        <div class="text-center">
                            <p>Text input (max ${question.answerSettings.maxLength} characters)</p>
                            <p class="text-sm text-gray-500">Accepted answers: ${question.answer.join(', ')}</p>
                        </div>
                    `;
                    break;
                case 'number':
                    content += `
                        <div class="text-center">
                            <p>Number input (${question.answerSettings.min} - ${question.answerSettings.max})</p>
                            <p class="text-sm text-gray-500">Correct answer: ${question.answer}</p>
                        </div>
                    `;
                    break;
                case 'rearrange':
                    const correctOrder = question.answer.split(',').map(i => question.answerSettings.items[parseInt(i)]);
                    content += `
                        <div class="text-center">
                            <p class="mb-2">Items to arrange:</p>
                            <div class="space-y-2">
                                ${question.answerSettings.items.map(item => `<div class="p-2 border rounded">${item}</div>`).join('')}
                            </div>
                            <p class="text-sm text-gray-500 mt-4">Correct order: ${correctOrder.join(' ‚Üí ')}</p>
                        </div>
                    `;
                    break;
            }
            
            content += `</div>`;
            
            // Add player responses
            content += `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Player Responses <span id="responseCount" class="text-sm text-gray-500">(0 answered)</span></h3>
                    <div id="playerResponses" class="space-y-2">
                        <p class="text-gray-500 dark:text-gray-400 text-center">Waiting for responses...</p>
                    </div>
                </div>
            `;
            
            return content;
        }

        function startQuestionTimer(duration) {
            let timeLeft = duration;
            const timerElement = document.getElementById('timer');
            
            questionTimer = setInterval(() => {
                timeLeft--;
                if (timerElement) {
                    timerElement.textContent = formatTime(timeLeft);
                    if (timeLeft <= 10) {
                        timerElement.classList.add('text-red-500');
                    }
                }
                
                if (timeLeft <= 0) {
                    finishQuestion();
                }
            }, 1000);
        }

        function finishQuestion() {
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            
            // Mark question as finished
            database.ref(`rooms/${currentRoom}/currentQuestion/status`).set('finished');
            
            setTimeout(() => {
                showQuestionResults();
            }, 2000);
        }

        function showQuestionResults() {
            const question = currentGame.questions[currentQuestionIndex];
            const hostUI = document.getElementById('hostGameUI');
            
            hostUI.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-4">Question ${currentQuestionIndex + 1} Results</h2>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-2xl mx-auto">
                        <h3 class="text-lg font-semibold mb-4">Correct Answer</h3>
                        ${renderCorrectAnswer(question)}
                    </div>
                </div>
                
                <div class="text-center space-x-4">
                    <button onclick="nextQuestion()" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        ${currentQuestionIndex + 1 < currentGame.questions.length ? 'Next Question' : 'Show Results'}
                    </button>
                    <button onclick="endHosting()" class="px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        End Game
                    </button>
                </div>
            `;
        }

        function renderCorrectAnswer(question) {
            switch (question.answerType) {
                case 'radio':
                    return `<p class="text-lg">${question.answerSettings.options[question.answer]}</p>`;
                case 'checkbox':
                    const correctOptions = question.answer.map(i => question.answerSettings.options[i]);
                    return `<p class="text-lg">${correctOptions.join(', ')}</p>`;
                case 'text':
                    return `<p class="text-lg">${question.answer.join(' or ')}</p>`;
                case 'number':
                    return `<p class="text-lg">${question.answer}</p>`;
                case 'rearrange':
                    const correctOrder = question.answer.split(',').map(i => question.answerSettings.items[parseInt(i)]);
                    return `<p class="text-lg">${correctOrder.join(' ‚Üí ')}</p>`;
                default:
                    return `<p class="text-lg">No specific correct answer</p>`;
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentGame.questions.length) {
                showNextQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            database.ref(`rooms/${currentRoom}/gameState`).set('finished');
            showGameResults();
        }

        function showGameResults() {
            const hostUI = document.getElementById('hostGameUI');
            hostUI.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold mb-4">üèÜ Game Finished!</h2>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 max-w-2xl mx-auto">
                        <h3 class="text-xl font-semibold mb-4">Final Leaderboard</h3>
                        <div id="leaderboard" class="space-y-3">
                            <p class="text-gray-500 dark:text-gray-400">Loading results...</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="endHosting()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        Back to Games
                    </button>
                </div>
            `;
            
            // Save to history and clean up
            setTimeout(() => {
                saveGameToHistory();
                cleanupGame();
            }, 5000);
        }

        function endHosting() {
            if (currentRoom) {
                database.ref(`rooms/${currentRoom}`).remove();
            }
            cleanupGame();
            backToMainUI();
        }

        function cleanupGame() {
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            currentRoom = null;
            currentGame = null;
            currentQuestionIndex = 0;
            gameStarted = false;
            isHost = false;
        }

        function backToMainUI() {
            document.getElementById('hostGameUI').classList.add('hidden');
            document.getElementById('playerGameUI').classList.add('hidden');
            document.getElementById('mainAppUI').classList.remove('hidden');
        }

        // Player game functionality
        function joinGameAsPlayer() {
            database.ref(`rooms/${currentRoom}/players/${currentUser.id}`).set({
                name: currentUser.name,
                score: 0,
                joined: Date.now()
            });
            
            showPlayerUI();
            listenToGameState();
        }

        function showPlayerUI() {
            document.getElementById('mainAppUI').classList.add('hidden');
            document.getElementById('playerGameUI').classList.remove('hidden');
            
            const playerUI = document.getElementById('playerGameUI');
            playerUI.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-4">Welcome, ${currentUser.name}!</h2>
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <p class="text-lg mb-4">Waiting for the host to start the game...</p>
                        <div class="animate-pulse">
                            <div class="w-16 h-16 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto"></div>
                        </div>
                    </div>
                    
                    <button onclick="leaveGame()" class="mt-6 px-6 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        Leave Game
                    </button>
                </div>
            `;
        }

        function listenToGameState() {
            database.ref(`rooms/${currentRoom}/gameState`).on('value', (snapshot) => {
                const gameState = snapshot.val();
                if (gameState === 'playing') {
                    listenToCurrentQuestion();
                } else if (gameState === 'finished') {
                    showPlayerGameResults();
                }
            });
            
            // Listen for host disconnect
            database.ref(`rooms/${currentRoom}`).on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    showCustomAlert('Host has ended the game');
                    backToMainUI();
                }
            });
        }

        function listenToCurrentQuestion() {
            database.ref(`rooms/${currentRoom}/currentQuestion`).on('value', (snapshot) => {
                const questionData = snapshot.val();
                if (questionData && questionData.status === 'active') {
                    showPlayerQuestion(questionData);
                } else if (questionData && questionData.status === 'finished') {
                    showPlayerQuestionResult(questionData);
                }
            });
        }

        function showPlayerQuestion(question) {
            const playerUI = document.getElementById('playerGameUI');
            playerUI.innerHTML = `
                <div class="text-center mb-6">
                    <div class="mb-2">
                        <span class="text-sm text-gray-500">Question ${question.index + 1}</span>
                    </div>
                    <h2 class="text-xl font-bold mb-4">${question.questionContent}</h2>
                    <div class="text-lg font-semibold text-primary mb-6">
                        Points: ${question.points}
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                    ${renderPlayerAnswerInput(question)}
                </div>
                
                <div class="mt-6 text-center">
                    <button id="submitAnswer" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Submit Answer
                    </button>
                </div>
            `;
            
            document.getElementById('submitAnswer').addEventListener('click', () => submitPlayerAnswer(question));
        }

        function renderPlayerAnswerInput(question) {
            switch (question.answerType) {
                case 'radio':
                    return `
                        <div class="space-y-3">
                            ${question.answerSettings.options.map((option, index) => `
                                <label class="flex items-center p-3 border border-gray-200 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                    <input type="radio" name="answer" value="${index}" class="mr-3" onchange="validatePlayerAnswer()">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'checkbox':
                    return `
                        <div class="space-y-3">
                            ${question.answerSettings.options.map((option, index) => `
                                <label class="flex items-center p-3 border border-gray-200 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                    <input type="checkbox" name="answer" value="${index}" class="mr-3" onchange="validatePlayerAnswer()">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'range':
                    return `
                        <div class="text-center">
                            <label class="block text-sm font-medium mb-4">Select a value from ${question.answerSettings.min} to ${question.answerSettings.max}</label>
                            <input type="range" min="${question.answerSettings.min}" max="${question.answerSettings.max}" value="${Math.floor((question.answerSettings.min + question.answerSettings.max) / 2)}" class="w-full mb-4" oninput="document.getElementById('rangeValue').textContent = this.value; validatePlayerAnswer()">
                            <div class="text-xl font-semibold">
                                Value: <span id="rangeValue">${Math.floor((question.answerSettings.min + question.answerSettings.max) / 2)}</span>
                            </div>
                        </div>
                    `;
                case 'text':
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">Your answer</label>
                            <input type="text" maxlength="${question.answerSettings.maxLength}" placeholder="Type your answer..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" oninput="validatePlayerAnswer()">
                        </div>
                    `;
                case 'number':
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-2">Enter a number (${question.answerSettings.min} - ${question.answerSettings.max})</label>
                            <input type="number" min="${question.answerSettings.min}" max="${question.answerSettings.max}" placeholder="Enter number..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" oninput="validatePlayerAnswer()">
                        </div>
                    `;
                case 'rearrange':
                    setTimeout(() => setupDragAndDrop(), 100);
                    return `
                        <div>
                            <label class="block text-sm font-medium mb-4">Drag to arrange in correct order</label>
                            <div id="sortableItems" class="space-y-2">
                                ${question.answerSettings.items.map((item, index) => `
                                    <div class="p-3 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md cursor-move transition-all duration-200 hover:bg-gray-200 dark:hover:bg-gray-600" draggable="true" data-index="${index}">
                                        <span class="drag-handle mr-2">‚ãÆ‚ãÆ</span>${item}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
            }
        }

        function validatePlayerAnswer() {
            const submitBtn = document.getElementById('submitAnswer');
            let hasAnswer = false;
            
            // Check based on answer type
            const radios = document.querySelectorAll('input[type="radio"]:checked');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const textInput = document.querySelector('input[type="text"]');
            const numberInput = document.querySelector('input[type="number"]');
            const rangeInput = document.querySelector('input[type="range"]');
            
            if (radios.length > 0 || checkboxes.length > 0 || 
                (textInput && textInput.value.trim()) || 
                (numberInput && numberInput.value) || 
                rangeInput) {
                hasAnswer = true;
            }
            
            submitBtn.disabled = !hasAnswer;
        }

        function submitPlayerAnswer(question) {
            let answer = null;
            
            switch (question.answerType) {
                case 'radio':
                    const radio = document.querySelector('input[type="radio"]:checked');
                    answer = radio ? parseInt(radio.value) : null;
                    break;
                case 'checkbox':
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                    answer = Array.from(checkboxes).map(cb => parseInt(cb.value));
                    break;
                case 'range':
                    const range = document.querySelector('input[type="range"]');
                    answer = range ? parseInt(range.value) : null;
                    break;
                case 'text':
                    const text = document.querySelector('input[type="text"]');
                    answer = text ? text.value.trim().toLowerCase() : null;
                    break;
                case 'number':
                    const number = document.querySelector('input[type="number"]');
                    answer = number ? parseFloat(number.value) : null;
                    break;
                case 'rearrange':
                    // This would need more complex implementation for drag-and-drop
                    answer = '0,1,2,3'; // Placeholder
                    break;
            }
            
            if (answer !== null) {
                database.ref(`rooms/${currentRoom}/answers/${currentUser.id}`).set({
                    questionIndex: question.index,
                    answer: answer,
                    timestamp: Date.now()
                });
                
                document.getElementById('submitAnswer').disabled = true;
                document.getElementById('submitAnswer').textContent = 'Answer Submitted';
            }
        }

        function showPlayerQuestionResult(question) {
            // Calculate if answer was correct
            const isCorrect = checkAnswerCorrect(question);
            
            const playerUI = document.getElementById('playerGameUI');
            playerUI.innerHTML = `
                <div class="text-center">
                    <div class="mb-6">
                        <div class="text-6xl mb-4">${isCorrect ? '‚úÖ' : '‚ùå'}</div>
                        <h2 class="text-2xl font-bold mb-2">${isCorrect ? 'Correct!' : 'Incorrect'}</h2>
                        <p class="text-lg text-gray-600 dark:text-gray-400">
                            ${isCorrect ? `+${question.points} points` : '0 points'}
                        </p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-2">Correct Answer:</h3>
                        <p class="text-lg">${getCorrectAnswerText(question)}</p>
                    </div>
                    
                    <div class="mt-6">
                        <p class="text-lg">Waiting for next question...</p>
                    </div>
                </div>
            `;
        }

        function checkAnswerCorrect(question) {
            // This would check the player's submitted answer against the correct answer
            // For demo purposes, return random result
            return Math.random() > 0.5;
        }

        function getCorrectAnswerText(question) {
            switch (question.answerType) {
                case 'radio':
                    return question.answerSettings.options[question.answer];
                case 'checkbox':
                    return question.answer.map(i => question.answerSettings.options[i]).join(', ');
                case 'text':
                    return question.answer.join(' or ');
                case 'number':
                    return question.answer.toString();
                case 'rearrange':
                    const correctOrder = question.answer.split(',').map(i => question.answerSettings.items[parseInt(i)]);
                    return correctOrder.join(' ‚Üí ');
                default:
                    return 'No specific answer';
            }
        }

        function showPlayerGameResults() {
            const playerUI = document.getElementById('playerGameUI');
            playerUI.innerHTML = `
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-6">üèÅ Game Complete!</h2>
                    
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold mb-2">Your Final Score</h3>
                        <div class="text-4xl font-bold text-primary mb-2" id="finalScore">0</div>
                        <p class="text-lg text-gray-600 dark:text-gray-400">Rank: #<span id="finalRank">-</span></p>
                    </div>
                    
                    <button onclick="leaveGame()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        Back to Games
                    </button>
                </div>
            `;
            
            // Save to history
            setTimeout(() => {
                saveGameToHistory();
            }, 2000);
        }

        function leaveGame() {
            if (currentRoom && currentUser) {
                database.ref(`rooms/${currentRoom}/players/${currentUser.id}`).remove();
            }
            cleanupGame();
            backToMainUI();
        }

        // History functions
        function saveGameToHistory() {
            const historyEntry = {
                gameName: currentGame ? currentGame.name : 'Unknown Game',
                date: new Date().toISOString(),
                role: isHost ? 'Host' : 'Player',
                players: 0, // Would be calculated from actual game data
                score: isHost ? null : Math.floor(Math.random() * 1000), // Demo score
                id: Date.now()
            };
            
            const currentHistory = storage.history;
            currentHistory.unshift(historyEntry);
            if (currentHistory.length > 50) {
                currentHistory.splice(50);
            }
            storage.history = currentHistory;
        }

        function loadGameHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (storage.history.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <div class="text-6xl mb-4">üìä</div>
                        <h3 class="text-xl font-medium mb-2">No game history</h3>
                        <p>Your played games will appear here</p>
                    </div>
                `;
            } else {
                historyContent.innerHTML = storage.history.map(entry => `
                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold">${entry.gameName}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    ${new Date(entry.date).toLocaleDateString()} - 
                                    ${entry.role}
                                    ${entry.score !== null ? ` - Score: ${entry.score}` : ''}
                                </p>
                            </div>
                            <button onclick="deleteHistoryEntry(${entry.id})" class="text-red-500 hover:text-red-600">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function deleteHistoryEntry(id) {
            const currentHistory = storage.history.filter(entry => entry.id !== id);
            storage.history = currentHistory;
            loadGameHistory();
        }

        // Search functionality
        function handleSearch(event) {
            const query = event.target.value.toLowerCase();
            const gameCards = document.querySelectorAll('#gamesList > div');
            
            gameCards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const author = card.querySelector('p').textContent.toLowerCase();
                
                if (title.includes(query) || author.includes(query)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Drag and drop functionality for rearrange questions
        function setupDragAndDrop() {
            const sortableContainer = document.getElementById('sortableItems');
            if (!sortableContainer) return;

            let draggedElement = null;

            // Add event listeners to all draggable items
            sortableContainer.addEventListener('dragstart', function(e) {
                draggedElement = e.target.closest('[draggable="true"]');
                if (draggedElement) {
                    draggedElement.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', draggedElement.outerHTML);
                }
            });

            sortableContainer.addEventListener('dragend', function(e) {
                if (draggedElement) {
                    draggedElement.style.opacity = '';
                    draggedElement = null;
                }
                validatePlayerAnswer();
            });

            sortableContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = getDragAfterElement(sortableContainer, e.clientY);
                if (afterElement == null) {
                    sortableContainer.appendChild(draggedElement);
                } else {
                    sortableContainer.insertBefore(draggedElement, afterElement);
                }
            });

            sortableContainer.addEventListener('drop', function(e) {
                e.preventDefault();
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.opacity-50)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Update UI
        function updateUI() {
            // This function would update various UI elements based on current state
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
