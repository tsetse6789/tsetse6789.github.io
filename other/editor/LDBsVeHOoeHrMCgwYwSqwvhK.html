<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .quiz-card {
            transition: all 0.3s ease;
        }
        .quiz-card:hover {
            transform: translateY(-4px);
        }
        
        /* Comprehensive Markdown Styling */
        .markdown-content {
            line-height: 1.7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .markdown-content h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            color: #111827;
        }
        .dark .markdown-content h1 {
            color: #f9fafb;
            border-bottom-color: #374151;
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.25rem 0 0.75rem 0;
            color: #1f2937;
        }
        .dark .markdown-content h2 {
            color: #f3f4f6;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: #374151;
        }
        .dark .markdown-content h3 {
            color: #e5e7eb;
        }
        
        .markdown-content p {
            margin: 1rem 0;
            font-size: 0.95rem;
            color: #374151;
        }
        .dark .markdown-content p {
            color: #d1d5db;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
            color: #374151;
        }
        .dark .markdown-content ul,
        .dark .markdown-content ol {
            color: #d1d5db;
        }
        
        .markdown-content ul {
            list-style-type: disc;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
        }
        
        .markdown-content li {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            color: #dc2626;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
        }
        .dark .markdown-content code {
            background-color: #374151;
            color: #fca5a5;
        }
        
        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #374151;
        }
        .dark .markdown-content pre {
            background-color: #111827;
            border-color: #1f2937;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        
        .markdown-content a {
            color: #5d5cde;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #4c4bc0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #5d5cde;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6b7280;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .dark .markdown-content blockquote {
            color: #9ca3af;
            background-color: #1f2937;
        }
        
        .markdown-content > *:first-child {
            margin-top: 0;
        }
        .markdown-content > *:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Quiz Game Editor by Nut</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Create and manage interactive quiz games with multiple question types</p>
        </div>

        <!-- Toolbar -->
        <div class="mt-4 overflow-x-auto">
            <div class="flex flex-wrap gap-2 min-w-max">
                <button
                    id="newFileBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    New Quiz
                </button>
                
                <input
                    id="fileInput"
                    type="file"
                    accept=".json"
                    class="hidden"
                />
                <button
                    id="importBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Import Quiz
                </button>
                
                <button
                    id="importUrlBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="link" class="w-4 h-4"></i>
                    Import URL
                </button>
                
                <button
                    id="exportBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Export
                </button>
                
                <button
                    id="previewBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Preview
                </button>
            </div>
        </div>

        <!-- File Tabs -->
        <div id="fileTabs" class="flex gap-2 mt-4 overflow-x-auto">
            <!-- File tabs will be inserted here -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-4xl">
        <div id="mainContent">
            <!-- Content will be inserted here -->
        </div>
    </main>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-6xl w-full max-h-full overflow-hidden">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Preview</h3>
                    
                    <!-- View Toggle -->
                    <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                        <button
                            id="sourceCodeTab"
                            class="flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm"
                        >
                            <i data-lucide="code" class="w-4 h-4"></i>
                            Source JSON
                        </button>
                        <button
                            id="renderedTab"
                            class="flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                        >
                            <i data-lucide="gamepad-2" class="w-4 h-4"></i>
                            Quiz Preview
                        </button>
                    </div>
                </div>
                
                <button
                    id="closePreviewBtn"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-500 dark:text-gray-400"
                >
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="overflow-auto" style="max-height: calc(100vh - 8rem);">
                <!-- Source Code View -->
                <div id="sourceCodeView" class="p-4">
                    <pre id="previewContent" class="text-sm bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 rounded-lg overflow-auto whitespace-pre-wrap"></pre>
                </div>
                
                <!-- Rendered Preview View -->
                <div id="renderedView" class="hidden">
                    <div class="p-4">
                        <div id="renderedQuizPreview">
                            <!-- Quiz preview will be inserted here -->
                        </div>
                        
                        <!-- No Quiz Message -->
                        <div id="noQuizMessage" class="text-center py-12 hidden">
                            <i data-lucide="help-circle" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4"></i>
                            <p class="text-lg text-gray-500 dark:text-gray-400">No quiz to preview</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Add some questions to see the quiz preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Detail Modal -->
    <div id="questionDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[calc(100vh-2rem)] overflow-y-auto">
            <div class="p-4 sm:p-6">
                <!-- Modal Header -->
                <div class="flex items-start justify-between mb-4 sm:mb-6">
                    <div class="min-w-0 flex-1 mr-4">
                        <h2 id="detailModalTitle" class="text-lg sm:text-2xl font-bold text-gray-900 dark:text-white"></h2>
                        <p id="detailModalType" class="text-sm sm:text-base text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2 min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Question Details -->
                <div id="questionDetailsContent" class="space-y-6">
                    <!-- Content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rename Quiz</h3>
            </div>
            <div class="p-4">
                <input
                    id="newFileNameInput"
                    type="text"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                    placeholder="Enter new filename"
                />
            </div>
            <div class="flex gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
                <button
                    id="cancelRenameBtn"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                    Cancel
                </button>
                <button
                    id="confirmRenameBtn"
                    class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                >
                    Rename
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete Quiz</h3>
            </div>
            <div class="p-4">
                <p class="text-gray-700 dark:text-gray-300">Are you sure you want to delete this quiz? This action cannot be undone.</p>
            </div>
            <div class="flex gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
                <button
                    id="cancelDeleteBtn"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                    Cancel
                </button>
                <button
                    id="confirmDeleteBtn"
                    class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Import URL Modal -->
    <div id="importUrlModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Import from URL</h3>
            </div>
            <div class="p-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Quiz JSON File URL
                </label>
                <input
                    id="importUrlInput"
                    type="url"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                    placeholder="https://example.com/quiz.json"
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Enter the direct URL to a JSON quiz file
                </p>
            </div>
            <div class="flex gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
                <button
                    id="cancelImportUrlBtn"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                    Cancel
                </button>
                <button
                    id="confirmImportUrlBtn"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="importUrlBtnText">Import</span>
                    <i id="importUrlSpinner" class="w-4 h-4 animate-spin hidden ml-2" data-lucide="loader-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Application state
        let files = [];
        let currentFileId = null;
        let fileToDelete = null;
        let dragCounter = 0;
        let currentPreviewMode = 'source'; // 'source' or 'rendered'

        // Initialize Lucide icons
        lucide.createIcons();

        // Question types configuration
        const questionTypes = {
            'multiple choice': {
                answerType: 'radio',
                icon: 'circle-dot',
                description: 'Single choice from multiple options'
            },
            'rating': {
                answerType: 'range',
                icon: 'star',
                description: 'Rating scale with slider'
            },
            'multiple select': {
                answerType: 'checkbox',
                icon: 'check-square',
                description: 'Multiple choices from options'
            },
            'text': {
                answerType: 'text',
                icon: 'type',
                description: 'Free text input'
            },
            'number': {
                answerType: 'number',
                icon: 'hash',
                description: 'Numeric input'
            },
            'arrange': {
                answerType: 'rearrange',
                icon: 'move',
                description: 'Drag and drop to reorder items'
            }
        };

        // Get current file
        function getCurrentFile() {
            return files.find(f => f.id === currentFileId);
        }

        // Create new question
        function createNewQuestion() {
            const newQuestion = {
                id: Date.now(),
                question: '',
                questionType: 'multiple choice',
                questionContent: '',
                time: '00:30',
                points: 100,
                answerType: 'radio',
                answerSettings: {
                    options: ['Option 1', 'Option 2', 'Option 3', 'Option 4']
                },
                answer: 0,
                explanation: ''
            };

            files = files.map(file => 
                file.id === currentFileId 
                    ? { ...file, content: { ...file.content, questions: [...file.content.questions, newQuestion] }}
                    : file
            );
            renderContent();
        }

        // Update quiz metadata
        function updateQuizMeta(field, value) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? { ...file, content: { ...file.content, [field]: value }}
                    : file
            );
        }

        // Update question
        function updateQuestion(questionIndex, field, value) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            questions: file.content.questions.map((question, idx) => 
                                idx === questionIndex ? { ...question, [field]: value } : question
                            )
                        }
                    }
                    : file
            );
        }

        // Remove question
        function removeQuestion(questionIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            questions: file.content.questions.filter((_, idx) => idx !== questionIndex)
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Update question type and reset relevant fields
        function updateQuestionType(questionIndex, newType) {
            const typeConfig = questionTypes[newType];
            
            // Default settings for each type
            let defaultAnswerSettings = {};
            let defaultAnswer = null;
            
            switch (newType) {
                case 'multiple choice':
                    defaultAnswerSettings = { options: ['Option 1', 'Option 2', 'Option 3', 'Option 4'] };
                    defaultAnswer = 0;
                    break;
                case 'multiple select':
                    defaultAnswerSettings = { options: ['Option 1', 'Option 2', 'Option 3', 'Option 4'] };
                    defaultAnswer = [0, 1];
                    break;
                case 'rating':
                    defaultAnswerSettings = { min: 1, max: 10 };
                    defaultAnswer = null;
                    break;
                case 'text':
                    defaultAnswerSettings = { maxLength: 100 };
                    defaultAnswer = ['correct answer'];
                    break;
                case 'number':
                    defaultAnswerSettings = { min: 1, max: 100 };
                    defaultAnswer = 50;
                    break;
                case 'arrange':
                    defaultAnswerSettings = { items: ['Item 1', 'Item 2', 'Item 3', 'Item 4'] };
                    defaultAnswer = '1,0,2,3';
                    break;
            }

            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            questions: file.content.questions.map((question, idx) => 
                                idx === questionIndex 
                                    ? { 
                                        ...question, 
                                        questionType: newType,
                                        answerType: typeConfig.answerType,
                                        answerSettings: defaultAnswerSettings,
                                        answer: defaultAnswer
                                    }
                                    : question
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Add option for multiple choice/select questions
        function addOption(questionIndex) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            const newOptions = [...question.answerSettings.options, `Option ${question.answerSettings.options.length + 1}`];
            
            updateQuestion(questionIndex, 'answerSettings', { ...question.answerSettings, options: newOptions });
            renderContent();
        }

        // Remove option for multiple choice/select questions
        function removeOption(questionIndex, optionIndex) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            const newOptions = question.answerSettings.options.filter((_, idx) => idx !== optionIndex);
            
            // Update answer if it references removed option
            let newAnswer = question.answer;
            if (question.answerType === 'radio' && question.answer >= optionIndex) {
                newAnswer = Math.max(0, question.answer - 1);
            } else if (question.answerType === 'checkbox' && Array.isArray(question.answer)) {
                newAnswer = question.answer
                    .filter(idx => idx !== optionIndex)
                    .map(idx => idx > optionIndex ? idx - 1 : idx);
            }
            
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            questions: file.content.questions.map((q, idx) => 
                                idx === questionIndex 
                                    ? { 
                                        ...q, 
                                        answerSettings: { ...q.answerSettings, options: newOptions },
                                        answer: newAnswer
                                    }
                                    : q
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Update option text
        function updateOption(questionIndex, optionIndex, value) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            const newOptions = question.answerSettings.options.map((option, idx) => 
                idx === optionIndex ? value : option
            );
            
            updateQuestion(questionIndex, 'answerSettings', { ...question.answerSettings, options: newOptions });
        }

        // Add item for arrange questions
        function addArrangeItem(questionIndex) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            const newItems = [...question.answerSettings.items, `Item ${question.answerSettings.items.length + 1}`];
            
            updateQuestion(questionIndex, 'answerSettings', { ...question.answerSettings, items: newItems });
            renderContent();
        }

        // Remove item for arrange questions
        function removeArrangeItem(questionIndex, itemIndex) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            const newItems = question.answerSettings.items.filter((_, idx) => idx !== itemIndex);
            
            // Update answer order indices
            const currentOrder = question.answer.split(',').map(Number);
            const newOrder = currentOrder
                .filter(idx => idx !== itemIndex)
                .map(idx => idx > itemIndex ? idx - 1 : idx);
            
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            questions: file.content.questions.map((q, idx) => 
                                idx === questionIndex 
                                    ? { 
                                        ...q, 
                                        answerSettings: { ...q.answerSettings, items: newItems },
                                        answer: newOrder.join(',')
                                    }
                                    : q
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Update arrange item text
        function updateArrangeItem(questionIndex, itemIndex, value) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            const newItems = question.answerSettings.items.map((item, idx) => 
                idx === itemIndex ? value : item
            );
            
            updateQuestion(questionIndex, 'answerSettings', { ...question.answerSettings, items: newItems });
        }

        // Update multiple select answer
        function updateMultiSelectAnswer(questionIndex) {
            const checkboxes = document.querySelectorAll(`input[name="answer_${questionIndex}"]:checked`);
            const selectedValues = Array.from(checkboxes).map(cb => parseInt(cb.value));
            updateQuestion(questionIndex, 'answer', selectedValues);
        }

        // Generate JSON
        function generateJSON(file) {
            return JSON.stringify(file.content, null, 2);
        }

        // Export file
        function exportFile() {
            const currentFile = getCurrentFile();
            const json = generateJSON(currentFile);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.name.replace(/\.json$/, '') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import file from File object
        function processFile(file) {
            // Check file type
            if (!file.name.endsWith('.json')) {
                showAlert('Please select a valid JSON file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = JSON.parse(e.target.result);
                    
                    // Validate quiz structure
                    if (!content.name || !Array.isArray(content.questions)) {
                        throw new Error('Invalid quiz format');
                    }

                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: content
                    };
                    files = [...files, newFile];
                    currentFileId = newFile.id;
                    renderTabs();
                    renderContent();
                    
                    showAlert(`Successfully imported quiz "${content.name}" with ${content.questions.length} question(s)`);
                } catch (error) {
                    showAlert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Import file from input
        function importFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
            // Reset file input
            event.target.value = '';
        }

        // Process text content from URL or string
        function processTextContent(content, filename) {
            try {
                const parsedContent = JSON.parse(content);
                
                // Validate quiz structure
                if (!parsedContent.name || !Array.isArray(parsedContent.questions)) {
                    throw new Error('Invalid quiz format');
                }

                const newFile = {
                    id: Date.now().toString(),
                    name: filename,
                    content: parsedContent
                };
                files = [...files, newFile];
                currentFileId = newFile.id;
                renderTabs();
                renderContent();
                
                showAlert(`Successfully imported quiz "${parsedContent.name}" with ${parsedContent.questions.length} question(s)`);
            } catch (error) {
                showAlert('Error importing file: ' + error.message);
            }
        }

        // Import file from URL
        async function importFromUrl(url) {
            // Show loading state
            document.getElementById('importUrlBtnText').textContent = 'Importing...';
            document.getElementById('importUrlSpinner').classList.remove('hidden');
            document.getElementById('confirmImportUrlBtn').disabled = true;

            try {
                // Validate URL
                const urlObj = new URL(url);
                
                // Fetch the file
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const content = await response.text();
                
                // Generate filename from URL
                const pathname = urlObj.pathname;
                let filename = pathname.split('/').pop() || 'imported-quiz.json';
                if (!filename.endsWith('.json')) {
                    filename += '.json';
                }

                // Process the content
                processTextContent(content, filename);
                
                // Close modal
                document.getElementById('importUrlModal').classList.add('hidden');
                document.getElementById('importUrlInput').value = '';
                
            } catch (error) {
                let errorMessage = 'Failed to import from URL: ';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage += 'Network error or CORS restriction. The URL might not be accessible or the server might not allow cross-origin requests.';
                } else if (error.message.includes('Invalid URL')) {
                    errorMessage += 'Please enter a valid URL.';
                } else {
                    errorMessage += error.message;
                }
                
                showAlert(errorMessage);
            } finally {
                // Reset loading state
                document.getElementById('importUrlBtnText').textContent = 'Import';
                document.getElementById('importUrlSpinner').classList.add('hidden');
                document.getElementById('confirmImportUrlBtn').disabled = false;
            }
        }

        // Create new file
        function createNewFile() {
            const newFile = {
                id: Date.now().toString(),
                name: `quiz-${Date.now()}.json`,
                content: {
                    name: 'New Quiz',
                    author: 'Quiz Creator',
                    description: 'A new interactive quiz',
                    version: '1.0',
                    created: new Date().toISOString(),
                    settings: {
                        randomizeQuestions: true,
                        randomizeAnswers: true,
                        timeBonus: false,
                        streakBonus: false,
                        deductIncorrect: false
                    },
                    metadata: {
                        difficulty: 'medium',
                        category: 'general',
                        estimatedTime: '15 minutes',
                        tags: ['quiz', 'general knowledge']
                    },
                    questions: []
                }
            };
            files = [...files, newFile];
            currentFileId = newFile.id;
            renderTabs();
            renderContent();
        }

        // Delete file
        function deleteFile(fileId) {
            if (files.length === 1) {
                showAlert('Cannot delete the last quiz.');
                return;
            }
            
            fileToDelete = fileId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // Confirm delete
        function confirmDelete() {
            if (fileToDelete) {
                files = files.filter(f => f.id !== fileToDelete);
                if (currentFileId === fileToDelete) {
                    currentFileId = files[0].id;
                }
                fileToDelete = null;
                document.getElementById('deleteModal').classList.add('hidden');
                renderTabs();
                renderContent();
            }
        }

        // Show alert (custom implementation)
        function showAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-200 px-4 py-3 rounded-lg shadow-lg z-50 max-w-md';
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-green-500 hover:text-green-700">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(alertDiv);
            lucide.createIcons();
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Render file tabs
        function renderTabs() {
            const tabsContainer = document.getElementById('fileTabs');
            tabsContainer.innerHTML = files.map(file => `
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer whitespace-nowrap transition-colors ${
                    file.id === currentFileId 
                        ? 'bg-primary/10 text-primary border border-primary/30' 
                        : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                }" onclick="selectFile('${file.id}')">
                    <span class="text-sm">${file.name}</span>
                    ${file.id === currentFileId ? `
                        <button onclick="event.stopPropagation(); startRename()" class="p-1 hover:bg-primary/20 rounded">
                            <i data-lucide="edit-3" class="w-3 h-3"></i>
                        </button>
                    ` : ''}
                    ${files.length > 1 ? `
                        <button onclick="event.stopPropagation(); deleteFile('${file.id}')" class="p-1 hover:bg-red-100 dark:hover:bg-red-900 text-red-600 dark:text-red-400 rounded">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Select file
        function selectFile(fileId) {
            currentFileId = fileId;
            renderTabs();
            renderContent();
        }

        // Start rename
        function startRename() {
            const currentFile = getCurrentFile();
            document.getElementById('newFileNameInput').value = currentFile.name;
            document.getElementById('renameModal').classList.remove('hidden');
        }

        // Rename file
        function renameFile() {
            const newName = document.getElementById('newFileNameInput').value.trim();
            if (newName) {
                files = files.map(file => 
                    file.id === currentFileId 
                        ? { ...file, name: newName }
                        : file
                );
                document.getElementById('renameModal').classList.add('hidden');
                renderTabs();
            }
        }

        // Render main content
        function renderContent() {
            const currentFile = getCurrentFile();
            const mainContent = document.getElementById('mainContent');
            
            // Show welcome interface if no files
            if (!currentFile) {
                mainContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="mb-6">
                            <i data-lucide="gamepad-2" class="w-20 h-20 mx-auto text-gray-400 dark:text-gray-600 mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2">Welcome to Quiz Game Editor</h2>
                            <p class="text-gray-500 dark:text-gray-400 mb-8 max-w-md mx-auto">
                                Create interactive quiz games with multiple question types. Get started by creating a new quiz or importing an existing one.
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button
                                onclick="createNewFile()"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Create New Quiz
                            </button>
                            <button
                                onclick="document.getElementById('fileInput').click()"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                            >
                                <i data-lucide="download" class="w-5 h-5"></i>
                                Import Existing Quiz
                            </button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            mainContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Quiz Metadata -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quiz Information</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Quiz Name *
                                </label>
                                <input
                                    type="text"
                                    value="${currentFile.content.name || ''}"
                                    onchange="updateQuizMeta('name', this.value)"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    placeholder="My Awesome Quiz"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Author *
                                </label>
                                <input
                                    type="text"
                                    value="${currentFile.content.author || ''}"
                                    onchange="updateQuizMeta('author', this.value)"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    placeholder="Your Name"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Description
                            </label>
                            <textarea
                                onchange="updateQuizMeta('description', this.value)"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary h-24 text-base"
                                placeholder="Brief description of your quiz..."
                            >${currentFile.content.description || ''}</textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Version
                                </label>
                                <input
                                    type="text"
                                    value="${currentFile.content.version || '1.0'}"
                                    onchange="updateQuizMeta('version', this.value)"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    placeholder="1.0"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Created Date
                                </label>
                                <input
                                    type="datetime-local"
                                    value="${currentFile.content.created ? new Date(currentFile.content.created).toISOString().slice(0, 16) : ''}"
                                    onchange="updateQuizMeta('created', new Date(this.value).toISOString())"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Settings -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quiz Settings</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <input
                                    type="checkbox"
                                    ${(currentFile.content.settings?.randomizeQuestions ?? true) ? 'checked' : ''}
                                    onchange="updateQuizMeta('settings', { ...(getCurrentFile().content.settings || {}), randomizeQuestions: this.checked })"
                                    class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                                />
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">Randomize Questions</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Shuffle question order for each quiz attempt</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <input
                                    type="checkbox"
                                    ${(currentFile.content.settings?.randomizeAnswers ?? true) ? 'checked' : ''}
                                    onchange="updateQuizMeta('settings', { ...(getCurrentFile().content.settings || {}), randomizeAnswers: this.checked })"
                                    class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                                />
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">Randomize Answers</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Shuffle answer options for each question</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <input
                                    type="checkbox"
                                    ${(currentFile.content.settings?.timeBonus ?? false) ? 'checked' : ''}
                                    onchange="updateQuizMeta('settings', { ...(getCurrentFile().content.settings || {}), timeBonus: this.checked })"
                                    class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                                />
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">Time Bonus</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Award bonus points for quick answers</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <input
                                    type="checkbox"
                                    ${(currentFile.content.settings?.streakBonus ?? false) ? 'checked' : ''}
                                    onchange="updateQuizMeta('settings', { ...(getCurrentFile().content.settings || {}), streakBonus: this.checked })"
                                    class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                                />
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">Streak Bonus</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Award bonus points for consecutive correct answers</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <input
                                    type="checkbox"
                                    ${(currentFile.content.settings?.deductIncorrect ?? false) ? 'checked' : ''}
                                    onchange="updateQuizMeta('settings', { ...(getCurrentFile().content.settings || {}), deductIncorrect: this.checked })"
                                    class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                                />
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">Deduct for Incorrect</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Subtract points for wrong answers</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Quiz Metadata -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quiz Metadata</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Difficulty Level
                                </label>
                                <select
                                    onchange="updateQuizMeta('metadata', { ...(getCurrentFile().content.metadata || {}), difficulty: this.value })"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                >
                                    <option value="easy" ${(currentFile.content.metadata?.difficulty === 'easy') ? 'selected' : ''}>Easy</option>
                                    <option value="medium" ${(currentFile.content.metadata?.difficulty === 'medium') ? 'selected' : ''}>Medium</option>
                                    <option value="hard" ${(currentFile.content.metadata?.difficulty === 'hard') ? 'selected' : ''}>Hard</option>
                                    <option value="expert" ${(currentFile.content.metadata?.difficulty === 'expert') ? 'selected' : ''}>Expert</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Category
                                </label>
                                <input
                                    type="text"
                                    value="${currentFile.content.metadata?.category || 'general'}"
                                    onchange="updateQuizMeta('metadata', { ...(getCurrentFile().content.metadata || {}), category: this.value })"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    placeholder="e.g., science, history, general"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Estimated Time
                                </label>
                                <input
                                    type="text"
                                    value="${currentFile.content.metadata?.estimatedTime || '15 minutes'}"
                                    onchange="updateQuizMeta('metadata', { ...(getCurrentFile().content.metadata || {}), estimatedTime: this.value })"
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    placeholder="e.g., 15 minutes, 30 minutes"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Tags
                            </label>
                            <input
                                type="text"
                                value="${(currentFile.content.metadata?.tags || []).join(', ')}"
                                onchange="updateQuizMeta('metadata', { ...(getCurrentFile().content.metadata || {}), tags: this.value.split(',').map(tag => tag.trim()).filter(tag => tag) })"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                placeholder="quiz, general knowledge, trivia (comma-separated)"
                            />
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Separate tags with commas
                            </p>
                        </div>
                    </div>

                    <!-- Questions Section -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                Questions (${currentFile.content.questions.length})
                            </h3>
                            <button
                                onclick="createNewQuestion()"
                                class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Add Question
                            </button>
                        </div>

                        ${currentFile.content.questions.length === 0 ? `
                            <div class="text-center py-12">
                                <i data-lucide="help-circle" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4"></i>
                                <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No Questions Yet</h4>
                                <p class="text-gray-500 dark:text-gray-400 mb-6">Start building your quiz by adding your first question</p>
                                <button
                                    onclick="createNewQuestion()"
                                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                                >
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                    Add Your First Question
                                </button>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${currentFile.content.questions.map((question, questionIndex) => `
                                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:border-primary/30 transition-colors">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex items-center gap-3">
                                                <span class="flex items-center justify-center w-8 h-8 bg-primary/10 text-primary rounded-full text-sm font-semibold">
                                                    ${questionIndex + 1}
                                                </span>
                                                <div>
                                                    <h4 class="font-medium text-gray-900 dark:text-white">
                                                        ${question.questionContent || 'Untitled Question'}
                                                    </h4>
                                                    <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 mt-1">
                                                        <span class="flex items-center gap-1">
                                                            <i data-lucide="${questionTypes[question.questionType]?.icon || 'help-circle'}" class="w-3 h-3"></i>
                                                            ${question.questionType}
                                                        </span>
                                                        <span class="flex items-center gap-1">
                                                            <i data-lucide="clock" class="w-3 h-3"></i>
                                                            ${question.time}
                                                        </span>
                                                        <span class="flex items-center gap-1">
                                                            <i data-lucide="star" class="w-3 h-3"></i>
                                                            ${question.points} pts
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button
                                                    onclick="openQuestionDetailModal(${questionIndex})"
                                                    class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                                                    title="View Details"
                                                >
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </button>
                                                <button
                                                    onclick="removeQuestion(${questionIndex})"
                                                    class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                                                    title="Delete Question"
                                                >
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Question Editor -->
                                        <div class="space-y-4">
                                            <!-- Basic Question Info -->
                                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                                <div class="lg:col-span-2">
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Question Text *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value="${question.questionContent}"
                                                        onchange="updateQuestion(${questionIndex}, 'questionContent', this.value); updateQuestion(${questionIndex}, 'question', this.value)"
                                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        placeholder="What is your question?"
                                                    />
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Question Type *
                                                    </label>
                                                    <select
                                                        onchange="updateQuestionType(${questionIndex}, this.value)"
                                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                    >
                                                        ${Object.keys(questionTypes).map(type => `
                                                            <option value="${type}" ${question.questionType === type ? 'selected' : ''}>
                                                                ${type.charAt(0).toUpperCase() + type.slice(1)}
                                                            </option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Time and Points -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Time Limit (MM:SS) *
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value="${question.time}"
                                                        onchange="updateQuestion(${questionIndex}, 'time', this.value)"
                                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        placeholder="00:30"
                                                        pattern="[0-9]{2}:[0-9]{2}"
                                                    />
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Points *
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value="${question.points}"
                                                        onchange="updateQuestion(${questionIndex}, 'points', parseInt(this.value))"
                                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        min="1"
                                                        step="1"
                                                    />
                                                </div>
                                            </div>

                                            ${renderQuestionTypeSpecificEditor(question, questionIndex)}

                                            <!-- Explanation -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Explanation (Optional)
                                                </label>
                                                <textarea
                                                    onchange="updateQuestion(${questionIndex}, 'explanation', this.value)"
                                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary h-20 text-base"
                                                    placeholder="Explain the correct answer..."
                                                >${question.explanation || ''}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // Render question type specific editor
        function renderQuestionTypeSpecificEditor(question, questionIndex) {
            switch (question.questionType) {
                case 'multiple choice':
                case 'multiple select':
                    return `
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Answer Options *
                                </label>
                                <button
                                    onclick="addOption(${questionIndex})"
                                    class="flex items-center gap-1 px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
                                >
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Add Option
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${question.answerSettings.options.map((option, optionIndex) => `
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center">
                                            <input
                                                type="${question.questionType === 'multiple choice' ? 'radio' : 'checkbox'}"
                                                name="answer_${questionIndex}"
                                                value="${optionIndex}"
                                                ${question.questionType === 'multiple choice' 
                                                    ? (question.answer === optionIndex ? 'checked' : '')
                                                    : (Array.isArray(question.answer) && question.answer.includes(optionIndex) ? 'checked' : '')
                                                }
                                                onchange="${question.questionType === 'multiple choice' 
                                                    ? `updateQuestion(${questionIndex}, 'answer', parseInt(this.value))` 
                                                    : `updateMultiSelectAnswer(${questionIndex})`
                                                }"
                                                class="mr-2"
                                            />
                                        </div>
                                        <input
                                            type="text"
                                            value="${option}"
                                            onchange="updateOption(${questionIndex}, ${optionIndex}, this.value)"
                                            class="flex-1 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        />
                                        ${question.answerSettings.options.length > 2 ? `
                                            <button
                                                onclick="removeOption(${questionIndex}, ${optionIndex})"
                                                class="p-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                            >
                                                <i data-lucide="x" class="w-3 h-3"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                ${question.questionType === 'multiple choice' 
                                    ? 'Select the correct answer' 
                                    : 'Select all correct answers'
                                }
                            </p>
                        </div>
                    `;

                case 'rating':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Rating Range *
                            </label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <input
                                        type="number"
                                        value="${question.answerSettings.min}"
                                        onchange="updateQuestion(${questionIndex}, 'answerSettings', { ...getCurrentFile().content.questions[${questionIndex}].answerSettings, min: parseInt(this.value) })"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        placeholder="Min value"
                                        min="0"
                                    />
                                </div>
                                <div>
                                    <input
                                        type="number"
                                        value="${question.answerSettings.max}"
                                        onchange="updateQuestion(${questionIndex}, 'answerSettings', { ...getCurrentFile().content.questions[${questionIndex}].answerSettings, max: parseInt(this.value) })"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        placeholder="Max value"
                                        min="1"
                                    />
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                Rating questions don't have a specific correct answer
                            </p>
                        </div>
                    `;

                case 'text':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Accepted Answers *
                            </label>
                            <div class="space-y-2">
                                ${(Array.isArray(question.answer) ? question.answer : [question.answer]).map((answer, answerIndex) => `
                                    <div class="flex items-center gap-3">
                                        <input
                                            type="text"
                                            value="${answer || ''}"
                                            onchange="updateQuestion(${questionIndex}, 'answer', getCurrentFile().content.questions[${questionIndex}].answer.map((a, i) => i === ${answerIndex} ? this.value : a))"
                                            class="flex-1 p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                            placeholder="Correct answer ${answerIndex + 1}"
                                        />
                                        ${(Array.isArray(question.answer) ? question.answer : [question.answer]).length > 1 ? `
                                            <button
                                                onclick="updateQuestion(${questionIndex}, 'answer', getCurrentFile().content.questions[${questionIndex}].answer.filter((_, i) => i !== ${answerIndex}))"
                                                class="p-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                            >
                                                <i data-lucide="x" class="w-3 h-3"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-between items-center mt-3">
                                <button
                                    onclick="updateQuestion(${questionIndex}, 'answer', [...(Array.isArray(getCurrentFile().content.questions[${questionIndex}].answer) ? getCurrentFile().content.questions[${questionIndex}].answer : [getCurrentFile().content.questions[${questionIndex}].answer]), '']); renderContent()"
                                    class="flex items-center gap-1 px-3 py-1 text-sm bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors"
                                >
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Add Answer
                                </button>
                                <div>
                                    <label class="text-sm text-gray-600 dark:text-gray-400 mr-2">Max Length:</label>
                                    <input
                                        type="number"
                                        value="${question.answerSettings.maxLength}"
                                        onchange="updateQuestion(${questionIndex}, 'answerSettings', { ...getCurrentFile().content.questions[${questionIndex}].answerSettings, maxLength: parseInt(this.value) })"
                                        class="w-20 p-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded text-base"
                                        min="1"
                                    />
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                Add multiple acceptable answers. Case insensitive matching.
                            </p>
                        </div>
                    `;

                case 'number':
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Number Settings *
                            </label>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Min Value</label>
                                    <input
                                        type="number"
                                        value="${question.answerSettings.min}"
                                        onchange="updateQuestion(${questionIndex}, 'answerSettings', { ...getCurrentFile().content.questions[${questionIndex}].answerSettings, min: parseInt(this.value) })"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    />
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Max Value</label>
                                    <input
                                        type="number"
                                        value="${question.answerSettings.max}"
                                        onchange="updateQuestion(${questionIndex}, 'answerSettings', { ...getCurrentFile().content.questions[${questionIndex}].answerSettings, max: parseInt(this.value) })"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                    />
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Correct Answer</label>
                                    <input
                                        type="number"
                                        value="${question.answer}"
                                        onchange="updateQuestion(${questionIndex}, 'answer', parseFloat(this.value))"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        min="${question.answerSettings.min}"
                                        max="${question.answerSettings.max}"
                                    />
                                </div>
                            </div>
                        </div>
                    `;

                case 'arrange':
                    return `
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Items to Arrange *
                                </label>
                                <button
                                    onclick="addArrangeItem(${questionIndex})"
                                    class="flex items-center gap-1 px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
                                >
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Add Item
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${question.answerSettings.items.map((item, itemIndex) => `
                                    <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <span class="text-sm text-gray-500 dark:text-gray-400 min-w-[2rem]">${itemIndex + 1}.</span>
                                        <input
                                            type="text"
                                            value="${item}"
                                            onchange="updateArrangeItem(${questionIndex}, ${itemIndex}, this.value)"
                                            class="flex-1 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        />
                                        ${question.answerSettings.items.length > 2 ? `
                                            <button
                                                onclick="removeArrangeItem(${questionIndex}, ${itemIndex})"
                                                class="p-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                            >
                                                <i data-lucide="x" class="w-3 h-3"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Correct Order (drag items to arrange)
                                </label>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        Current order: ${question.answer.split(',').map(i => question.answerSettings.items[parseInt(i)]).join('  ')}
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                        Modify the answer field to set correct order: ${question.answer}
                                    </p>
                                    <input
                                        type="text"
                                        value="${question.answer}"
                                        onchange="updateQuestion(${questionIndex}, 'answer', this.value)"
                                        class="w-full mt-2 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        placeholder="0,1,2,3"
                                    />
                                </div>
                            </div>
                        </div>
                    `;

                default:
                    return '';
            }
        }

        // Open question detail modal
        function openQuestionDetailModal(questionIndex) {
            const currentFile = getCurrentFile();
            const question = currentFile.content.questions[questionIndex];
            if (!question) return;

            document.getElementById('detailModalTitle').textContent = question.questionContent || 'Untitled Question';
            document.getElementById('detailModalType').textContent = `${question.questionType}  ${question.points} points  ${question.time}`;

            const content = document.getElementById('questionDetailsContent');
            
            let answerDisplay = '';
            switch (question.questionType) {
                case 'multiple choice':
                    answerDisplay = `<strong>Correct Answer:</strong> ${question.answerSettings.options[question.answer]}`;
                    break;
                case 'multiple select':
                    answerDisplay = `<strong>Correct Answers:</strong> ${question.answer.map(i => question.answerSettings.options[i]).join(', ')}`;
                    break;
                case 'text':
                    answerDisplay = `<strong>Accepted Answers:</strong> ${(Array.isArray(question.answer) ? question.answer : [question.answer]).join(', ')}`;
                    break;
                case 'number':
                    answerDisplay = `<strong>Correct Answer:</strong> ${question.answer}`;
                    break;
                case 'rating':
                    answerDisplay = `<strong>Range:</strong> ${question.answerSettings.min} - ${question.answerSettings.max}`;
                    break;
                case 'arrange':
                    answerDisplay = `<strong>Correct Order:</strong> ${question.answer.split(',').map(i => question.answerSettings.items[parseInt(i)]).join('  ')}`;
                    break;
            }

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold mb-2">Question Preview</h4>
                        <p class="text-gray-700 dark:text-gray-300">${question.questionContent}</p>
                    </div>
                    
                    ${question.answerSettings.options ? `
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-semibold mb-2">Options</h4>
                            <ul class="space-y-1">
                                ${question.answerSettings.options.map((option, i) => `
                                    <li class="flex items-center gap-2">
                                        <span class="w-6 h-6 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center text-xs">
                                            ${String.fromCharCode(65 + i)}
                                        </span>
                                        ${option}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${question.answerSettings.items ? `
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-semibold mb-2">Items to Arrange</h4>
                            <div class="grid grid-cols-2 gap-2">
                                ${question.answerSettings.items.map(item => `
                                    <div class="p-2 bg-white dark:bg-gray-600 rounded border">${item}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <h4 class="font-semibold mb-2">Answer</h4>
                        <p class="text-gray-700 dark:text-gray-300">${answerDisplay}</p>
                    </div>
                    
                    ${question.explanation ? `
                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <h4 class="font-semibold mb-2">Explanation</h4>
                            <p class="text-gray-700 dark:text-gray-300">${question.explanation}</p>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('questionDetailModal').classList.remove('hidden');
        }

        // Show preview
        function showPreview() {
            const currentFile = getCurrentFile();
            
            // Update source code view
            const json = generateJSON(currentFile);
            document.getElementById('previewContent').textContent = json;
            
            // Update rendered view
            renderQuizPreview(currentFile);
            
            // Show the modal
            document.getElementById('previewModal').classList.remove('hidden');
        }

        // Render quiz preview
        function renderQuizPreview(file) {
            const previewDiv = document.getElementById('renderedQuizPreview');
            const noQuizMessage = document.getElementById('noQuizMessage');
            
            if (!file || !file.content.questions || file.content.questions.length === 0) {
                previewDiv.classList.add('hidden');
                noQuizMessage.classList.remove('hidden');
                return;
            }
            
            previewDiv.classList.remove('hidden');
            noQuizMessage.classList.add('hidden');
            
            const totalPoints = file.content.questions.reduce((sum, q) => sum + (q.points || 0), 0);
            
            previewDiv.innerHTML = `
                <div class="quiz-card bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-6">
                    <!-- Quiz Header -->
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">${file.content.name}</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-1">By ${file.content.author}</p>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">${file.content.description}</p>
                        <div class="flex justify-center items-center space-x-6 text-sm text-gray-500 dark:text-gray-400">
                            <div class="flex items-center gap-2">
                                <i data-lucide="help-circle" class="w-4 h-4"></i>
                                <span>${file.content.questions.length} Questions</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="star" class="w-4 h-4"></i>
                                <span>${totalPoints} Total Points</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Questions Preview -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Questions Preview</h3>
                        ${file.content.questions.map((question, index) => `
                            <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <span class="flex items-center justify-center w-8 h-8 bg-primary text-white rounded-full text-sm font-semibold">
                                            ${index + 1}
                                        </span>
                                        <div>
                                            <h4 class="font-medium text-gray-900 dark:text-white">${question.questionContent}</h4>
                                            <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 mt-1">
                                                <span class="flex items-center gap-1">
                                                    <i data-lucide="${questionTypes[question.questionType]?.icon || 'help-circle'}" class="w-3 h-3"></i>
                                                    ${question.questionType}
                                                </span>
                                                <span class="flex items-center gap-1">
                                                    <i data-lucide="clock" class="w-3 h-3"></i>
                                                    ${question.time}
                                                </span>
                                                <span class="flex items-center gap-1">
                                                    <i data-lucide="star" class="w-3 h-3"></i>
                                                    ${question.points} pts
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${question.answerSettings.options ? `
                                    <div class="ml-11">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            ${question.answerSettings.options.map((option, optIndex) => `
                                                <div class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700 rounded text-sm">
                                                    <span class="w-5 h-5 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center text-xs">
                                                        ${String.fromCharCode(65 + optIndex)}
                                                    </span>
                                                    ${option}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${question.answerSettings.items ? `
                                    <div class="ml-11">
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Items to arrange:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${question.answerSettings.items.map(item => `
                                                <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm">${item}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${question.questionType === 'rating' ? `
                                    <div class="ml-11">
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            Rating scale: ${question.answerSettings.min} - ${question.answerSettings.max}
                                        </p>
                                    </div>
                                ` : ''}
                                
                                ${question.questionType === 'number' ? `
                                    <div class="ml-11">
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            Number range: ${question.answerSettings.min} - ${question.answerSettings.max}
                                        </p>
                                    </div>
                                ` : ''}
                                
                                ${question.questionType === 'text' ? `
                                    <div class="ml-11">
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            Text input (max ${question.answerSettings.maxLength} characters)
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        // Toggle preview mode
        function togglePreviewMode(mode) {
            currentPreviewMode = mode;
            
            const sourceTab = document.getElementById('sourceCodeTab');
            const renderedTab = document.getElementById('renderedTab');
            const sourceView = document.getElementById('sourceCodeView');
            const renderedView = document.getElementById('renderedView');
            
            if (mode === 'source') {
                // Source Code view
                sourceTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
                renderedTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white';
                sourceView.classList.remove('hidden');
                renderedView.classList.add('hidden');
            } else {
                // Rendered Preview view
                renderedTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
                sourceTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white';
                sourceView.classList.add('hidden');
                renderedView.classList.remove('hidden');
            }
        }

        // Drag and drop functionality
        function showDragOverlay() {
            if (!document.getElementById('dragOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'dragOverlay';
                overlay.className = 'fixed inset-0 bg-primary/10 border-4 border-dashed border-primary/50 flex items-center justify-center z-40';
                overlay.innerHTML = `
                    <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-primary/30">
                        <i data-lucide="upload-cloud" class="w-16 h-16 mx-auto text-primary mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Drop Quiz JSON file here</h3>
                        <p class="text-gray-600 dark:text-gray-400">Release to import the quiz</p>
                    </div>
                `;
                document.body.appendChild(overlay);
                lucide.createIcons();
            }
        }

        function hideDragOverlay() {
            const overlay = document.getElementById('dragOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Handle drag enter and leave
        document.addEventListener('dragenter', (e) => {
            dragCounter++;
            if (e.dataTransfer.items && e.dataTransfer.items.length > 0) {
                showDragOverlay();
            }
        });

        document.addEventListener('dragleave', (e) => {
            dragCounter--;
            if (dragCounter === 0) {
                hideDragOverlay();
            }
        });

        // Handle file drop
        document.addEventListener('drop', (e) => {
            dragCounter = 0;
            hideDragOverlay();
            
            const files = Array.from(e.dataTransfer.files);
            const jsonFiles = files.filter(file => file.name.endsWith('.json'));
            
            if (jsonFiles.length === 0) {
                showAlert('Please drop valid JSON files.');
                return;
            }
            
            if (jsonFiles.length > 1) {
                showAlert('Please drop one file at a time.');
                return;
            }
            
            processFile(jsonFiles[0]);
        });

        // Event listeners
        document.getElementById('newFileBtn').addEventListener('click', createNewFile);
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        document.getElementById('fileInput').addEventListener('change', importFile);
        document.getElementById('importUrlBtn').addEventListener('click', () => {
            document.getElementById('importUrlModal').classList.remove('hidden');
        });
        document.getElementById('exportBtn').addEventListener('click', exportFile);
        document.getElementById('previewBtn').addEventListener('click', showPreview);
        
        // Preview modal event listeners
        document.getElementById('closePreviewBtn').addEventListener('click', () => {
            document.getElementById('previewModal').classList.add('hidden');
        });
        document.getElementById('sourceCodeTab').addEventListener('click', () => togglePreviewMode('source'));
        document.getElementById('renderedTab').addEventListener('click', () => togglePreviewMode('rendered'));
        
        // Question detail modal event listeners
        document.getElementById('closeDetailModal').addEventListener('click', () => {
            document.getElementById('questionDetailModal').classList.add('hidden');
        });
        
        // Other modal event listeners
        document.getElementById('cancelRenameBtn').addEventListener('click', () => {
            document.getElementById('renameModal').classList.add('hidden');
        });
        document.getElementById('confirmRenameBtn').addEventListener('click', renameFile);
        document.getElementById('newFileNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') renameFile();
        });
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
            fileToDelete = null;
        });
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);

        // URL import modal event listeners
        document.getElementById('cancelImportUrlBtn').addEventListener('click', () => {
            document.getElementById('importUrlModal').classList.add('hidden');
            document.getElementById('importUrlInput').value = '';
        });
        document.getElementById('confirmImportUrlBtn').addEventListener('click', () => {
            const url = document.getElementById('importUrlInput').value.trim();
            if (url) {
                importFromUrl(url);
            }
        });
        document.getElementById('importUrlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const url = document.getElementById('importUrlInput').value.trim();
                if (url) {
                    importFromUrl(url);
                }
            }
        });

        // Close modals on outside click
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('previewModal').classList.add('hidden');
            }
        });
        document.getElementById('renameModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('renameModal').classList.add('hidden');
            }
        });
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('deleteModal').classList.add('hidden');
                fileToDelete = null;
            }
        });
        document.getElementById('importUrlModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('importUrlModal').classList.add('hidden');
                document.getElementById('importUrlInput').value = '';
            }
        });
        document.getElementById('questionDetailModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('questionDetailModal').classList.add('hidden');
            }
        });

        // Initial render
        renderTabs();
        renderContent();
    </script>
</body>
</html>
