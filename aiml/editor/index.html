<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIML Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        .app-card {
            transition: all 0.3s ease;
        }
        .app-card:hover {
            transform: translateY(-4px);
        }
        .gallery-image {
            transition: transform 0.3s ease;
        }
        .gallery-image:hover {
            transform: scale(1.05);
        }
        
        /* Comprehensive Markdown Styling */
        .markdown-content {
            line-height: 1.7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .markdown-content h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            color: #111827;
        }
        .dark .markdown-content h1 {
            color: #f9fafb;
            border-bottom-color: #374151;
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.25rem 0 0.75rem 0;
            color: #1f2937;
        }
        .dark .markdown-content h2 {
            color: #f3f4f6;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: #374151;
        }
        .dark .markdown-content h3 {
            color: #e5e7eb;
        }
        
        .markdown-content p {
            margin: 1rem 0;
            font-size: 0.95rem;
            color: #374151;
        }
        .dark .markdown-content p {
            color: #d1d5db;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
            color: #374151;
        }
        .dark .markdown-content ul,
        .dark .markdown-content ol {
            color: #d1d5db;
        }
        
        .markdown-content ul {
            list-style-type: disc;
        }
        
        .markdown-content ol {
            list-style-type: decimal;
        }
        
        .markdown-content li {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            color: #dc2626;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
        }
        .dark .markdown-content code {
            background-color: #374151;
            color: #fca5a5;
        }
        
        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #374151;
        }
        .dark .markdown-content pre {
            background-color: #111827;
            border-color: #1f2937;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        
        .markdown-content a {
            color: #5d5cde;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #4c4bc0;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #5d5cde;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6b7280;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .dark .markdown-content blockquote {
            color: #9ca3af;
            background-color: #1f2937;
        }
        
        .markdown-content > *:first-child {
            margin-top: 0;
        }
        .markdown-content > *:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">AIML Editor by Nut</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Manage your App Information Markup Language files instantly</p>
        </div>

        <!-- Toolbar -->
        <div class="mt-4 overflow-x-auto">
            <div class="flex flex-wrap gap-2 min-w-max">
                <button
                    id="newFileBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    New
                </button>
                
                <input
                    id="fileInput"
                    type="file"
                    accept=".aiml,.xml"
                    class="hidden"
                />
                <button
                    id="importBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Import File
                </button>
                
                <button
                    id="importUrlBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="link" class="w-4 h-4"></i>
                    Import URL
                </button>
                
                <button
                    id="exportBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Export
                </button>
                
                <button
                    id="previewBtn"
                    class="flex items-center gap-2 px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm transition-colors whitespace-nowrap"
                >
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Preview
                </button>
            </div>
        </div>

        <!-- File Tabs -->
        <div id="fileTabs" class="flex gap-2 mt-4 overflow-x-auto">
            <!-- File tabs will be inserted here -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-4xl">
        <div id="mainContent">
            <!-- Content will be inserted here -->
        </div>
    </main>

    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-6xl w-full max-h-full overflow-hidden">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Preview</h3>
                    
                    <!-- View Toggle -->
                    <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                        <button
                            id="sourceCodeTab"
                            class="flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm"
                        >
                            <i data-lucide="code" class="w-4 h-4"></i>
                            Source Code
                        </button>
                        <button
                            id="renderedTab"
                            class="flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                        >
                            <i data-lucide="smartphone" class="w-4 h-4"></i>
                            Rendered Preview
                        </button>
                    </div>
                </div>
                
                <button
                    id="closePreviewBtn"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-500 dark:text-gray-400"
                >
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="overflow-auto" style="max-height: calc(100vh - 8rem);">
                <!-- Source Code View -->
                <div id="sourceCodeView" class="p-4">
                    <pre id="previewContent" class="text-sm bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 rounded-lg overflow-auto whitespace-pre-wrap"></pre>
                </div>
                
                <!-- Rendered Preview View -->
                <div id="renderedView" class="hidden">
                    <!-- Apps Grid for Rendered View -->
                    <div class="p-4">
                        <div id="renderedAppsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Rendered apps will be inserted here -->
                        </div>
                        
                        <!-- No Apps Message -->
                        <div id="noAppsMessage" class="text-center py-12 hidden">
                            <i data-lucide="package" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4"></i>
                            <p class="text-lg text-gray-500 dark:text-gray-400">No apps to preview</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Add some apps to see the rendered preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Detail Modal (for rendered preview) -->
    <div id="appDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[calc(100vh-2rem)] overflow-y-auto">
            <div class="p-4 sm:p-6">
                <!-- Modal Header -->
                <div class="flex items-start justify-between mb-4 sm:mb-6">
                    <div class="flex items-center space-x-3 sm:space-x-4 min-w-0 flex-1 mr-4">
                        <img id="detailModalIcon" src="" alt="" class="w-12 h-12 sm:w-16 sm:h-16 rounded-lg object-cover flex-shrink-0">
                        <div class="min-w-0 flex-1">
                            <h2 id="detailModalTitle" class="text-lg sm:text-2xl font-bold text-gray-900 dark:text-white truncate"></h2>
                            <p id="detailModalDeveloper" class="text-sm sm:text-base text-gray-600 dark:text-gray-400 truncate"></p>
                        </div>
                    </div>
                    <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2 min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- App Details -->
                <div class="space-y-6 sm:space-y-0 sm:grid sm:grid-cols-1 lg:grid-cols-2 sm:gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4 sm:space-y-6">
                        <div>
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2">Description</h3>
                            <p id="detailModalIntro" class="text-sm sm:text-base text-gray-700 dark:text-gray-300 mb-3 sm:mb-4"></p>
                            
                            <!-- Details Drawer Toggle -->
                            <button id="detailDetailsToggle" class="flex items-center justify-between w-full p-3 text-left bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors mb-3 group">
                                <span class="font-medium text-gray-700 dark:text-gray-300">Detailed Information</span>
                                <i id="detailDetailsChevron" data-lucide="chevron-down" class="w-5 h-5 text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-transform duration-200"></i>
                            </button>
                            
                            <!-- Details Drawer Content -->
                            <div id="detailDetailsDrawer" class="hidden overflow-hidden">
                                <div id="detailModalDetails" class="markdown-content bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600"></div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2">Compatibility</h3>
                            <div id="detailModalPlatforms" class="space-y-2"></div>
                        </div>

                        <div>
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2">Download</h3>
                            <div id="detailModalDownload" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Right Column - Gallery -->
                    <div>
                        <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-2">Screenshots</h3>
                        <div id="detailModalGallery" class="flex space-x-3 overflow-x-auto pb-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageViewer" class="fixed inset-0 bg-black bg-opacity-90 z-[70] hidden flex items-center justify-center p-4 sm:p-6 md:p-8">
        <div class="relative w-full h-full flex items-center justify-center">
            <img id="viewerImage" src="" alt="" class="max-w-full max-h-full object-contain">
            <button id="closeViewer" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rename File</h3>
            </div>
            <div class="p-4">
                <input
                    id="newFileNameInput"
                    type="text"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                    placeholder="Enter new filename"
                />
            </div>
            <div class="flex gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
                <button
                    id="cancelRenameBtn"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                    Cancel
                </button>
                <button
                    id="confirmRenameBtn"
                    class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                >
                    Rename
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete File</h3>
            </div>
            <div class="p-4">
                <p class="text-gray-700 dark:text-gray-300">Are you sure you want to delete this file? This action cannot be undone.</p>
            </div>
            <div class="flex gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
                <button
                    id="cancelDeleteBtn"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                    Cancel
                </button>
                <button
                    id="confirmDeleteBtn"
                    class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                >
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Import URL Modal -->
    <div id="importUrlModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Import from URL</h3>
            </div>
            <div class="p-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    AIML File URL
                </label>
                <input
                    id="importUrlInput"
                    type="url"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                    placeholder="https://example.com/file.aiml"
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Enter the direct URL to an AIML or XML file
                </p>
            </div>
            <div class="flex gap-2 p-4 border-t border-gray-200 dark:border-gray-700">
                <button
                    id="cancelImportUrlBtn"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                    Cancel
                </button>
                <button
                    id="confirmImportUrlBtn"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="importUrlBtnText">Import</span>
                    <i id="importUrlSpinner" class="w-4 h-4 animate-spin hidden ml-2" data-lucide="loader-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Application state
        let files = [];
        let currentFileId = null;
        let fileToDelete = null;
        let dragCounter = 0;
        let currentPreviewMode = 'source'; // 'source' or 'rendered'

        // Initialize Lucide icons
        lucide.createIcons();

        // Get current file
        function getCurrentFile() {
            return files.find(f => f.id === currentFileId);
        }

        // Create new app
        function createNewApp() {
            const newApp = {
                id: Date.now(),
                appId: '',
                name: '',
                developer: '',
                category: '',
                platforms: [{
                    os: '',
                    version: '',
                    deviceType: ''
                }],
                icon: '',
                gallery: [''],
                intro: '',
                details: {
                    content: '',
                    src: '',
                    format: 'markdown'
                },
                downloads: [{
                    type: '',
                    url: '',
                    version: '',
                    size: ''
                }],
                src: ''
            };

            files = files.map(file => 
                file.id === currentFileId 
                    ? { ...file, content: { ...file.content, apps: [...file.content.apps, newApp] }}
                    : file
            );
            renderContent();
        }

        // Update app
        function updateApp(appIndex, field, value) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex ? { ...app, [field]: value } : app
                            )
                        }
                    }
                    : file
            );
        }

        // Remove app
        function removeApp(appIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.filter((_, idx) => idx !== appIndex)
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Add platform
        function addPlatform(appIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? { ...app, platforms: [...app.platforms, { os: '', version: '', deviceType: '' }] }
                                    : app
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Update platform
        function updatePlatform(appIndex, platformIndex, field, value) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? {
                                        ...app,
                                        platforms: app.platforms.map((platform, pIdx) => 
                                            pIdx === platformIndex ? { ...platform, [field]: value } : platform
                                        )
                                    }
                                    : app
                            )
                        }
                    }
                    : file
            );
        }

        // Add gallery image
        function addGalleryImage(appIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? { ...app, gallery: [...app.gallery, ''] }
                                    : app
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Update gallery image
        function updateGalleryImage(appIndex, imageIndex, value) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? {
                                        ...app,
                                        gallery: app.gallery.map((img, iIdx) => 
                                            iIdx === imageIndex ? value : img
                                        )
                                    }
                                    : app
                            )
                        }
                    }
                    : file
            );
        }

        // Add download
        function addDownload(appIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? { ...app, downloads: [...app.downloads, { type: '', url: '', version: '', size: '' }] }
                                    : app
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Update download
        function updateDownload(appIndex, downloadIndex, field, value) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? {
                                        ...app,
                                        downloads: app.downloads.map((download, dIdx) => 
                                            dIdx === downloadIndex ? { ...download, [field]: value } : download
                                        )
                                    }
                                    : app
                            )
                        }
                    }
                    : file
            );
        }

        // Generate XML
        function generateXML(file) {
            const apps = file.content.apps.map(app => {
                if (app.src) {
                    return `  <app src="${app.src}"></app>`;
                }

                const platforms = app.platforms.map(platform => `      <platform>
        <os>${platform.os}</os>
        <version>${platform.version}</version>
        <deviceType>${platform.deviceType}</deviceType>
      </platform>`).join('\n');

                const gallery = app.gallery.filter(img => img).length > 0 
                    ? `    <gallery>
${app.gallery.filter(img => img).map(img => `      <image>${img}</image>`).join('\n')}
    </gallery>` 
                    : '';

                const details = app.details.src 
                    ? `    <details src="${app.details.src}" format="${app.details.format}"></details>`
                    : `    <details>${app.details.content}</details>`;

                const downloads = app.downloads.map(download => `      <download>
        <type>${download.type}</type>
        <url>${download.url}</url>
        <version>${download.version}</version>
        <size>${download.size}</size>
      </download>`).join('\n');

                return `  <app>
    <id>${app.appId}</id>
    <name>${app.name}</name>
    <developer>${app.developer}</developer>
    <category>${app.category}</category>
    <platforms>
${platforms}
    </platforms>
    <icon>${app.icon}</icon>
${gallery}
    <intro>${app.intro}</intro>
${details}
    <downloads>
${downloads}
    </downloads>
  </app>`;
            }).join('\n\n');

            return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aiml SYSTEM "https://tsetse6789.github.io/aiml/1.2/aiml.dtd">
<aiml>
${apps}
</aiml>`;
        }

        // Export file
        function exportFile() {
            const currentFile = getCurrentFile();
            const xml = generateXML(currentFile);
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.name;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Parse XML content to JavaScript objects
        function parseXMLContent(xmlDoc) {
            const apps = [];
            const appElements = xmlDoc.getElementsByTagName('app');
            
            for (let i = 0; i < appElements.length; i++) {
                const appElement = appElements[i];
                
                // Check if it's an external app reference
                const srcAttr = appElement.getAttribute('src');
                if (srcAttr) {
                    apps.push({
                        id: Date.now() + i,
                        appId: '',
                        name: '',
                        developer: '',
                        category: '',
                        platforms: [{ os: '', version: '', deviceType: '' }],
                        icon: '',
                        gallery: [''],
                        intro: '',
                        details: { content: '', src: '', format: 'markdown' },
                        downloads: [{ type: '', url: '', version: '', size: '' }],
                        src: srcAttr
                    });
                    continue;
                }
                
                // Parse internal app structure
                const app = {
                    id: Date.now() + i,
                    appId: getElementText(appElement, 'id'),
                    name: getElementText(appElement, 'name'),
                    developer: getElementText(appElement, 'developer'),
                    category: getElementText(appElement, 'category'),
                    platforms: [],
                    icon: getElementText(appElement, 'icon'),
                    gallery: [],
                    intro: getElementText(appElement, 'intro'),
                    details: { content: '', src: '', format: 'markdown' },
                    downloads: [],
                    src: ''
                };
                
                // Parse platforms
                const platformElements = appElement.querySelectorAll('platforms > platform');
                for (let j = 0; j < platformElements.length; j++) {
                    const platform = platformElements[j];
                    app.platforms.push({
                        os: getElementText(platform, 'os'),
                        version: getElementText(platform, 'version'),
                        deviceType: getElementText(platform, 'deviceType')
                    });
                }
                if (app.platforms.length === 0) {
                    app.platforms.push({ os: '', version: '', deviceType: '' });
                }
                
                // Parse gallery images
                const imageElements = appElement.querySelectorAll('gallery > image');
                for (let j = 0; j < imageElements.length; j++) {
                    const imageText = imageElements[j].textContent.trim();
                    if (imageText) app.gallery.push(imageText);
                }
                if (app.gallery.length === 0) {
                    app.gallery.push('');
                }
                
                // Parse details
                const detailsElement = appElement.querySelector('details');
                if (detailsElement) {
                    const detailsSrc = detailsElement.getAttribute('src');
                    const detailsFormat = detailsElement.getAttribute('format') || 'markdown';
                    if (detailsSrc) {
                        app.details = { content: '', src: detailsSrc, format: detailsFormat };
                    } else {
                        app.details = { content: detailsElement.textContent.trim(), src: '', format: detailsFormat };
                    }
                }
                
                // Parse downloads
                const downloadElements = appElement.querySelectorAll('downloads > download');
                for (let j = 0; j < downloadElements.length; j++) {
                    const download = downloadElements[j];
                    app.downloads.push({
                        type: getElementText(download, 'type'),
                        url: getElementText(download, 'url'),
                        version: getElementText(download, 'version'),
                        size: getElementText(download, 'size')
                    });
                }
                if (app.downloads.length === 0) {
                    app.downloads.push({ type: '', url: '', version: '', size: '' });
                }
                
                apps.push(app);
            }
            
            return apps;
        }
        
        // Helper function to get text content from XML element
        function getElementText(parent, tagName) {
            const element = parent.querySelector(tagName);
            return element ? element.textContent.trim() : '';
        }

        // Import file from File object
        function processFile(file) {
            // Check file type
            if (!file.name.endsWith('.aiml') && !file.name.endsWith('.xml')) {
                showAlert('Please select a valid AIML or XML file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    // Try to parse XML content
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(content, 'text/xml');
                    
                    // Check if parsing was successful
                    const parseError = xmlDoc.getElementsByTagName('parsererror')[0];
                    if (parseError) {
                        throw new Error('Invalid XML format');
                    }

                    // Parse the XML content into app objects
                    const parsedApps = parseXMLContent(xmlDoc);

                    const newFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        content: { apps: parsedApps }
                    };
                    files = [...files, newFile];
                    currentFileId = newFile.id;
                    renderTabs();
                    renderContent();
                    
                    if (parsedApps.length > 0) {
                        showAlert(`Successfully imported ${parsedApps.length} app(s) from ${file.name}`);
                    }
                } catch (error) {
                    showAlert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Import file from input
        function importFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
            // Reset file input
            event.target.value = '';
        }

        // Process text content from URL or string
        function processTextContent(content, filename) {
            try {
                // Try to parse XML content
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(content, 'text/xml');
                
                // Check if parsing was successful
                const parseError = xmlDoc.getElementsByTagName('parsererror')[0];
                if (parseError) {
                    throw new Error('Invalid XML format');
                }

                // Parse the XML content into app objects
                const parsedApps = parseXMLContent(xmlDoc);

                const newFile = {
                    id: Date.now().toString(),
                    name: filename,
                    content: { apps: parsedApps }
                };
                files = [...files, newFile];
                currentFileId = newFile.id;
                renderTabs();
                renderContent();
                
                if (parsedApps.length > 0) {
                    showAlert(`Successfully imported ${parsedApps.length} app(s) from ${filename}`);
                } else {
                    showAlert(`File imported but no apps found in ${filename}`);
                }
            } catch (error) {
                showAlert('Error importing file: ' + error.message);
            }
        }

        // Import file from URL
        async function importFromUrl(url) {
            // Show loading state
            document.getElementById('importUrlBtnText').textContent = 'Importing...';
            document.getElementById('importUrlSpinner').classList.remove('hidden');
            document.getElementById('confirmImportUrlBtn').disabled = true;

            try {
                // Validate URL
                const urlObj = new URL(url);
                
                // Fetch the file
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Get the content type to validate
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('xml') && !contentType.includes('text') && !contentType.includes('application/octet-stream')) {
                    // Still try to process it, but warn the user
                    console.warn('Content type might not be XML:', contentType);
                }

                const content = await response.text();
                
                // Generate filename from URL
                const pathname = urlObj.pathname;
                let filename = pathname.split('/').pop() || 'imported-file.aiml';
                if (!filename.endsWith('.aiml') && !filename.endsWith('.xml')) {
                    filename += '.aiml';
                }

                // Process the content
                processTextContent(content, filename);
                
                // Close modal
                document.getElementById('importUrlModal').classList.add('hidden');
                document.getElementById('importUrlInput').value = '';
                
            } catch (error) {
                let errorMessage = 'Failed to import from URL: ';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage += 'Network error or CORS restriction. The URL might not be accessible or the server might not allow cross-origin requests.';
                } else if (error.message.includes('Invalid URL')) {
                    errorMessage += 'Please enter a valid URL.';
                } else {
                    errorMessage += error.message;
                }
                
                showAlert(errorMessage);
            } finally {
                // Reset loading state
                document.getElementById('importUrlBtnText').textContent = 'Import';
                document.getElementById('importUrlSpinner').classList.add('hidden');
                document.getElementById('confirmImportUrlBtn').disabled = false;
            }
        }

        // Create new file
        function createNewFile() {
            const newFile = {
                id: Date.now().toString(),
                name: `new-file-${Date.now()}.aiml`,
                content: { apps: [] }
            };
            files = [...files, newFile];
            currentFileId = newFile.id;
            renderTabs();
            renderContent();
        }

        // Delete file
        function deleteFile(fileId) {
            if (files.length === 1) {
                showAlert('Cannot delete the last file.');
                return;
            }
            
            fileToDelete = fileId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // Confirm delete
        function confirmDelete() {
            if (fileToDelete) {
                files = files.filter(f => f.id !== fileToDelete);
                if (currentFileId === fileToDelete) {
                    currentFileId = files[0].id;
                }
                fileToDelete = null;
                document.getElementById('deleteModal').classList.add('hidden');
                renderTabs();
                renderContent();
            }
        }

        // Show alert (custom implementation)
        function showAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg shadow-lg z-50';
            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-red-500 hover:text-red-700">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(alertDiv);
            lucide.createIcons();
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Render file tabs
        function renderTabs() {
            const tabsContainer = document.getElementById('fileTabs');
            tabsContainer.innerHTML = files.map(file => `
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer whitespace-nowrap transition-colors ${
                    file.id === currentFileId 
                        ? 'bg-primary/10 text-primary border border-primary/30' 
                        : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                }" onclick="selectFile('${file.id}')">
                    <span class="text-sm">${file.name}</span>
                    ${file.id === currentFileId ? `
                        <button onclick="event.stopPropagation(); startRename()" class="p-1 hover:bg-primary/20 rounded">
                            <i data-lucide="edit-3" class="w-3 h-3"></i>
                        </button>
                    ` : ''}
                    ${files.length > 1 ? `
                        <button onclick="event.stopPropagation(); deleteFile('${file.id}')" class="p-1 hover:bg-red-100 dark:hover:bg-red-900 text-red-600 dark:text-red-400 rounded">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Select file
        function selectFile(fileId) {
            currentFileId = fileId;
            renderTabs();
            renderContent();
        }

        // Start rename
        function startRename() {
            const currentFile = getCurrentFile();
            document.getElementById('newFileNameInput').value = currentFile.name;
            document.getElementById('renameModal').classList.remove('hidden');
        }

        // Rename file
        function renameFile() {
            const newName = document.getElementById('newFileNameInput').value.trim();
            if (newName) {
                files = files.map(file => 
                    file.id === currentFileId 
                        ? { ...file, name: newName }
                        : file
                );
                document.getElementById('renameModal').classList.add('hidden');
                renderTabs();
            }
        }

        // Remove platform
        function removePlatform(appIndex, platformIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? { ...app, platforms: app.platforms.filter((_, pIdx) => pIdx !== platformIndex) }
                                    : app
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Remove gallery image
        function removeGalleryImage(appIndex, imageIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? { ...app, gallery: app.gallery.filter((_, iIdx) => iIdx !== imageIndex) }
                                    : app
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Remove download
        function removeDownload(appIndex, downloadIndex) {
            files = files.map(file => 
                file.id === currentFileId 
                    ? {
                        ...file,
                        content: {
                            ...file.content,
                            apps: file.content.apps.map((app, idx) => 
                                idx === appIndex 
                                    ? { ...app, downloads: app.downloads.filter((_, dIdx) => dIdx !== downloadIndex) }
                                    : app
                            )
                        }
                    }
                    : file
            );
            renderContent();
        }

        // Render main content
        function renderContent() {
            const currentFile = getCurrentFile();
            const mainContent = document.getElementById('mainContent');
            
            // Show welcome interface if no files
            if (!currentFile) {
                mainContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="mb-6">
                            <i data-lucide="folder-plus" class="w-20 h-20 mx-auto text-gray-400 dark:text-gray-600 mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2">Welcome to AIML Editor</h2>
                            <p class="text-gray-500 dark:text-gray-400 mb-8 max-w-md mx-auto">
                                Create and manage your AIML app informations with ease. Get started by creating a new file or importing an existing one.
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button
                                onclick="createNewFile()"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                <i data-lucide="file-plus" class="w-5 h-5"></i>
                                Create New File
                            </button>
                            <button
                                onclick="document.getElementById('fileInput').click()"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                            >
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                Import Existing File
                            </button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            if (currentFile.content.apps.length === 0) {
                mainContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="mb-6">
                            <i data-lucide="file-text" class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4"></i>
                            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">No Apps Yet</h2>
                            <p class="text-gray-500 dark:text-gray-400 mb-6">Start building your AIML file by adding your first app</p>
                        </div>
                        <button
                            onclick="createNewApp()"
                            class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                        >
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            Add Your First App
                        </button>
                    </div>
                `;
            } else {
                mainContent.innerHTML = `
                    <div class="space-y-6">
                        ${currentFile.content.apps.map((app, appIndex) => `
                            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                                <div class="flex justify-between items-start mb-6">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                        App ${appIndex + 1}
                                    </h3>
                                    <button
                                        onclick="removeApp(${appIndex})"
                                        class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                                    >
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>

                                <div class="space-y-6">
                                    <!-- App Source URL -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            External App Source (Optional)
                                        </label>
                                        <input
                                            type="url"
                                            placeholder="https://example.com/app.aiml"
                                            value="${app.src}"
                                            onchange="updateApp(${appIndex}, 'src', this.value)"
                                            class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                        />
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            If provided, this app will reference external content instead of inline data
                                        </p>
                                    </div>

                                    ${!app.src ? `
                                        <!-- Basic Info -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    App ID *
                                                </label>
                                                <input
                                                    type="text"
                                                    placeholder="com.example.myapp"
                                                    value="${app.appId}"
                                                    onchange="updateApp(${appIndex}, 'appId', this.value)"
                                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    App Name *
                                                </label>
                                                <input
                                                    type="text"
                                                    placeholder="My Awesome App"
                                                    value="${app.name}"
                                                    onchange="updateApp(${appIndex}, 'name', this.value)"
                                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Developer *
                                                </label>
                                                <input
                                                    type="text"
                                                    placeholder="Your Company Inc."
                                                    value="${app.developer}"
                                                    onchange="updateApp(${appIndex}, 'developer', this.value)"
                                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Category *
                                                </label>
                                                <input
                                                    type="text"
                                                    placeholder="Productivity, Games, Tools..."
                                                    value="${app.category}"
                                                    onchange="updateApp(${appIndex}, 'category', this.value)"
                                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                />
                                            </div>
                                        </div>

                                        <!-- Icon -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Icon URL *
                                            </label>
                                            <input
                                                type="url"
                                                placeholder="https://example.com/icon.png"
                                                value="${app.icon}"
                                                onchange="updateApp(${appIndex}, 'icon', this.value)"
                                                class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                            />
                                        </div>

                                        <!-- Platforms -->
                                        <div>
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                    Supported Platforms *
                                                </label>
                                                <button
                                                    onclick="addPlatform(${appIndex})"
                                                    class="flex items-center gap-1 px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
                                                >
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                    Add Platform
                                                </button>
                                            </div>
                                            <div class="space-y-3">
                                                ${app.platforms.map((platform, platformIndex) => `
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg relative">
                                                        <input
                                                            type="text"
                                                            placeholder="iOS, Android, Windows..."
                                                            value="${platform.os}"
                                                            onchange="updatePlatform(${appIndex}, ${platformIndex}, 'os', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        <input
                                                            type="text"
                                                            placeholder="15+, 12+, 10..."
                                                            value="${platform.version}"
                                                            onchange="updatePlatform(${appIndex}, ${platformIndex}, 'version', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        <input
                                                            type="text"
                                                            placeholder="phone, tablet, desktop..."
                                                            value="${platform.deviceType}"
                                                            onchange="updatePlatform(${appIndex}, ${platformIndex}, 'deviceType', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        ${app.platforms.length > 1 ? `
                                                            <button
                                                                onclick="removePlatform(${appIndex}, ${platformIndex})"
                                                                class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                                                            >
                                                                <i data-lucide="x" class="w-3 h-3"></i>
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- Gallery -->
                                        <div>
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                    Gallery Images (Optional)
                                                </label>
                                                <button
                                                    onclick="addGalleryImage(${appIndex})"
                                                    class="flex items-center gap-1 px-3 py-1 text-sm bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition-colors"
                                                >
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                    Add Image
                                                </button>
                                            </div>
                                            <div class="space-y-2">
                                                ${app.gallery.map((image, imageIndex) => `
                                                    <div class="relative">
                                                        <input
                                                            type="url"
                                                            placeholder="https://example.com/screenshot.png"
                                                            value="${image}"
                                                            onchange="updateGalleryImage(${appIndex}, ${imageIndex}, this.value)"
                                                            class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base pr-12"
                                                        />
                                                        ${app.gallery.length > 1 ? `
                                                            <button
                                                                onclick="removeGalleryImage(${appIndex}, ${imageIndex})"
                                                                class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                                                            >
                                                                <i data-lucide="x" class="w-3 h-3"></i>
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- Intro -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Short Intro *
                                            </label>
                                            <input
                                                type="text"
                                                placeholder="Brief description of your app..."
                                                value="${app.intro}"
                                                onchange="updateApp(${appIndex}, 'intro', this.value)"
                                                class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                            />
                                        </div>

                                        <!-- Details -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Detailed Description *
                                            </label>
                                            <div class="mb-3">
                                                <input
                                                    type="url"
                                                    placeholder="External Markdown URL (optional)"
                                                    value="${app.details.src}"
                                                    onchange="updateApp(${appIndex}, 'details', { ...getCurrentFile().content.apps[${appIndex}].details, src: this.value })"
                                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                />
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    If provided, this will override the content below
                                                </p>
                                            </div>
                                            <textarea
                                                placeholder="## Features&#10;- Feature 1&#10;- Feature 2&#10;&#10;Visit [website](https://example.com) for more info."
                                                onchange="updateApp(${appIndex}, 'details', { ...getCurrentFile().content.apps[${appIndex}].details, content: this.value })"
                                                class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary focus:border-primary h-32 text-base"
                                                ${app.details.src ? 'disabled' : ''}
                                            >${app.details.content}</textarea>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                Supports Markdown formatting
                                            </p>
                                        </div>

                                        <!-- Downloads -->
                                        <div>
                                            <div class="flex justify-between items-center mb-3">
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                    Download Links *
                                                </label>
                                                <button
                                                    onclick="addDownload(${appIndex})"
                                                    class="flex items-center gap-1 px-3 py-1 text-sm bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors"
                                                >
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                    Add Download
                                                </button>
                                            </div>
                                            <div class="space-y-3">
                                                ${app.downloads.map((download, downloadIndex) => `
                                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg relative">
                                                        <input
                                                            type="text"
                                                            placeholder="Google Play, App Store, apk, ipa, exe..."
                                                            value="${download.type}"
                                                            onchange="updateDownload(${appIndex}, ${downloadIndex}, 'type', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        <input
                                                            type="url"
                                                            placeholder="Download URL"
                                                            value="${download.url}"
                                                            onchange="updateDownload(${appIndex}, ${downloadIndex}, 'url', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        <input
                                                            type="text"
                                                            placeholder="1.0.0"
                                                            value="${download.version}"
                                                            onchange="updateDownload(${appIndex}, ${downloadIndex}, 'version', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        <input
                                                            type="text"
                                                            placeholder="45 MB"
                                                            value="${download.size}"
                                                            onchange="updateDownload(${appIndex}, ${downloadIndex}, 'size', this.value)"
                                                            class="p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded focus:ring-2 focus:ring-primary focus:border-primary text-base"
                                                        />
                                                        ${app.downloads.length > 1 ? `
                                                            <button
                                                                onclick="removeDownload(${appIndex}, ${downloadIndex})"
                                                                class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                                                            >
                                                                <i data-lucide="x" class="w-3 h-3"></i>
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}

                        <div class="text-center">
                            <button
                                onclick="createNewApp()"
                                class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Add Another App
                            </button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // Show preview
        function showPreview() {
            const currentFile = getCurrentFile();
            
            // Update source code view
            const xml = generateXML(currentFile);
            document.getElementById('previewContent').textContent = xml;
            
            // Update rendered view
            renderPreviewApps(currentFile);
            
            // Show the modal
            document.getElementById('previewModal').classList.remove('hidden');
        }

        // Render apps in preview modal
        function renderPreviewApps(file) {
            const appsGrid = document.getElementById('renderedAppsGrid');
            const noAppsMessage = document.getElementById('noAppsMessage');
            
            if (!file || file.content.apps.length === 0) {
                appsGrid.classList.add('hidden');
                noAppsMessage.classList.remove('hidden');
                return;
            }
            
            appsGrid.classList.remove('hidden');
            noAppsMessage.classList.add('hidden');
            
            // Filter out apps with external sources and apps with missing required fields
            const validApps = file.content.apps.filter(app => 
                !app.src && app.name && app.developer && app.category
            );
            
            appsGrid.innerHTML = validApps.map(app => `
                <div class="app-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg border border-gray-200 dark:border-gray-700 p-4 cursor-pointer" onclick="openAppDetailModal('${app.id}')">
                    <div class="flex items-center space-x-3 mb-3">
                        <img src="${app.icon || 'https://via.placeholder.com/48x48/5D5CDE/ffffff?text=APP'}" alt="${app.name}" class="w-12 h-12 rounded-lg object-cover">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-lg text-gray-900 dark:text-white truncate">${app.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${app.developer}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">${app.intro}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white px-2 py-1 rounded">${app.category}</span>
                        <div class="flex space-x-1">
                            ${app.platforms.slice(0, 3).map(platform => `
                                <span class="text-xs bg-primary text-white px-2 py-1 rounded">${platform.os}</span>
                            `).join('')}
                            ${app.platforms.length > 3 ? '<span class="text-xs text-gray-500">+' + (app.platforms.length - 3) + '</span>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            if (validApps.length === 0) {
                appsGrid.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-yellow-500 mb-3"></i>
                        <p class="text-gray-600 dark:text-gray-400">No valid apps to preview</p>
                        <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">Apps need at least a name, developer, and category to be displayed</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // Open app detail modal
        async function openAppDetailModal(appId) {
            const currentFile = getCurrentFile();
            const app = currentFile.content.apps.find(a => a.id.toString() === appId.toString());
            if (!app) return;
            
            document.getElementById('detailModalIcon').src = app.icon || 'https://via.placeholder.com/64x64/5D5CDE/ffffff?text=APP';
            document.getElementById('detailModalTitle').textContent = app.name;
            document.getElementById('detailModalDeveloper').textContent = app.developer;
            document.getElementById('detailModalIntro').textContent = app.intro;
            
            // Handle details
            const detailsDiv = document.getElementById('detailModalDetails');
            if (app.details && app.details.src && (app.details.src.startsWith('http://') || app.details.src.startsWith('https://'))) {
                detailsDiv.innerHTML = '<div class="flex items-center space-x-2 text-gray-500"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Loading details...</span></div>';
                lucide.createIcons();
                
                try {
                    const response = await fetch(app.details.src);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const markdownContent = await response.text();
                    detailsDiv.innerHTML = marked.parse(markdownContent);
                } catch (error) {
                    console.error('Failed to fetch app details:', error);
                    detailsDiv.innerHTML = '<div class="text-red-500 dark:text-red-400"><i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>Failed to load details. Please try again later.</div>';
                    lucide.createIcons();
                }
            } else {
                const content = app.details && app.details.content ? app.details.content : 'No details available.';
                detailsDiv.innerHTML = marked.parse(content);
            }

            // Platforms
            const platformsDiv = document.getElementById('detailModalPlatforms');
            platformsDiv.innerHTML = app.platforms.map(platform => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div>
                        <span class="font-medium text-gray-900 dark:text-white">${platform.os}</span>
                        ${platform.version ? `<span class="text-sm text-gray-600 dark:text-gray-400 ml-2">${platform.version}</span>` : ''}
                        ${platform.deviceType ? `<span class="text-sm text-gray-600 dark:text-gray-400 ml-2">(${platform.deviceType})</span>` : ''}
                    </div>
                </div>
            `).join('');

            // Download
            const downloadDiv = document.getElementById('detailModalDownload');
            downloadDiv.innerHTML = app.downloads.map(download => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div>
                        <span class="font-medium text-gray-900 dark:text-white">${download.type}</span>
                        ${download.version ? `<span class="text-sm text-gray-600 dark:text-gray-400 ml-2">v${download.version}</span>` : ''}
                        ${download.size ? `<span class="text-sm text-gray-600 dark:text-gray-400 ml-2">(${download.size})</span>` : ''}
                    </div>
                    <a href="${download.url}" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors" target="_blank">
                        <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>Download
                    </a>
                </div>
            `).join('');

            // Gallery
            const galleryDiv = document.getElementById('detailModalGallery');
            const galleryImages = app.gallery.filter(img => img);
            if (galleryImages.length > 0) {
                galleryDiv.innerHTML = galleryImages.map(image => `
                    <img src="${image}" alt="Screenshot" class="gallery-image flex-shrink-0 w-48 rounded-lg cursor-pointer" onclick="openImageViewer('${image}')">
                `).join('');
            } else {
                galleryDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No screenshots available</p>';
            }
            
            lucide.createIcons();
            document.getElementById('appDetailModal').classList.remove('hidden');
        }

        // Toggle preview mode
        function togglePreviewMode(mode) {
            currentPreviewMode = mode;
            
            const sourceTab = document.getElementById('sourceCodeTab');
            const renderedTab = document.getElementById('renderedTab');
            const sourceView = document.getElementById('sourceCodeView');
            const renderedView = document.getElementById('renderedView');
            
            if (mode === 'source') {
                // Source Code view
                sourceTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
                renderedTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white';
                sourceView.classList.remove('hidden');
                renderedView.classList.add('hidden');
            } else {
                // Rendered Preview view
                renderedTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm';
                sourceTab.className = 'flex items-center gap-2 px-3 py-1 text-sm rounded-md transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white';
                sourceView.classList.add('hidden');
                renderedView.classList.remove('hidden');
            }
        }

        // Open image viewer
        function openImageViewer(imageSrc) {
            document.getElementById('viewerImage').src = imageSrc;
            document.getElementById('imageViewer').classList.remove('hidden');
        }

        // Close image viewer
        function closeImageViewer() {
            document.getElementById('imageViewer').classList.add('hidden');
        }

        // Toggle details drawer
        function toggleDetailsDrawer() {
            const drawer = document.getElementById('detailDetailsDrawer');
            const chevron = document.getElementById('detailDetailsChevron');
            
            if (drawer.classList.contains('hidden')) {
                drawer.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                drawer.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Drag and drop functionality
        function showDragOverlay() {
            if (!document.getElementById('dragOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'dragOverlay';
                overlay.className = 'fixed inset-0 bg-primary/10 border-4 border-dashed border-primary/50 flex items-center justify-center z-40';
                overlay.innerHTML = `
                    <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-primary/30">
                        <i data-lucide="upload-cloud" class="w-16 h-16 mx-auto text-primary mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">Drop AIML file here</h3>
                        <p class="text-gray-600 dark:text-gray-400">Release to import the file</p>
                    </div>
                `;
                document.body.appendChild(overlay);
                lucide.createIcons();
            }
        }

        function hideDragOverlay() {
            const overlay = document.getElementById('dragOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        // Handle drag enter and leave
        document.addEventListener('dragenter', (e) => {
            dragCounter++;
            if (e.dataTransfer.items && e.dataTransfer.items.length > 0) {
                showDragOverlay();
            }
        });

        document.addEventListener('dragleave', (e) => {
            dragCounter--;
            if (dragCounter === 0) {
                hideDragOverlay();
            }
        });

        // Handle file drop
        document.addEventListener('drop', (e) => {
            dragCounter = 0;
            hideDragOverlay();
            
            const files = Array.from(e.dataTransfer.files);
            const aimlFiles = files.filter(file => 
                file.name.endsWith('.aiml') || file.name.endsWith('.xml')
            );
            
            if (aimlFiles.length === 0) {
                showAlert('Please drop valid AIML or XML files.');
                return;
            }
            
            if (aimlFiles.length > 1) {
                showAlert('Please drop one file at a time.');
                return;
            }
            
            processFile(aimlFiles[0]);
        });

        // Event listeners
        document.getElementById('newFileBtn').addEventListener('click', createNewFile);
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        document.getElementById('fileInput').addEventListener('change', importFile);
        document.getElementById('importUrlBtn').addEventListener('click', () => {
            document.getElementById('importUrlModal').classList.remove('hidden');
        });
        document.getElementById('exportBtn').addEventListener('click', exportFile);
        document.getElementById('previewBtn').addEventListener('click', showPreview);
        
        // Preview modal event listeners
        document.getElementById('closePreviewBtn').addEventListener('click', () => {
            document.getElementById('previewModal').classList.add('hidden');
        });
        document.getElementById('sourceCodeTab').addEventListener('click', () => togglePreviewMode('source'));
        document.getElementById('renderedTab').addEventListener('click', () => togglePreviewMode('rendered'));
        
        // App detail modal event listeners
        document.getElementById('closeDetailModal').addEventListener('click', () => {
            document.getElementById('appDetailModal').classList.add('hidden');
        });
        document.getElementById('detailDetailsToggle').addEventListener('click', toggleDetailsDrawer);
        
        // Image viewer event listeners
        document.getElementById('closeViewer').addEventListener('click', closeImageViewer);
        document.getElementById('imageViewer').addEventListener('click', function(e) {
            if (e.target === this) closeImageViewer();
        });
        
        // Other modal event listeners
        document.getElementById('cancelRenameBtn').addEventListener('click', () => {
            document.getElementById('renameModal').classList.add('hidden');
        });
        document.getElementById('confirmRenameBtn').addEventListener('click', renameFile);
        document.getElementById('newFileNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') renameFile();
        });
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.add('hidden');
            fileToDelete = null;
        });
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);

        // URL import modal event listeners
        document.getElementById('cancelImportUrlBtn').addEventListener('click', () => {
            document.getElementById('importUrlModal').classList.add('hidden');
            document.getElementById('importUrlInput').value = '';
        });
        document.getElementById('confirmImportUrlBtn').addEventListener('click', () => {
            const url = document.getElementById('importUrlInput').value.trim();
            if (url) {
                importFromUrl(url);
            }
        });
        document.getElementById('importUrlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const url = document.getElementById('importUrlInput').value.trim();
                if (url) {
                    importFromUrl(url);
                }
            }
        });

        // Close modals on outside click
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('previewModal').classList.add('hidden');
            }
        });
        document.getElementById('renameModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('renameModal').classList.add('hidden');
            }
        });
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('deleteModal').classList.add('hidden');
                fileToDelete = null;
            }
        });
        document.getElementById('importUrlModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('importUrlModal').classList.add('hidden');
                document.getElementById('importUrlInput').value = '';
            }
        });
        document.getElementById('appDetailModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('appDetailModal').classList.add('hidden');
            }
        });

        // Initial render
        renderTabs();
        renderContent();
    </script>
</body>
</html>
